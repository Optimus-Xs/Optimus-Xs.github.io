---
layout: post
title: React18 çš„ useEffect ä¼šæ‰§è¡Œä¸¤æ¬¡çš„ Feature
date: 2023-09-17 22:28 +0800
categories: [Software Development]
tags: [React]
---

## èƒŒæ™¯æè¿°

å‰æ®µæ—¶é—´åœ¨ä¸€ä¸ª React é¡¹ç›®ä¸­ï¼Œåœ¨ç¼–ç çš„è¿‡ç¨‹ä¸­é‡åˆ°ä¸€ä¸ªå¾ˆå¥‡æ€ªçš„â€œBugâ€ã€‚ å…¶ä¸­ç®€åŒ–ç‰ˆçš„ä»£ç å¦‚ä¸‹æ‰€ç¤ºã€‚

```jsx
// å…¥å£æ–‡ä»¶
import { StrictMode } from 'react';
import * as ReactDOMClient from 'react-dom/client';
import App from './App';
const root = ReactDOMClient.createRoot(document.getElementById('root'));
root.render(
  <StrictMode>
    <App />
  </StrictMode>
);
```


```jsx
// ç»„ä»¶ä»£ç 
import React, { useEffect } from 'react';

const App = () => {
  useEffect(() => {
    console.log('Hello world!');
  }, []);
  return <>Hello world!</>;
};
```

å°±è¿™æ ·å‡ è¡Œç®€å•çš„ç»„ä»¶ç«Ÿç„¶ä¼šè§¦å‘ä¸€ä¸ªâ€œBugâ€, è¡¨ç°ä¸ºåœ¨ Chrome æ§åˆ¶å°é‡Œå‘ç° â€œHello world!â€ è¢«æ‰“å°äº†ä¸¤æ¬¡ã€‚

## React18 useEffect æ–°ç‰¹æ€§

è¿™é‡Œçœ‹åˆ°çš„ `console.log` æ‰§è¡Œä¸¤æ¬¡æ˜¯ React 18 åœ¨ å¼€å‘æ¨¡å¼ (Development Mode) ä¸‹çš„ `<StrictMode>` (ä¸¥æ ¼æ¨¡å¼) çš„ä¸€ä¸ªFeatureï¼Œå¹¶ä¸æ˜¯ Bugã€‚

**æ¨¡æ‹Ÿç»„ä»¶çš„æŒ‚è½½-å¸è½½-é‡æ–°æŒ‚è½½**ï¼š åœ¨ç»„ä»¶é¦–æ¬¡æŒ‚è½½æ—¶ï¼Œä¸¥æ ¼æ¨¡å¼ä¼šè¿›è¡Œé¢å¤–çš„â€œè®¾ç½® + æ¸…ç†â€å‘¨æœŸï¼ˆsetup + cleanup cycleï¼‰ã€‚å®ƒä¼šæ¨¡æ‹Ÿç»„ä»¶ï¼š

- é¦–æ¬¡æŒ‚è½½å¹¶æ‰§è¡Œ Effect çš„ `Setup` å‡½æ•°ï¼ˆå³ä½ çš„ `useEffect` ä¸­çš„å›è°ƒå‡½æ•°ï¼‰ã€‚
- ç«‹å³æ‰§è¡Œ Effect çš„ `Cleanup` å‡½æ•°ï¼ˆè™½ç„¶ä½ çš„ä¾‹å­ä¸­æ²¡æœ‰ï¼Œä½†å¦‚æœ Effect æœ‰è¿”å›å‡½æ•°å°±ä¼šæ‰§è¡Œï¼‰ã€‚
- ç¬¬äºŒæ¬¡æŒ‚è½½ å¹¶å†æ¬¡æ‰§è¡Œ Effect çš„ `Setup` å‡½æ•°ã€‚

**éªŒè¯ Effect çš„å¥å£®æ€§** React æ•…æ„è¿™æ ·åšæ˜¯ä¸ºäº†å‹åŠ›æµ‹è¯• (stress-test) ä½ çš„ Effect ä»£ç ï¼Œç¡®ä¿å®ƒåœ¨ç»„ä»¶è¢«æ„å¤–å¸è½½å’Œé‡æ–°æŒ‚è½½æ—¶ï¼ˆä¾‹å¦‚ï¼Œæœªæ¥çš„ React å¯èƒ½ä¼šè‡ªåŠ¨æ‰§è¡Œè¿™ç§æ“ä½œæ¥ä¿æŒçŠ¶æ€æˆ–åœ¨ UI éƒ¨åˆ†ä¹‹é—´åˆ‡æ¢ï¼‰èƒ½å¤Ÿæ­£ç¡®åœ°å·¥ä½œã€‚

å¦‚æœä½ çš„ Effect ç¼ºå°‘ æ¸…ç†å‡½æ•° (`cleanup function`)ï¼Œå¹¶ä¸”åœ¨ç¬¬äºŒæ¬¡æ‰§è¡Œæ—¶å¯¼è‡´äº†æ„æ–™ä¹‹å¤–çš„ç»“æœï¼ˆæ¯”å¦‚é‡å¤çš„ API è°ƒç”¨ã€åŒé‡è®¢é˜…ã€å†…å­˜æ³„æ¼ï¼‰ï¼Œé‚£ä¹ˆè¿™ä¸ªåŒé‡æ‰§è¡Œçš„è¡Œä¸ºå°±ä¼šå¸®åŠ©ä½ å‘ç°è¿™ä¸ªé”™è¯¯ã€‚

> `useEffect` æ˜¯ React æä¾›çš„ä¸€ä¸ª Hookï¼Œå®ƒå…è®¸ä½ åœ¨å‡½æ•°ç»„ä»¶ä¸­æ‰§è¡Œ å‰¯ä½œç”¨ (side effects)ã€‚
> 
> å‰¯ä½œç”¨ æ˜¯æŒ‡é‚£äº›åœ¨ React æ¸²æŸ“è¿‡ç¨‹ä¹‹å¤–å‘ç”Ÿçš„æ“ä½œï¼Œä¾‹å¦‚ï¼š
> 
> - æ•°æ®è·å– (Data Fetching): ä» API è¯·æ±‚æ•°æ®ã€‚
> - è®¢é˜… (Subscriptions): æ¯”å¦‚ WebSocket è¿æ¥æˆ– Redux å­˜å‚¨ç›‘å¬ã€‚
> - æ‰‹åŠ¨æ›´æ”¹ DOM: ä¾‹å¦‚è®¾ç½®æ–‡æ¡£æ ‡é¢˜ (`document.title`) æˆ–ä½¿ç”¨åŸç”Ÿ DOM APIã€‚
> - å®šæ—¶å™¨ (Timers): å¦‚ `setTimeout` æˆ– `setInterval`ã€‚
>
> `useEffect` æ¥æ”¶ä¸¤ä¸ªå‚æ•°ï¼š
> 
> - Setup å‡½æ•° (Effect Callback): åŒ…å«å‰¯ä½œç”¨é€»è¾‘çš„å‡½æ•°ã€‚
> - ä¾èµ–æ•°ç»„ (Dependency Array): ä¸€ä¸ªå¯é€‰çš„æ•°ç»„ï¼ŒåŒ…å« Effect æ‰€ä¾èµ–çš„å˜é‡ã€‚
>
> ```jsx
> useEffect(() => {
>   // è¿™æ˜¯ Setup å‡½æ•°ï¼ŒåŒ…å«å‰¯ä½œç”¨é€»è¾‘
>   console.log('å‰¯ä½œç”¨æ‰§è¡Œäº†');
> 
>   // ã€å¯é€‰ã€‘è¿”å›æ¸…ç†å‡½æ•° (Cleanup function)
>   return () => {
>     console.log('æ¸…ç†å‡½æ•°æ‰§è¡Œäº†');
>   };
> }, [/* ä¾èµ–æ•°ç»„ */]); // ğŸ‘ˆ æ§åˆ¶å‰¯ä½œç”¨ä½•æ—¶é‡æ–°æ‰§è¡Œ
> ```
>
> | ä¾èµ–æ•°ç»„çŠ¶æ€        | æ‰§è¡Œæ—¶æœº (Setup å‡½æ•°)                                    | è¡Œä¸ºç±»æ¯” (Class Component)                    |
> | :------------------ | :------------------------------------------------------- | :-------------------------------------------- |
> | [] (ç©ºæ•°ç»„)         | ä»…åœ¨ç»„ä»¶é¦–æ¬¡æŒ‚è½½ (`mount`) æ—¶æ‰§è¡Œä¸€æ¬¡ã€‚                    | `componentDidMount`                             |
> | æœªä¼ å…¥ (çœç•¥)       | åœ¨ç»„ä»¶é¦–æ¬¡æŒ‚è½½å’Œæ¯æ¬¡æ›´æ–° (`update`) åéƒ½æ‰§è¡Œã€‚             | `componentDidMount` + `componentDidUpdate`        |
> | "[a, b] (æœ‰ä¾èµ–é¡¹)" | é¦–æ¬¡æŒ‚è½½æ—¶æ‰§è¡Œï¼›ä»¥åŠå½“ä¾èµ–é¡¹ a æˆ– b å‘ç”Ÿå˜åŒ–æ—¶é‡æ–°æ‰§è¡Œã€‚ | `componentDidMount` + æ¡ä»¶æ€§ `componentDidUpdate` |
{: .prompt-info }

åœ¨æˆ‘ä»¬è¿™ä¸ªæ¡ˆä¾‹ä¸­:
```jsx
const App = () => {
  useEffect(() => {
    console.log('ç»„ä»¶æŒ‚è½½å®Œæˆï¼'); // è¿™ä¸€è¡Œè¢«æ‰§è¡Œäº†ä¸¤æ¬¡
  }, []); // ä¾èµ–æ•°ç»„ä¸ºç©ºï¼Œæ¨¡æ‹Ÿ componentDidMount
  return <>Hello world!</>;
};
```

- ç¬¬ä¸€æ¬¡æ‰§è¡Œï¼š æ¨¡æ‹ŸæŒ‚è½½ -> console.log('ç»„ä»¶æŒ‚è½½å®Œæˆï¼')
- æ¨¡æ‹Ÿå¸è½½ï¼ˆæœªæ‰§è¡Œ cleanupï¼‰ï¼š ä½ çš„ useEffect æ²¡æœ‰è¿”å› cleanup å‡½æ•°ã€‚
- ç¬¬äºŒæ¬¡æ‰§è¡Œï¼š å®é™…æŒ‚è½½ -> console.log('ç»„ä»¶æŒ‚è½½å®Œæˆï¼')

> ä¸ºä»€ä¹ˆ useEffect éœ€è¦æ¸…ç†å‡½æ•°ï¼Ÿ
>
> `useEffect` è¿”å›çš„å‡½æ•°å°±æ˜¯ æ¸…ç†å‡½æ•° (Cleanup Function)ã€‚å®ƒçš„ä¸»è¦ä½œç”¨æ˜¯æ’¤é”€ (undo) æˆ– åœæ­¢ (stop) ç”± Setup å‡½æ•°å¯åŠ¨çš„Effectï¼Œä»è€Œé˜²æ­¢èµ„æºæ³„æ¼å’Œä¸ä¸€è‡´çš„è¡Œä¸ºã€‚
>
> 1. å†…å­˜æ³„æ¼ (Memory Leaks): å¦‚æœæ²¡æœ‰æ¸…ç†å‡½æ•°ï¼ŒæŸäº›å‰¯ä½œç”¨ä¼šä¸€ç›´è¿è¡Œï¼Œå³ä½¿ç»„ä»¶å·²ç»è¢«å¸è½½, ä¾‹å¦‚: è®¾ç½®äº†ä¸€ä¸ª `setInterval` ä½†æ²¡æœ‰æ¸…é™¤å®ƒï¼Œå®ƒä¼šä¸€ç›´è§¦å‘
> 2. é¿å…ç«æ€æ¡ä»¶ (Race Conditions) å’Œä¸ä¸€è‡´æ€§: å½“ç»„ä»¶å› ä¸ºä¾èµ–é¡¹å˜åŒ–è€Œé‡æ–°æ¸²æŸ“æ—¶ï¼ŒEffect ä¼šé‡æ–°æ‰§è¡Œã€‚æ¸…ç†å‡½æ•°ç¡®ä¿åœ¨æ–°çš„Effectè¿è¡Œä¹‹å‰ï¼Œä¸Šä¸€æ¬¡çš„Effectå·²è¢«å¦¥å–„å¤„ç†ã€‚å‡è®¾æœ‰ä¸€ä¸ª Effect ä¾èµ–äºä¸€ä¸ª `prop id`ã€‚å½“ id ä» `1` å˜ä¸º `2` æ—¶ï¼Œæ—§çš„ Effect ä¼šæ‰§è¡Œæ¸…ç†å‡½æ•°ï¼Œç„¶åæ–°çš„ Effect æ‰ä¼šè¿è¡Œã€‚å¦‚æœæ²¡æœ‰æ¸…ç†å‡½æ•°ï¼Œä½ å¯èƒ½ä¼šåŒæ—¶è¿è¡Œä¸¤ä¸ªEffectï¼Œå¦‚æœå®ƒä»¬æ“ä½œçš„æ˜¯åŒä¸€ä¸ªèµ„æºï¼Œå°±ä¼šå¯¼è‡´ä¸ç¡®å®šçš„è¡Œä¸ºã€‚
> 3. å–æ¶ˆè¿›è¡Œä¸­çš„å¼‚æ­¥æ“ä½œ: å¯¹äºå¼‚æ­¥æ“ä½œï¼ˆå¦‚ `fetch API` è°ƒç”¨ï¼‰ï¼Œç»„ä»¶å¯èƒ½åœ¨è¯·æ±‚å®Œæˆä¹‹å‰å°±è¢«å¸è½½äº†ã€‚å¦‚æœåœ¨è¯·æ±‚ç»“æŸåå°è¯•è®¾ç½®ç»„ä»¶çš„çŠ¶æ€ï¼ŒReact ä¼šå‘å‡ºè­¦å‘Šï¼Œè¿™å¯èƒ½å¯¼è‡´æ½œåœ¨çš„é”™è¯¯ã€‚
{: .prompt-tip }


## è§£å†³æ–¹æ¡ˆ 

> æ­£ç¡®çš„åšæ³•æ˜¯ï¼Œä¸è¦è¯•å›¾é˜»æ­¢å®ƒæ‰§è¡Œä¸¤æ¬¡ï¼Œè€Œæ˜¯ç¡®ä¿ Effect å³ä½¿æ‰§è¡Œä¸¤æ¬¡ä¹Ÿä¸ä¼šå¯¼è‡´é—®é¢˜ã€‚è€Œä¸”è¿™ä¸ªæµ‹è¯•é€»è¾‘åªä¼šåœ¨å¼€å‘æ¨¡å¼ (Development Mode) ä¸‹çš„ `<StrictMode>` (ä¸¥æ ¼æ¨¡å¼)æ‰§è¡Œ
{: .prompt-tip }

### æ¸…ç†å‡½æ•°å®ç°
ä»»ä½•æ—¶å€™ï¼Œåªè¦ä½ çš„ Effect æ‰§è¡Œäº†ä»»ä½•éœ€è¦åœæ­¢ã€æ’¤é”€ã€æˆ–è€…é‡Šæ”¾å¤–éƒ¨èµ„æºçš„æ“ä½œï¼Œä½ å°±å¿…é¡»è¿”å›ä¸€ä¸ªæ¸…ç†å‡½æ•°ã€‚ä¸‹é¢æ˜¯ä¸€äº›å¸¸è§çš„æ¸…ç†å‡½æ•°å®ç°

#### æ¸…ç†äº‹ä»¶ç›‘å¬
å¦‚æœ Effect æ¶‰åŠåˆ°è®¢é˜…ã€å®šæ—¶å™¨ã€æˆ–äº‹ä»¶ç›‘å¬å™¨ç­‰ï¼ŒåŠ¡å¿… è¿”å›ä¸€ä¸ªæ¸…ç†å‡½æ•°æ¥æ’¤é”€ Effect æ‰€åšçš„äº‹æƒ…ã€‚è¿™æ˜¯ React å›¢é˜Ÿæ¨èçš„ä¿®å¤ç”±ä¸¥æ ¼æ¨¡å¼æš´éœ²å‡ºæ¥çš„é—®é¢˜çš„æ–¹æ³•ã€‚

```jsx
useEffect(() => {
  const timer = setInterval(() => {
    // ...
  }, 1000);

  console.log('Setup: å¯åŠ¨å®šæ—¶å™¨');

  // è¿”å›æ¸…ç†å‡½æ•°
  return () => {
    clearInterval(timer);
    console.log('Cleanup: æ¸…é™¤å®šæ—¶å™¨');
  };
}, []);
```

#### é‡ç½®é¡µé¢æ•°æ®å’ŒçŠ¶æ€
å¯¹äºä¸€äº›é¡µé¢å±æ€§çš„å˜æ›´ï¼Œåœ¨è¿”å›å‡½æ•°å†…éƒ¨å°†å…¶å˜æ›´çš„å±æ€§è¿›è¡Œè¿˜åŸã€‚

```jsx
useEffect(() => {
  const node = ref.current;
  node.style.opacity = 1; // Trigger the animation
  return () => {
    node.style.opacity = 0; // Reset to the initial value
  };
}, []);
```

æ¶‰åŠåˆ°å…ƒç´ çŠ¶æ€çš„ï¼Œæ¯”å¦‚æ’­æ”¾å™¨ä¹‹ç±»ï¼Œéœ€è¦å¯¹ï¼ˆå…ƒç´ ï¼‰æ’­æ”¾å™¨çš„çŠ¶æ€è¿›è¡Œé‡ç½®

```jsx
import { useEffect, useRef } from 'react';

function VideoPlayer({ src, isPlaying }) {
  const ref = useRef(null);

  useEffect(() => {
    if (isPlaying) {
      ref.current.play();
    } else {
      ref.current.pause();
    }
  });

  return <video ref={ref} src={src} loop playsInline />;
}
```

å¦‚æœæ˜¯é»˜è®¤å¼¹çª—ç±»ï¼Œè¿™ç§ä¹Ÿç®—æ˜¯å…ƒç´ çŠ¶æ€ï¼ŒåŒæ ·éœ€è¦å¯¹å…¶ï¼ˆå¼¹å‡ºï¼‰çŠ¶æ€è¿›è¡Œé‡ç½®ã€‚

```jsx
useEffect(() => {
  const dialog = dialogRef.current;
  dialog.showModal();
  return () => dialog.close();
}, []);
```

#### å–æ¶ˆè¿›è¡Œä¸­çš„å¼‚æ­¥æ“ä½œ

API è°ƒç”¨ ä½¿ç”¨ `AbortController` åœ¨æ¸…ç†å‡½æ•°ä¸­å–æ¶ˆè¿›è¡Œä¸­è¯·æ±‚

```jsx
useEffect(() => {
  const controller = new AbortController();
  fetchData(id, { signal: controller.signal });

  return () => {
    // ç»„ä»¶å¸è½½æˆ–idå˜åŒ–æ—¶ï¼Œå–æ¶ˆæœªå®Œæˆçš„è¯·æ±‚
    controller.abort(); 
  };
}, [id]);
```

### åœ¨å¼€å‘åœºæ™¯å¯¹ä¸¤æ¬¡æ‰§è¡Œçš„å¤„ç†

#### å¤–éƒ¨è¯·æ±‚

å¦‚æœ Effect ä¸­æœ‰æ•°æ®è·å–ï¼ˆå¦‚ API è°ƒç”¨ï¼‰ï¼Œè€Œä½ ä¸å¸Œæœ›å®ƒåœ¨å¼€å‘æ¨¡å¼ä¸‹è¯·æ±‚ä¸¤æ¬¡(ä¾‹å¦‚è¿™ä¸ªæ¥å£ä¸å…·å¤‡å¹‚ç­‰æ€§)ï¼Œä½ å¯ä»¥ä½¿ç”¨ä¸€äº›ç­–ç•¥ï¼š

- ä½¿ç”¨ç°ä»£çŠ¶æ€ç®¡ç†åº“æˆ–æ•°æ®è·å–åº“ï¼šå¦‚ React Query (TanStack Query) æˆ– SWRã€‚å®ƒä»¬å†…ç½®äº†é‡å¤è¯·æ±‚çš„å»é‡å’Œç¼“å­˜æœºåˆ¶ï¼Œèƒ½å¾ˆå¥½åœ°å¤„ç†ä¸¥æ ¼æ¨¡å¼ä¸‹çš„åŒé‡è°ƒç”¨ã€‚
- ä½¿ç”¨ AbortController å–æ¶ˆè¯·æ±‚ï¼šåœ¨æ¸…ç†å‡½æ•°ä¸­å–æ¶ˆç¬¬ä¸€ä¸ª Effect å¯åŠ¨çš„è¿›è¡Œä¸­çš„è¯·æ±‚ã€‚
- æ‰‹åŠ¨å¯¹è¯·æ±‚ç¼“å­˜

> `useEffect` çš„ä¸»è¦ç›®çš„æ˜¯åŒæ­¥ React çŠ¶æ€å’Œå¤–éƒ¨ç³»ç»Ÿã€‚
>
> ç†æƒ³æƒ…å†µä¸‹ï¼Œ`useEffect` åº”è¯¥ç”¨äºä»¥ä¸‹åœºæ™¯ï¼š
>
> - æ•°æ®è·å– (Data Fetching): ä½¿ç”¨ GET è¯·æ±‚ä»æœåŠ¡å™¨æ‹‰å–æ•°æ®ã€‚è¿™æ˜¯åªè¯»çš„ã€‚
> - è®¢é˜… (Subscriptions): ç›‘å¬å¤–éƒ¨çŠ¶æ€ï¼ˆå¦‚æµè§ˆå™¨çš„ resize äº‹ä»¶æˆ– Redux storeï¼‰ï¼Œå¹¶å°†çŠ¶æ€åŒæ­¥åˆ°ç»„ä»¶ã€‚
> - æµè§ˆå™¨å‰¯ä½œç”¨ï¼š ä¿®æ”¹ `document.title` æˆ–æ·»åŠ /ç§»é™¤äº‹ä»¶ç›‘å¬å™¨ã€‚
> - åˆ©ç”¨ `useRef` æ¥ç¡®ä¿ä½ çš„å‰¯ä½œç”¨é€»è¾‘åœ¨ä¸¥æ ¼æ¨¡å¼ä¸‹è®°å½•æ˜¯å¦æ˜¯é¦–æ¬¡æ‰§è¡Œ, å¹¶åªåœ¨é¦–æ¬¡æ‰§è¡Œçš„æ—¶å€™æ‰§è¡Œä¸€æ¬¡ã€‚ç„¶åå°è£…ä¸ºè‡ªå®šä¹‰Hookä½¿ç”¨
>
> å¯¹äºä»»ä½•ä¿®æ”¹å¤–éƒ¨çŠ¶æ€æˆ–å“åº”ç”¨æˆ·æ„å›¾çš„æ“ä½œï¼ˆä¾‹å¦‚ï¼Œæäº¤è¡¨å•ã€åˆ é™¤è®°å½•ã€ä¸ºè®¡æ•°å™¨ +1ï¼‰ï¼Œåº”è¯¥å°†å…¶æ”¾åœ¨äº‹ä»¶å¤„ç†å‡½æ•° (å¦‚ `onClick`, `onSubmit`) ä¸­ã€‚
>
> å¦‚æœå‡ºç°äº†åœ¨`useEffect`è°ƒç”¨å†™å…¥/ä¿®æ”¹æ¥å£(ä¸å…·å¤‡å¹‚ç­‰æ€§çš„æ¥å£)çš„æƒ…å†µä¸‹**ä¼˜å…ˆè€ƒè™‘é‡æ„ç»„ä»¶**åœ¨äº‹ä»¶å¤„ç†å‡½æ•°ä¸­å¤„ç†æ•°æ®ä¿®æ”¹
{: .prompt-tip }

ä¾‹å¦‚: è®¾ç½®ä¸€ä¸ª æ ‡è¯†ä½`ignore`ï¼Œåšåˆ°å¯¹é‡å¤è¯·æ±‚è¿”å›çš„æ•°æ®ä½¿ç”¨ç¼“å­˜ `cache.current`

```jsx
const cache = useRef(null);
useEffect(() => {
  let ignore = false;
  async function startFetching() {
    if (!cache.current) {
      // cache.current = await fetchTodos(userId);
      cache.current = true;
      await fetchTodos(userId);
    }
    if (!ignore) {
      setTodos(cache.current);
    }
  }
  startFetching();

  return () => {
    ignore = true;
  };
}, [userId]);
```

æˆ–è€…ä½¿ç”¨ `useRef`è‡ªå®šä¹‰ä¸€ä¸ª Hook `useComponentDidMount`

```jsx
import { useEffect, useRef } from 'react';

/**
 * å°è£…äº† useEffect å’Œ useRef çš„é€»è¾‘ï¼Œä»¥æ¨¡æ‹Ÿ Class ç»„ä»¶çš„ componentDidMount è¡Œä¸ºï¼Œ
 * å¹¶åœ¨ React 18 çš„ StrictMode ä¸‹é˜»æ­¢åŒé‡æ‰§è¡Œã€‚
 * * @param {function} callback - ä»…åœ¨ç»„ä»¶é¦–æ¬¡å®é™…æŒ‚è½½æ—¶æ‰§è¡Œçš„å‡½æ•°ã€‚
 */
export const useComponentDidMount = (callback) => {
  // ä½¿ç”¨ useRef æ¥è¿½è¸ª Effect æ˜¯å¦æ˜¯é¦–æ¬¡â€œå®é™…â€æ‰§è¡Œ
  const hasMounted = useRef(false);

  useEffect(() => {
    // æ£€æŸ¥ ref çš„å€¼
    if (hasMounted.current === false) {
      // é¦–æ¬¡æ‰§è¡Œï¼šè®¾ç½® ref ä¸º trueï¼Œç„¶åæ‰§è¡Œå›è°ƒ
      hasMounted.current = true;
      callback();
    } 
    // æ³¨æ„ï¼šè¿™é‡Œä¸éœ€è¦ else å—ï¼Œå› ä¸º cleanup å‡½æ•°å’Œä¾èµ–é¡¹æ•°ç»„ä¸ºç©º [] 
    // ç¡®ä¿äº†å®ƒåªåœ¨æŒ‚è½½å’Œå¸è½½æ—¶è¿è¡Œï¼Œä¸ä¼šåœ¨æ›´æ–°æ—¶è¿è¡Œã€‚
    
    // å¦‚æœ callback ä¸­æœ‰éœ€è¦æ¸…ç†çš„èµ„æºï¼ˆä¾‹å¦‚å®šæ—¶å™¨ï¼‰ï¼Œåˆ™éœ€è¦è¿”å›æ¸…ç†å‡½æ•°
    // return () => { 
    //   // ... cleanup logic (åœ¨ç»„ä»¶å¸è½½æ—¶æ‰§è¡Œ)
    // };

  }, [callback]); // ä¾èµ–é¡¹åŒ…å« callbackï¼Œç¡®ä¿å®ƒä¸ä¼šè¿‡æœŸ
};
```

`useComponentDidMount`ä½¿ç”¨æ¡ˆä¾‹ï¼š

```jsx
import React from 'react';
import { useComponentDidMount } from './useComponentDidMount'; // å‡è®¾æ–‡ä»¶è·¯å¾„

const TrackingComponent = () => {
  useComponentDidMount(() => {
    // è¿™é‡Œçš„ count() åªä¼šåœ¨ç»„ä»¶é¦–æ¬¡åŠ è½½æ—¶æ‰§è¡Œä¸€æ¬¡ï¼Œ
    // ä¸”ä¸å— StrictMode çš„åŒé‡æ‰§è¡Œå½±å“ã€‚
    console.log('âœ… ç»„ä»¶å·²åŠ è½½ï¼Œç²¾ç¡®åœ°æ‰§è¡Œä¸€æ¬¡ç»Ÿè®¡ API è°ƒç”¨');
    // countDatabaseIncrement(); 
  });

  return <div>å†…å®¹æ­£åœ¨å±•ç¤º...</div>;
};
```
è™½ç„¶ React æ²¡æœ‰æä¾›ä¸€ä¸ªç±»ä¼¼äº Class ç»„ä»¶çš„ `componentDidMount()` çš„æ— å‰¯ä½œç”¨ Hook ä½œä¸ºå†…ç½®åŠŸèƒ½ï¼Œä½†é€šè¿‡ç»“åˆ `useEffect` å’Œ `useRef`ï¼Œå¯ä»¥è½»æ¾åœ°åˆ›å»ºä¸€ä¸ªåŠŸèƒ½å®Œå…¨ç›¸åŒçš„è‡ªå®šä¹‰ Hook

#### ç¦ç”¨ä¸¥æ ¼æ¨¡å¼
å¦‚æœç¡®å®šä¸æƒ³ä½¿ç”¨æ­¤åŠŸèƒ½ï¼ˆä¾‹å¦‚åœ¨è°ƒè¯•æ—§ä»£ç æ—¶ï¼‰ï¼Œä½ å¯ä»¥ä»ä½ çš„å…¥å£æ–‡ä»¶ä¸­ç§»é™¤ `<StrictMode>` æ ‡ç­¾ï¼š

```jsx
// import { StrictMode } from 'react'; // ä¸å†éœ€è¦
import * as ReactDOMClient from 'react-dom/client';
import App from './App';

const root = ReactDOMClient.createRoot(document.getElementById('root'));

root.render(
  // ç§»é™¤ <StrictMode>
  <App />
);
```

> Reactå®˜æ–¹å¼ºçƒˆä¸å»ºè®®åœ¨å¼€å‘è¿‡ç¨‹ä¸­ç¦ç”¨ä¸¥æ ¼æ¨¡å¼ï¼Œå› ä¸ºå®ƒæœ‰åŠ©äºå‘ç°æ½œåœ¨çš„ Bugã€‚
{: .prompt-warning }

# å‚è€ƒ
- [React18çš„useEffectä¼šæ‰§è¡Œä¸¤æ¬¡](https://juejin.cn/post/7137654077743169573)
