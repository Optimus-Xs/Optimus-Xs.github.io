<!DOCTYPE html><html lang="zh-CN" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="prefer-datetime-locale" content="zh-cn"><meta name="generator" content="Jekyll v4.2.2" /><meta property="og:title" content="在 SpringBoot 中集成 Redis" /><meta property="og:locale" content="zh_CN" /><meta name="description" content="Redis 简介 一个系统在于数据库交互的过程中，内存的速度远远快于硬盘速度，当我们重复地获取相同数据时，我们一次又一次地请求数据库或远程服务，者无疑时性能上地浪费（这会导致大量时间被浪费在数据库查询或者远程方法调用上致使程序性能恶化），于是有了“缓存”。" /><meta property="og:description" content="Redis 简介 一个系统在于数据库交互的过程中，内存的速度远远快于硬盘速度，当我们重复地获取相同数据时，我们一次又一次地请求数据库或远程服务，者无疑时性能上地浪费（这会导致大量时间被浪费在数据库查询或者远程方法调用上致使程序性能恶化），于是有了“缓存”。" /><link rel="canonical" href="https://optimus-xs.github.io/posts/integrate-redis-in-springboot/" /><meta property="og:url" content="https://optimus-xs.github.io/posts/integrate-redis-in-springboot/" /><meta property="og:site_name" content="Optimus-Xs’ Blog" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2021-04-15T13:47:00+08:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="在 SpringBoot 中集成 Redis" /><meta name="twitter:site" content="@twitter_username" /><meta name="google-site-verification" content="VWHcsZQRCRLxZT171OOZpP1emj_N4gMlSvgq8UReWz4" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2021-04-15T13:47:00+08:00","datePublished":"2021-04-15T13:47:00+08:00","description":"Redis 简介 一个系统在于数据库交互的过程中，内存的速度远远快于硬盘速度，当我们重复地获取相同数据时，我们一次又一次地请求数据库或远程服务，者无疑时性能上地浪费（这会导致大量时间被浪费在数据库查询或者远程方法调用上致使程序性能恶化），于是有了“缓存”。","headline":"在 SpringBoot 中集成 Redis","mainEntityOfPage":{"@type":"WebPage","@id":"https://optimus-xs.github.io/posts/integrate-redis-in-springboot/"},"url":"https://optimus-xs.github.io/posts/integrate-redis-in-springboot/"}</script><title>在 SpringBoot 中集成 Redis | Optimus-Xs' Blog</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="Optimus-Xs' Blog"><meta name="application-name" content="Optimus-Xs' Blog"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link rel="dns-prefetch" href="https://fonts.gstatic.com" crossorigin><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://cdn.jsdelivr.net" ><link rel="dns-prefetch" href="https://cdn.jsdelivr.net" ><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato&family=Source+Sans+Pro:wght@400;600;700;900&display=swap"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get MODE_ATTR() { return "data-mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } static get ID() { return "mode-toggle"; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } let self = this; /* always follow the system prefers */ this.sysDarkPrefers.addEventListener("change", () => { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.notify(); }); } /* constructor() */ get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode === ModeToggle.DARK_MODE; } get isLightMode() { return this.mode === ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer)) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } setDark() { $('html').attr(ModeToggle.MODE_ATTR, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_ATTR, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_ATTR); sessionStorage.removeItem(ModeToggle.MODE_KEY); } /* Notify another plugins that the theme mode has changed */ notify() { window.postMessage({ direction: ModeToggle.ID, message: this.modeStatus }, "*"); } } /* ModeToggle */ const toggle = new ModeToggle(); function flipMode() { if (toggle.hasMode) { if (toggle.isSysDarkPrefer) { if (toggle.isLightMode) { toggle.clearMode(); } else { toggle.setLight(); } } else { if (toggle.isDarkMode) { toggle.clearMode(); } else { toggle.setDark(); } } } else { if (toggle.isSysDarkPrefer) { toggle.setLight(); } else { toggle.setDark(); } } toggle.notify(); } /* flipMode() */ </script><body data-spy="scroll" data-target="#toc" data-topbar-visible="true"><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" alt="avatar" class="mx-auto"> <img src=" /assets/img/miTu.jpg " alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">Optimus-Xs' Blog</a></div><div class="site-subtitle font-italic">「Think Different」</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>首页</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>分类</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tag ml-xl-3 mr-xl-3 unloaded"></i> <span>标签</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>归档</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info-circle ml-xl-3 mr-xl-3 unloaded"></i> <span>关于</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center align-items-center"> <button class="mode-toggle btn" aria-label="Switch Mode"> <i class="fas fa-adjust"></i> </button> <span class="icon-border"></span> <a href="https://github.com/Optimus-Xs" aria-label="github" target="_blank" rel="noopener"> <i class="fab fa-github"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['Wenlong.Zuo','outlook.com'].join('@')" aria-label="email" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" > <i class="fas fa-rss"></i> </a></div></div><div id="topbar-wrapper" class="row justify-content-center"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/"> 首页 </a> </span> <span>在 SpringBoot 中集成 Redis</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> 文章</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="搜索..."> </span> <span id="search-cancel" >取消</span></div></div><div id="main-wrapper"><div id="main"><div class="row"><div id="core-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip>在 SpringBoot 中集成 Redis</h1><div class="post-meta text-muted"><div> 作者 <em> <a href="https://github.com/Optimus-Xs">Optimus-Xs</a> </em></div><div class="d-flex"><div> <span> 发表于 <em class="timeago" data-ts="1618465620" data-toggle="tooltip" data-placement="bottom" data-tooltip-df="llll" > 2021-04-15 </em> </span> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="6200 字"> <em>34 分钟</em>阅读</span></div></div></div><div class="post-content"><h1 id="redis-简介">Redis 简介</h1><p>一个系统在于数据库交互的过程中，内存的速度远远快于硬盘速度，当我们重复地获取相同数据时，我们一次又一次地请求数据库或远程服务，者无疑时性能上地浪费（这会导致大量时间被浪费在数据库查询或者远程方法调用上致使程序性能恶化），于是有了“缓存”。</p><p>Redis 是目前业界使用最广泛的内存数据存储。相比 Memcached，Redis 支持更丰富的数据结构，例如 hashes, lists, sets 等，同时支持数据持久化。除此之外，Redis 还提供一些类数据库的特性，比如事务，HA，主从库。</p><p>Redis 与其他 key - value 缓存产品有以下三个特点：</p><ul><li>edis支持数据的持久化，可以将内存中的数据保存在磁盘中，重启的时候可以再次加载进行使用。<li>edis不仅仅支持简单的key-value类型的数据，同时还提供list，set，zset，hash等数据结构的存储。<li>edis支持数据的备份，即master-slave模式的数据备份。</ul><p>可以说 Redis 兼具了缓存系统和数据库的一些特性，因此有着丰富的应用场景。本文介绍 Redis 在 Spring Boot 中两个典型的应用场景。</p><h1 id="spring-cache">Spring Cache</h1><h2 id="springcache简介"><span class="mr-2">SpringCache简介</span><a href="#springcache简介" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><p>Spring Cache是Spring框架提供的对缓存使用的抽象类，支持多种缓存，比如Redis、EHCache等，集成很方便。同时提供了多种注解来简化缓存的使用，可对方法进行缓存。</p><h3 id="关于springcache-注解的简单介绍"><span class="mr-2">关于SpringCache 注解的简单介绍</span><a href="#关于springcache-注解的简单介绍" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><ul><li>@CacheConfig:主要用于配置该类中会用到的一些共用的缓存配置<li>@Cacheable:主要方法返回值加入缓存。同时在查询时，会先从缓存中取，若不存在才再发起对数据库的访问。<li>@CachePut:配置于函数上，能够根据参数定义条件进行缓存，与@Cacheable不同的是，每次回真实调用函数，所以主要用于数据新增和修改操作上。<li>@CacheEvict:配置于函数上，通常用在删除方法上，用来从缓存中移除对应数据<li>@Caching:配置于函数上，组合多个Cache注解使用。</ul><h2 id="springcache-注解"><span class="mr-2">SpringCache 注解</span><a href="#springcache-注解" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><h3 id="cacheconfig"><span class="mr-2">@CacheConfig</span><a href="#cacheconfig" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><p>所有的@Cacheable（）里面都有一个value＝“xxx”的属性，这显然如果方法多了，写起来也是挺累的，如果可以一次性声明完 那就省事了， 所以，有了@CacheConfig这个配置，@CacheConfig is a class-level annotation that allows to share the cache names，如果你在你的方法写别的名字，那么依然以方法的名字为准。</p><p>@CacheConfig是一个类级别的注解。</p><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
</pre><td class="rouge-code"><pre><span class="cm">/** * 测试服务层 */</span>
<span class="nd">@Service</span>
<span class="nd">@CacheConfig</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">"taskLog"</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">TaskLogService</span> <span class="o">{</span>
 
    <span class="nd">@Autowired</span>  <span class="kd">private</span> <span class="nc">TaskLogMapper</span> <span class="n">taskLogMapper</span><span class="o">;</span>
    <span class="nd">@Autowired</span>  <span class="kd">private</span> <span class="n">net</span><span class="o">.</span><span class="na">sf</span><span class="o">.</span><span class="na">ehcache</span><span class="o">.</span><span class="na">CacheManager</span> <span class="n">cacheManager</span><span class="o">;</span>
 
    <span class="cm">/** * 缓存的key */</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">String</span> <span class="no">CACHE_KEY</span>   <span class="o">=</span> <span class="s">"taskLog"</span><span class="o">;</span>
 
    <span class="cm">/** * 添加tasklog * @param tasklog * @return */</span>
    <span class="nd">@CachePut</span><span class="o">(</span><span class="n">key</span> <span class="o">=</span> <span class="s">"#tasklog.id"</span><span class="o">)</span>
    <span class="kd">public</span> <span class="nc">Tasklog</span> <span class="nf">create</span><span class="o">(</span><span class="nc">Tasklog</span> <span class="n">tasklog</span><span class="o">){</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"CREATE"</span><span class="o">);</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">err</span><span class="o">.</span><span class="na">println</span> <span class="o">(</span><span class="n">tasklog</span><span class="o">);</span>
        <span class="n">taskLogMapper</span><span class="o">.</span><span class="na">insert</span><span class="o">(</span><span class="n">tasklog</span><span class="o">);</span>
        <span class="k">return</span> <span class="n">tasklog</span><span class="o">;</span>
    <span class="o">}</span>
 
    <span class="cm">/** * 根据ID获取Tasklog * @param id * @return */</span>
    <span class="nd">@Cacheable</span><span class="o">(</span><span class="n">key</span> <span class="o">=</span> <span class="s">"#id"</span><span class="o">)</span>
    <span class="kd">public</span> <span class="nc">Tasklog</span> <span class="nf">findById</span><span class="o">(</span><span class="nc">String</span> <span class="n">id</span><span class="o">){</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"FINDBYID"</span><span class="o">);</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"ID:"</span><span class="o">+</span><span class="n">id</span><span class="o">);</span>
        <span class="k">return</span> <span class="n">taskLogMapper</span><span class="o">.</span><span class="na">selectById</span><span class="o">(</span><span class="n">id</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></table></code></div></div><h3 id="cacheable"><span class="mr-2">@Cacheable</span><a href="#cacheable" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><p>@Cacheable 的作用 主要针对方法配置，能够根据方法的请求参数对其结果进行缓存</p><ul><li>value、cacheNames：两个等同的参数（cacheNames为Spring 4新增，作为value的别名），用于指定缓存存储的集合名。由于Spring 4中新增了@CacheConfig，因此在Spring 3中原本必须有的value属性，也成为非必需项了<li>key：缓存对象存储在Map集合中的key值，非必需，缺省按照函数的所有参数组合作为key值，若自己配置需使用SpEL表达式，比如：@Cacheable(key = “#p0”)：使用函数第一个参数作为缓存的key值，更多关于SpEL表达式的详细内容可参考官方文档<li>condition：缓存对象的条件，非必需，也需使用SpEL表达式，只有满足表达式条件的内容才会被缓存，比如：@Cacheable(key = “#p0”, condition = “#p0.length() &lt; 3”)，表示只有当第一个参数的长度小于3的时候才会被缓存，若做此配置上面的AAA用户就不会被缓存，读者可自行实验尝试。<li>unless：另外一个缓存条件参数，非必需，需使用SpEL表达式。它不同于condition参数的地方在于它的判断时机，该条件是在函数被调用之后才做判断的，所以它可以通过对result进行判断。<li>keyGenerator：用于指定key生成器，非必需。若需要指定一个自定义的key生成器，我们需要去实现org.springframework.cache.interceptor.KeyGenerator接口，并使用该参数来指定。需要注意的是：该参数与key是互斥的<li>cacheManager：用于指定使用哪个缓存管理器，非必需。只有当有多个时才需要使用<li>cacheResolver：用于指定使用那个缓存解析器，非必需。需通过org.springframework.cache.interceptor.CacheResolver接口来实现自己的缓存解析器，并用该参数指定。</ul><p>作用和配置方法</p><div class="table-wrapper"><table><thead><tr><th style="text-align: left">参数<th style="text-align: left">解释<th style="text-align: left">example<tbody><tr><td style="text-align: left">value<td style="text-align: left">缓存的名称，在 spring 配置文件中定义，必须指定至少一个<td style="text-align: left">例如: @Cacheable(value=”mycache”) <br /> @Cacheable(value={”cache1”,”cache2”}<tr><td style="text-align: left">key<td style="text-align: left">缓存的 key，可以为空，如果指定要按照 SpEL 表达式编写，<br />如果不指定，则缺省按照方法的所有参数进行组合<td style="text-align: left">@Cacheable(value=”testcache”,key=”#userName”)<tr><td style="text-align: left">condition<td style="text-align: left">缓存的条件，可以为空，使用 SpEL 编写，<br />返回 true 或者 false，只有为 true 才进行缓存<td style="text-align: left">@Cacheable(value=”testcache”,condition=”#userName.length()&gt;2”)</table></div><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre><td class="rouge-code"><pre>    <span class="cm">/** * 根据ID获取Tasklog * @param id * @return */</span>
    <span class="nd">@Cacheable</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="no">CACHE_KEY</span><span class="o">,</span> <span class="n">key</span> <span class="o">=</span> <span class="s">"#id"</span><span class="o">,</span><span class="n">condition</span> <span class="o">=</span> <span class="s">"#result != null"</span><span class="o">)</span>
    <span class="kd">public</span> <span class="nc">Tasklog</span> <span class="nf">findById</span><span class="o">(</span><span class="nc">String</span> <span class="n">id</span><span class="o">){</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"FINDBYID"</span><span class="o">);</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"ID:"</span><span class="o">+</span><span class="n">id</span><span class="o">);</span>
        <span class="k">return</span> <span class="n">taskLogMapper</span><span class="o">.</span><span class="na">selectById</span><span class="o">(</span><span class="n">id</span><span class="o">);</span>
    <span class="o">}</span>
</pre></table></code></div></div><h3 id="cacheput"><span class="mr-2">@CachePut</span><a href="#cacheput" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><p>@CachePut 的作用 主要针对方法配置，能够根据方法的请求参数对其结果进行缓存，和 @Cacheable 不同的是，它每次都会触发真实方法的调用</p><p>作用和配置方法</p><div class="table-wrapper"><table><thead><tr><th style="text-align: left">参数<th style="text-align: left">解释<th style="text-align: left">example<tbody><tr><td style="text-align: left">value<td style="text-align: left">缓存的名称，在 spring 配置文件中定义，必须指定至少一个<td style="text-align: left">@CachePut(value=”my cache”)<tr><td style="text-align: left">key<td style="text-align: left">缓存的 key，可以为空，如果指定要按照 SpEL 表达式编写，如果不指定，则缺省按照方法的所有参数进行组合<td style="text-align: left">@CachePut(value=”testcache”,key=”#userName”)<tr><td style="text-align: left">condition<td style="text-align: left">缓存的条件，可以为空，使用 SpEL 编写，返回 true 或者 false，只有为 true 才进行缓存<td style="text-align: left">@CachePut(value=”testcache”,condition=”#userName.length()&gt;2”)</table></div><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre><td class="rouge-code"><pre>    <span class="cm">/** * 添加tasklog * @param tasklog * @return */</span>
    <span class="nd">@CachePut</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="no">CACHE_KEY</span><span class="o">,</span> <span class="n">key</span> <span class="o">=</span> <span class="s">"#tasklog.id"</span><span class="o">)</span>
    <span class="kd">public</span> <span class="nc">Tasklog</span> <span class="nf">create</span><span class="o">(</span><span class="nc">Tasklog</span> <span class="n">tasklog</span><span class="o">){</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"CREATE"</span><span class="o">);</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">err</span><span class="o">.</span><span class="na">println</span> <span class="o">(</span><span class="n">tasklog</span><span class="o">);</span>
        <span class="n">taskLogMapper</span><span class="o">.</span><span class="na">insert</span><span class="o">(</span><span class="n">tasklog</span><span class="o">);</span>
        <span class="k">return</span> <span class="n">tasklog</span><span class="o">;</span>
    <span class="o">}</span>
</pre></table></code></div></div><h3 id="cacheevict"><span class="mr-2">@CacheEvict</span><a href="#cacheevict" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><p>@CachEvict 的作用 主要针对方法配置，能够根据一定的条件对缓存进行清空</p><p>作用和配置方法</p><div class="table-wrapper"><table><thead><tr><th style="text-align: left">参数<th style="text-align: left">解释<th style="text-align: left">example<tbody><tr><td style="text-align: left">value<td style="text-align: left">缓存的名称，在 spring 配置文件中定义，必须指定至少一个<td style="text-align: left">@CacheEvict(value=”my cache”)<tr><td style="text-align: left">key<td style="text-align: left">缓存的 key，可以为空，如果指定要按照 SpEL 表达式编写，如果不指定，则缺省按照方法的所有参数进行组合<td style="text-align: left">@CacheEvict(value=”testcache”,key=”#userName”)<tr><td style="text-align: left">condition<td style="text-align: left">缓存的条件，可以为空，使用 SpEL 编写，返回 true 或者 false，只有为 true 才进行缓存<td style="text-align: left">@CacheEvict(value=”testcache”,condition=”#userName.length()&gt;2”)<tr><td style="text-align: left">allEntries<td style="text-align: left">是否清空所有缓存内容，缺省为 false，如果指定为 true，则方法调用后将立即清空所有缓存<td style="text-align: left">@CachEvict(value=”testcache”,allEntries=true)<tr><td style="text-align: left">beforeInvocation<td style="text-align: left">是否在方法执行前就清空，缺省为 false，如果指定为 true，则在方法还没有执行的时候就清空缓存，缺省情况下，如果方法执行抛出异常，则不会清空缓存<td style="text-align: left">@CachEvict(value=”testcache”，beforeInvocation=true)</table></div><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre><td class="rouge-code"><pre>    <span class="cm">/** * 根据ID删除Tasklog * @param id */</span>
    <span class="nd">@CacheEvict</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="no">CACHE_KEY</span><span class="o">,</span> <span class="n">key</span> <span class="o">=</span> <span class="s">"#id"</span><span class="o">)</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">delete</span><span class="o">(</span><span class="nc">String</span> <span class="n">id</span><span class="o">){</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"DELETE"</span><span class="o">);</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"ID:"</span><span class="o">+</span><span class="n">id</span><span class="o">);</span>
        <span class="n">taskLogMapper</span><span class="o">.</span><span class="na">deleteById</span><span class="o">(</span><span class="n">id</span><span class="o">);</span>
    <span class="o">}</span>
</pre></table></code></div></div><h3 id="caching"><span class="mr-2">@Caching</span><a href="#caching" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><p>有时候我们可能组合多个Cache注解使用；比如用户新增成功后，我们要添加id–&gt;user；username—&gt;user；email—&gt;user的缓存；此时就需要@Caching组合多个注解标签了。</p><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre><td class="rouge-code"><pre><span class="nd">@Caching</span><span class="o">(</span><span class="n">put</span> <span class="o">=</span> <span class="o">{</span>
<span class="nd">@CachePut</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">"user"</span><span class="o">,</span> <span class="n">key</span> <span class="o">=</span> <span class="s">"#user.id"</span><span class="o">),</span>
<span class="nd">@CachePut</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">"user"</span><span class="o">,</span> <span class="n">key</span> <span class="o">=</span> <span class="s">"#user.username"</span><span class="o">),</span>
<span class="nd">@CachePut</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">"user"</span><span class="o">,</span> <span class="n">key</span> <span class="o">=</span> <span class="s">"#user.email"</span><span class="o">)</span>
<span class="o">})</span>
<span class="kd">public</span> <span class="nc">User</span> <span class="nf">save</span><span class="o">(</span><span class="nc">User</span> <span class="n">user</span><span class="o">)</span> <span class="o">{</span>
<span class="o">}</span>
</pre></table></code></div></div><h3 id="自定义缓存注解"><span class="mr-2">自定义缓存注解</span><a href="#自定义缓存注解" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><p>比如之前的那个@Caching组合，会让方法上的注解显得整个代码比较乱，此时可以使用自定义注解把这些注解组合到一个注解中，如：</p><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
</pre><td class="rouge-code"><pre><span class="nd">@Caching</span><span class="o">(</span><span class="n">put</span> <span class="o">=</span> <span class="o">{</span>
    <span class="nd">@CachePut</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">"user"</span><span class="o">,</span> <span class="n">key</span> <span class="o">=</span> <span class="s">"#user.id"</span><span class="o">),</span>
    <span class="nd">@CachePut</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">"user"</span><span class="o">,</span> <span class="n">key</span> <span class="o">=</span> <span class="s">"#user.username"</span><span class="o">),</span>
    <span class="nd">@CachePut</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">"user"</span><span class="o">,</span> <span class="n">key</span> <span class="o">=</span> <span class="s">"#user.email"</span><span class="o">)</span>
<span class="o">})</span>
<span class="nd">@Target</span><span class="o">({</span><span class="nc">ElementType</span><span class="o">.</span><span class="na">METHOD</span><span class="o">,</span> <span class="nc">ElementType</span><span class="o">.</span><span class="na">TYPE</span><span class="o">})</span>
<span class="nd">@Retention</span><span class="o">(</span><span class="nc">RetentionPolicy</span><span class="o">.</span><span class="na">RUNTIME</span><span class="o">)</span>
<span class="nd">@Inherited</span>
<span class="kd">public</span> <span class="nd">@interface</span> <span class="nc">UserSaveCache</span> <span class="o">{</span>
<span class="o">}</span>
</pre></table></code></div></div><p>这样我们在方法上使用如下代码即可，整个代码显得比较干净。</p><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre><span class="nd">@UserSaveCache</span>
<span class="kd">public</span> <span class="nc">User</span> <span class="nf">save</span><span class="o">(</span><span class="nc">User</span> <span class="n">user</span><span class="o">){}</span>
</pre></table></code></div></div><h3 id="spring-cache提供的spel上下文数据"><span class="mr-2">Spring Cache提供的SpEL上下文数据</span><a href="#spring-cache提供的spel上下文数据" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><div class="table-wrapper"><table><thead><tr><th style="text-align: left">名字<th style="text-align: left">位置<th style="text-align: left">描述<th>示例<tbody><tr><td style="text-align: left">methodName<td style="text-align: left">root对象<td style="text-align: left">当前被调用的方法名<td>#root.methodName<tr><td style="text-align: left">method<td style="text-align: left">root对象<td style="text-align: left">当前被调用的方法<td>#root.method.name<tr><td style="text-align: left">target<td style="text-align: left">root对象<td style="text-align: left">当前被调用的目标对象<td>#root.target<tr><td style="text-align: left">targetClass<td style="text-align: left">root对象<td style="text-align: left">当前被调用的目标对象类<td>#root.targetClass<tr><td style="text-align: left">args<td style="text-align: left">root对象<td style="text-align: left">当前被调用的方法的参数列表<td>#root.args[0]<tr><td style="text-align: left">caches<td style="text-align: left">root对象<td style="text-align: left">当前方法调用使用的缓存列表（如@Cacheable(value={“cache1”, “cache2”})），则有两个cache<td>#root.caches[0].name<tr><td style="text-align: left">argument name<td style="text-align: left">执行上下文<td style="text-align: left">当前被调用的方法的参数，如findById(Long id)，我们可以通过#id拿到参数<td>#user.id<tr><td style="text-align: left">result<td style="text-align: left">执行上下文<td style="text-align: left">方法执行后的返回值（仅当方法执行之后的判断有效，如‘unless’，’cache evict’的beforeInvocation=false）<td>#result</table></div><h2 id="springcache和redis集成过程"><span class="mr-2">SpringCache和Redis集成过程</span><a href="#springcache和redis集成过程" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><h3 id="操作步骤"><span class="mr-2">操作步骤</span><a href="#操作步骤" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><p>我们要把一个查询函数加入缓存功能，大致需要三步。</p><ol><li>在函数执行前，我们需要先检查缓存中是否存在数据，如果存在则返回缓存数据。<li>如果不存在，就需要在数据库的数据查询出来。<li>最后把数据存放在缓存中，当下次调用此函数时，就可以直接使用缓存数据，减轻了数据库压力。</ol><h3 id="spring-cacahe-运行流程"><span class="mr-2">Spring Cacahe 运行流程</span><a href="#spring-cacahe-运行流程" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><ol><li>首先执行@CacheEvict（如果beforeInvocation=true且condition 通过），如果allEntries=true，则清空所有<li>接着收集@Cacheable（如果condition 通过，且key对应的数据不在缓存），放入cachePutRequests（也就是说如果cachePutRequests为空，则数据在缓存中）<li>如果cachePutRequests为空且没有@CachePut操作，那么将查找@Cacheable的缓存，否则result=缓存数据（也就是说只要当没有cache put请求时才会查找缓存）<li>如果没有找到缓存，那么调用实际的API，把结果放入result<li>如果有@CachePut操作(如果condition 通过)，那么放入cachePutRequests<li>执行cachePutRequests，将数据写入缓存（unless为空或者unless解析结果为false）；<li>执行@CacheEvict（如果beforeInvocation=false 且 condition 通过），如果allEntries=true，则清空所有</ol><blockquote class="prompt-tip"><div><p>流程中需要注意的就是2/3/4步：</p><p>如果有@CachePut操作，即使有@Cacheable也不会从缓存中读取；问题很明显，如果要混合多个注解使用，不能组合使用@CachePut和@Cacheable；</p><p>官方说应该避免这样使用（解释是如果带条件的注解相互排除的场景）；不过个人感觉还是不要考虑这个好，让用户来决定如何使用，否则一会介绍的场景不能满足。</p></div></blockquote><h3 id="具体操作"><span class="mr-2">具体操作</span><a href="#具体操作" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><p>添加依赖</p><div class="language-xml highlighter-rouge"><div class="code-header"> <span data-label-text="XML"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre><span class="c">&lt;!-- springboot redis依赖--&gt;</span>
        <span class="nt">&lt;dependency&gt;</span>
        <span class="nt">&lt;groupId&gt;</span>org.springframework.boot<span class="nt">&lt;/groupId&gt;</span>
        <span class="nt">&lt;artifactId&gt;</span>spring-boot-starter-data-redis<span class="nt">&lt;/artifactId&gt;</span>
        <span class="nt">&lt;/dependency&gt;</span>
</pre></table></code></div></div><blockquote class="prompt-tip"><div><p>注: 其实我们从官方文档可以看到spring-boot-starter-data-redis 已经包含了jedis客户端，我们在使用jedis连接池的时候不必再添加jedis依赖。</p></div></blockquote><p>配置SpringCache，Redis连接等信息</p><div file="RedisConfig.java" class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="RedisConfig.java"><i class="far fa-file-code"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
</pre><td class="rouge-code"><pre><span class="nd">@Configuration</span>
<span class="nd">@EnableCaching</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">RedisConfig</span> <span class="o">{</span>

    <span class="cm">/**
     * 申明缓存管理器，会创建一个切面（aspect）并触发Spring缓存注解的切点（pointcut）
     * 根据类或者方法所使用的注解以及缓存的状态，这个切面会从缓存中获取数据，将数据添加到缓存之中或者从缓存中移除某个值

     * @return
     */</span>
    <span class="nd">@Bean</span>
    <span class="kd">public</span> <span class="nc">RedisCacheManager</span> <span class="nf">cacheManager</span><span class="o">(</span><span class="nc">RedisConnectionFactory</span> <span class="n">redisConnectionFactory</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="nc">RedisCacheManager</span><span class="o">.</span><span class="na">create</span><span class="o">(</span><span class="n">redisConnectionFactory</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@Bean</span>
    <span class="kd">public</span> <span class="nc">RedisTemplate</span> <span class="nf">redisTemplate</span><span class="o">(</span><span class="nc">RedisConnectionFactory</span> <span class="n">factory</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">// 创建一个模板类</span>
        <span class="nc">RedisTemplate</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">Object</span><span class="o">&gt;</span> <span class="n">template</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">RedisTemplate</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">Object</span><span class="o">&gt;();</span>
        <span class="c1">// 将刚才的redis连接工厂设置到模板类中</span>
        <span class="n">template</span><span class="o">.</span><span class="na">setConnectionFactory</span><span class="o">(</span><span class="n">factory</span><span class="o">);</span>
        <span class="c1">// 设置key的序列化器</span>
        <span class="n">template</span><span class="o">.</span><span class="na">setKeySerializer</span><span class="o">(</span><span class="k">new</span> <span class="nc">StringRedisSerializer</span><span class="o">());</span>
        <span class="c1">// 设置value的序列化器</span>
        <span class="c1">//使用Jackson 2，将对象序列化为JSON</span>
        <span class="nc">Jackson2JsonRedisSerializer</span> <span class="n">jackson2JsonRedisSerializer</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Jackson2JsonRedisSerializer</span><span class="o">(</span><span class="nc">Object</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
        <span class="c1">//json转对象类，不设置默认的会将json转成hashmap</span>
        <span class="nc">ObjectMapper</span> <span class="n">om</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ObjectMapper</span><span class="o">();</span>
        <span class="n">om</span><span class="o">.</span><span class="na">setVisibility</span><span class="o">(</span><span class="nc">PropertyAccessor</span><span class="o">.</span><span class="na">ALL</span><span class="o">,</span> <span class="nc">JsonAutoDetect</span><span class="o">.</span><span class="na">Visibility</span><span class="o">.</span><span class="na">ANY</span><span class="o">);</span>
        <span class="n">om</span><span class="o">.</span><span class="na">enableDefaultTyping</span><span class="o">(</span><span class="nc">ObjectMapper</span><span class="o">.</span><span class="na">DefaultTyping</span><span class="o">.</span><span class="na">NON_FINAL</span><span class="o">);</span>
        <span class="n">jackson2JsonRedisSerializer</span><span class="o">.</span><span class="na">setObjectMapper</span><span class="o">(</span><span class="n">om</span><span class="o">);</span>
        <span class="n">template</span><span class="o">.</span><span class="na">setValueSerializer</span><span class="o">(</span><span class="n">jackson2JsonRedisSerializer</span><span class="o">);</span>

        <span class="k">return</span> <span class="n">template</span><span class="o">;</span>
    <span class="o">}</span> 
<span class="o">}</span> 
</pre></table></code></div></div><p>redis配置</p><div file="application.yml" class="language-yml highlighter-rouge"><div class="code-header"> <span data-label-text="application.yml"><i class="far fa-file-code"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
</pre><td class="rouge-code"><pre><span class="na">spring</span><span class="pi">:</span>
  <span class="c1"># redis相关配置</span>
  <span class="na">redis</span><span class="pi">:</span>
    <span class="na">database</span><span class="pi">:</span> <span class="m">0</span>
    <span class="na">host</span><span class="pi">:</span> <span class="s">localhost</span>
    <span class="na">port</span><span class="pi">:</span> <span class="m">6379</span>
    <span class="na">password</span><span class="pi">:</span> <span class="err">******</span>
    <span class="na">jedis</span><span class="pi">:</span>
      <span class="na">pool</span><span class="pi">:</span>
        <span class="c1"># 连接池最大连接数（使用负值表示没有限制）</span>
        <span class="na">max-active</span><span class="pi">:</span> <span class="m">8</span>
        <span class="c1"># 连接池最大阻塞等待时间（使用负值表示没有限制）</span>
        <span class="na">max-wait</span><span class="pi">:</span> <span class="s">-1ms</span>
        <span class="c1"># 连接池中的最大空闲连接</span>
        <span class="na">max-idle</span><span class="pi">:</span> <span class="m">8</span>
        <span class="c1"># 连接池中的最小空闲连接</span>
        <span class="na">min-idle</span><span class="pi">:</span> <span class="m">0</span>
    <span class="c1"># 连接超时时间（毫秒）默认是2000ms</span>
    <span class="na">timeout</span><span class="pi">:</span> <span class="s">2000ms</span>
  <span class="na">cache</span><span class="pi">:</span>
    <span class="na">redis</span><span class="pi">:</span>
      <span class="c1">## Entry expiration in milliseconds. By default the entries never expire.</span>
      <span class="na">time-to-live</span><span class="pi">:</span> <span class="s">1d</span>
      <span class="c1">#写入redis时是否使用键前缀。</span>
      <span class="na">use-key-prefix</span><span class="pi">:</span> <span class="no">true</span>
</pre></table></code></div></div><p>启动类</p><p>cache相关注解必须在spring所管理的bean容器中，这样才能使缓存生效</p><p>启动类中要加入@EnableCaching注解支持缓存</p><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre><td class="rouge-code"><pre><span class="nd">@SpringBootApplication</span>
<span class="nd">@EnableCaching</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">CoreApplication</span> <span class="o">{</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">SpringApplication</span><span class="o">.</span><span class="na">run</span><span class="o">(</span><span class="nc">CoreApplication</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">args</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></table></code></div></div><p>编写实体类</p><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
</pre><td class="rouge-code"><pre><span class="nd">@Data</span>
<span class="c1">//lombok依赖，可省略get set方法</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">User</span> <span class="kd">implements</span> <span class="nc">Serializable</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="kt">int</span> <span class="n">userId</span><span class="o">;</span>

    <span class="kd">private</span> <span class="nc">String</span> <span class="n">userName</span><span class="o">;</span>

    <span class="kd">private</span> <span class="nc">String</span> <span class="n">userPassword</span><span class="o">;</span>

    <span class="kd">public</span> <span class="nf">User</span><span class="o">(</span><span class="kt">int</span> <span class="n">userId</span><span class="o">,</span> <span class="nc">String</span> <span class="n">userName</span><span class="o">,</span> <span class="nc">String</span> <span class="n">userPassword</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">userId</span> <span class="o">=</span> <span class="n">userId</span><span class="o">;</span>
        <span class="k">this</span><span class="o">.</span><span class="na">userName</span> <span class="o">=</span> <span class="n">userName</span><span class="o">;</span>
        <span class="k">this</span><span class="o">.</span><span class="na">userPassword</span> <span class="o">=</span> <span class="n">userPassword</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></table></code></div></div><p>service简单操作</p><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
</pre><td class="rouge-code"><pre><span class="nd">@Service</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">UserDao</span> <span class="o">{</span>

    <span class="kd">public</span> <span class="nc">User</span> <span class="nf">getUser</span><span class="o">(</span><span class="kt">int</span> <span class="n">userId</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"执行此方法，说明没有缓存，如果没有走到这里，就说明缓存成功了"</span><span class="o">);</span>
        <span class="nc">User</span> <span class="n">user</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">User</span><span class="o">(</span><span class="n">userId</span><span class="o">,</span> <span class="s">"没有缓存_"</span><span class="o">+</span><span class="n">userId</span><span class="o">,</span> <span class="s">"password_"</span><span class="o">+</span><span class="n">userId</span><span class="o">);</span>
        <span class="k">return</span> <span class="n">user</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="nc">User</span> <span class="nf">getUser2</span><span class="o">(</span><span class="kt">int</span> <span class="n">userId</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"执行此方法，说明没有缓存，如果没有走到这里，就说明缓存成功了"</span><span class="o">);</span>
        <span class="nc">User</span> <span class="n">user</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">User</span><span class="o">(</span><span class="n">userId</span><span class="o">,</span> <span class="s">"name_nocache"</span><span class="o">+</span><span class="n">userId</span><span class="o">,</span> <span class="s">"nocache"</span><span class="o">);</span>
        <span class="k">return</span> <span class="n">user</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></table></code></div></div><p>控制层</p><p>在方法上添加相应的方法即可操作缓存了，SpringCache 对象可以对redis自行操作，减少了很多工作啊，还是那个开箱即用的Spring</p><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
</pre><td class="rouge-code"><pre><span class="nd">@RestController</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">testController</span> <span class="o">{</span>
    <span class="nd">@Resource</span>
    <span class="kd">private</span> <span class="nc">UserDao</span> <span class="n">userDao</span><span class="o">;</span>

    <span class="cm">/**
     * 查询出一条数据并且添加到缓存
     *
     * @param userId
     * @return
     */</span>
    <span class="nd">@RequestMapping</span><span class="o">(</span><span class="s">"/getUser"</span><span class="o">)</span>
    <span class="nd">@Cacheable</span><span class="o">(</span><span class="s">"userCache"</span><span class="o">)</span>
    <span class="kd">public</span> <span class="nc">User</span> <span class="nf">getPrud</span><span class="o">(</span><span class="nd">@RequestParam</span><span class="o">(</span><span class="n">required</span> <span class="o">=</span> <span class="kc">true</span><span class="o">)</span> <span class="nc">String</span> <span class="n">userId</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"如果没有缓存，就会调用下面方法，如果有缓存，则直接输出，不会输出此段话"</span><span class="o">);</span>
        <span class="k">return</span> <span class="n">userDao</span><span class="o">.</span><span class="na">getUser</span><span class="o">(</span><span class="nc">Integer</span><span class="o">.</span><span class="na">parseInt</span><span class="o">(</span><span class="n">userId</span><span class="o">));</span>
    <span class="o">}</span>

    <span class="cm">/**
     * 删除一个缓存
     *
     * @param userId
     * @return
     */</span>
    <span class="nd">@RequestMapping</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">"/deleteUser"</span><span class="o">)</span>
    <span class="nd">@CacheEvict</span><span class="o">(</span><span class="s">"userCache"</span><span class="o">)</span>
    <span class="kd">public</span> <span class="nc">String</span> <span class="nf">deleteUser</span><span class="o">(</span><span class="nd">@RequestParam</span><span class="o">(</span><span class="n">required</span> <span class="o">=</span> <span class="kc">true</span><span class="o">)</span> <span class="nc">String</span> <span class="n">userId</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="s">"删除成功"</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="cm">/**
     * 添加一条保存的数据到缓存，缓存的key是当前user的id
     *
     * @param user
     * @return
     */</span>
    <span class="nd">@RequestMapping</span><span class="o">(</span><span class="s">"/saveUser"</span><span class="o">)</span>
    <span class="nd">@CachePut</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">"userCache"</span><span class="o">,</span> <span class="n">key</span> <span class="o">=</span> <span class="s">"#result.userId +''"</span><span class="o">)</span>
    <span class="kd">public</span> <span class="nc">User</span> <span class="nf">saveUser</span><span class="o">(</span><span class="nc">User</span> <span class="n">user</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">user</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="cm">/**
     * 返回结果userPassword中含有nocache字符串就不缓存
     *
     * @param userId
     * @return
     */</span>
    <span class="nd">@RequestMapping</span><span class="o">(</span><span class="s">"/getUser2"</span><span class="o">)</span>
    <span class="nd">@CachePut</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">"userCache"</span><span class="o">,</span> <span class="n">unless</span> <span class="o">=</span> <span class="s">"#result.userPassword.contains('nocache')"</span><span class="o">)</span>
    <span class="kd">public</span> <span class="nc">User</span> <span class="nf">getUser2</span><span class="o">(</span><span class="nd">@RequestParam</span><span class="o">(</span><span class="n">required</span> <span class="o">=</span> <span class="kc">true</span><span class="o">)</span> <span class="nc">String</span> <span class="n">userId</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"如果走到这里说明，说明缓存没有生效！"</span><span class="o">);</span>
        <span class="nc">User</span> <span class="n">user</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">User</span><span class="o">(</span><span class="nc">Integer</span><span class="o">.</span><span class="na">parseInt</span><span class="o">(</span><span class="n">userId</span><span class="o">),</span> <span class="s">"name_nocache"</span> <span class="o">+</span> <span class="n">userId</span><span class="o">,</span> <span class="s">"nocache"</span><span class="o">);</span>
        <span class="k">return</span> <span class="n">user</span><span class="o">;</span>
    <span class="o">}</span>


    <span class="nd">@RequestMapping</span><span class="o">(</span><span class="s">"/getUser3"</span><span class="o">)</span>
    <span class="nd">@Cacheable</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">"userCache"</span><span class="o">,</span> <span class="n">key</span> <span class="o">=</span> <span class="s">"#root.targetClass.getName() + #root.methodName + #userId"</span><span class="o">)</span>
    <span class="kd">public</span> <span class="nc">User</span> <span class="nf">getUser3</span><span class="o">(</span><span class="nd">@RequestParam</span><span class="o">(</span><span class="n">required</span> <span class="o">=</span> <span class="kc">true</span><span class="o">)</span> <span class="nc">String</span> <span class="n">userId</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"如果第二次没有走到这里说明缓存被添加了"</span><span class="o">);</span>
        <span class="k">return</span> <span class="n">userDao</span><span class="o">.</span><span class="na">getUser</span><span class="o">(</span><span class="nc">Integer</span><span class="o">.</span><span class="na">parseInt</span><span class="o">(</span><span class="n">userId</span><span class="o">));</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></table></code></div></div><h1 id="spring-data-redis">Spring Data Redis</h1><h2 id="引入依赖"><span class="mr-2">引入依赖</span><a href="#引入依赖" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><div class="language-xml highlighter-rouge"><div class="code-header"> <span data-label-text="XML"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
</pre><td class="rouge-code"><pre><span class="nt">&lt;dependencies&gt;</span>
    <span class="nt">&lt;dependency&gt;</span>
        <span class="nt">&lt;groupId&gt;</span>org.springframework.boot<span class="nt">&lt;/groupId&gt;</span>
        <span class="nt">&lt;artifactId&gt;</span>spring-boot-starter-data-redis<span class="nt">&lt;/artifactId&gt;</span>
    <span class="nt">&lt;/dependency&gt;</span>
    <span class="nt">&lt;dependency&gt;</span>
        <span class="nt">&lt;groupId&gt;</span>org.springframework.boot<span class="nt">&lt;/groupId&gt;</span>
        <span class="nt">&lt;artifactId&gt;</span>spring-boot-starter-web<span class="nt">&lt;/artifactId&gt;</span>
    <span class="nt">&lt;/dependency&gt;</span>
<span class="nt">&lt;/dependencies&gt;</span>
<span class="nt">&lt;dependency&gt;</span>
    <span class="nt">&lt;groupId&gt;</span>org.apache.commons<span class="nt">&lt;/groupId&gt;</span>
    <span class="nt">&lt;artifactId&gt;</span>commons-pool2<span class="nt">&lt;/artifactId&gt;</span>
<span class="nt">&lt;/dependency&gt;</span>
</pre></table></code></div></div><p>这里主要就是引入了 Spring Data Redis + 连接池。</p><h2 id="配置-redis-信息"><span class="mr-2">配置 Redis 信息</span><a href="#配置-redis-信息" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><div file="application.yml" class="language-yml highlighter-rouge"><div class="code-header"> <span data-label-text="application.yml"><i class="far fa-file-code"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
</pre><td class="rouge-code"><pre><span class="na">spring</span><span class="pi">:</span>
  <span class="c1"># redis相关配置</span>
  <span class="na">redis</span><span class="pi">:</span>
    <span class="na">database</span><span class="pi">:</span> <span class="m">0</span>
    <span class="na">host</span><span class="pi">:</span> <span class="s">localhost</span>
    <span class="na">port</span><span class="pi">:</span> <span class="m">6379</span>
    <span class="na">password</span><span class="pi">:</span> <span class="err">******</span>
    <span class="na">jedis</span><span class="pi">:</span>
      <span class="na">pool</span><span class="pi">:</span>
        <span class="c1"># 连接池最大连接数（使用负值表示没有限制）</span>
        <span class="na">max-active</span><span class="pi">:</span> <span class="m">8</span>
        <span class="c1"># 连接池最大阻塞等待时间（使用负值表示没有限制）</span>
        <span class="na">max-wait</span><span class="pi">:</span> <span class="s">-1ms</span>
        <span class="c1"># 连接池中的最大空闲连接</span>
        <span class="na">max-idle</span><span class="pi">:</span> <span class="m">8</span>
        <span class="c1"># 连接池中的最小空闲连接</span>
        <span class="na">min-idle</span><span class="pi">:</span> <span class="m">0</span>
    <span class="c1"># 连接超时时间（毫秒）默认是2000ms</span>
    <span class="na">timeout</span><span class="pi">:</span> <span class="s">2000ms</span>
</pre></table></code></div></div><h2 id="自动配置"><span class="mr-2">自动配置</span><a href="#自动配置" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><p>当开发者在项目中引入了 Spring Data Redis ，并且配置了 Redis 的基本信息，此时，自动化配置就会生效。</p><p>我们从 Spring Boot 中 Redis 的自动化配置类中就可以看出端倪：</p><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
</pre><td class="rouge-code"><pre><span class="nd">@Configuration</span>
<span class="nd">@ConditionalOnClass</span><span class="o">(</span><span class="nc">RedisOperations</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
<span class="nd">@EnableConfigurationProperties</span><span class="o">(</span><span class="nc">RedisProperties</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
<span class="nd">@Import</span><span class="o">({</span> <span class="nc">LettuceConnectionConfiguration</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="nc">JedisConnectionConfiguration</span><span class="o">.</span><span class="na">class</span> <span class="o">})</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">RedisAutoConfiguration</span> <span class="o">{</span>
        <span class="nd">@Bean</span>
        <span class="nd">@ConditionalOnMissingBean</span><span class="o">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">"redisTemplate"</span><span class="o">)</span>
        <span class="kd">public</span> <span class="nc">RedisTemplate</span><span class="o">&lt;</span><span class="nc">Object</span><span class="o">,</span> <span class="nc">Object</span><span class="o">&gt;</span> <span class="nf">redisTemplate</span><span class="o">(</span>
                        <span class="nc">RedisConnectionFactory</span> <span class="n">redisConnectionFactory</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">UnknownHostException</span> <span class="o">{</span>
                <span class="nc">RedisTemplate</span><span class="o">&lt;</span><span class="nc">Object</span><span class="o">,</span> <span class="nc">Object</span><span class="o">&gt;</span> <span class="n">template</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">RedisTemplate</span><span class="o">&lt;&gt;();</span>
                <span class="n">template</span><span class="o">.</span><span class="na">setConnectionFactory</span><span class="o">(</span><span class="n">redisConnectionFactory</span><span class="o">);</span>
                <span class="k">return</span> <span class="n">template</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="nd">@Bean</span>
        <span class="nd">@ConditionalOnMissingBean</span>
        <span class="kd">public</span> <span class="nc">StringRedisTemplate</span> <span class="nf">stringRedisTemplate</span><span class="o">(</span>
                        <span class="nc">RedisConnectionFactory</span> <span class="n">redisConnectionFactory</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">UnknownHostException</span> <span class="o">{</span>
                <span class="nc">StringRedisTemplate</span> <span class="n">template</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">StringRedisTemplate</span><span class="o">();</span>
                <span class="n">template</span><span class="o">.</span><span class="na">setConnectionFactory</span><span class="o">(</span><span class="n">redisConnectionFactory</span><span class="o">);</span>
                <span class="k">return</span> <span class="n">template</span><span class="o">;</span>
        <span class="o">}</span>
<span class="o">}</span>
</pre></table></code></div></div><p>这个自动化配置类很好理解：</p><ul><li>首先标记这个是一个配置类，同时该配置在 RedisOperations 存在的情况下才会生效(即项目中引入了 Spring Data Redis)<li>然后导入在 application.properties 中配置的属性<li>然后再导入连接池信息（如果存在的话）<li>最后，提供了两个 Bean ，RedisTemplate 和 StringRedisTemplate ，其中 StringRedisTemplate 是 RedisTemplate 的子类，两个的方法基本一致，不同之处主要体现在操作的数据类型不同，RedisTemplate 中的两个泛型都是 Object ，意味者存储的 key 和 value 都可以是一个对象，而 StringRedisTemplate 的 两个泛型都是 String ，意味者 StringRedisTemplate 的 key 和 value 都只能是字符串。如果开发者没有提供相关的 Bean ，这两个配置就会生效，否则不会生效。</ul><h2 id="使用"><span class="mr-2">使用</span><a href="#使用" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><p>接下来，可以直接在 Service 中注入 StringRedisTemplate 或者 RedisTemplate 来使用：</p><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
</pre><td class="rouge-code"><pre><span class="nd">@Service</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">HelloService</span> <span class="o">{</span>
    <span class="nd">@Autowired</span>
    <span class="nc">RedisTemplate</span> <span class="n">redisTemplate</span><span class="o">;</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">hello</span><span class="o">()</span> <span class="o">{</span>
        <span class="nc">ValueOperations</span> <span class="n">ops</span> <span class="o">=</span> <span class="n">redisTemplate</span><span class="o">.</span><span class="na">opsForValue</span><span class="o">();</span>
        <span class="n">ops</span><span class="o">.</span><span class="na">set</span><span class="o">(</span><span class="s">"k1"</span><span class="o">,</span> <span class="s">"v1"</span><span class="o">);</span>
        <span class="nc">Object</span> <span class="n">k1</span> <span class="o">=</span> <span class="n">ops</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">"k1"</span><span class="o">);</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">k1</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></table></code></div></div><p>Redis 中的数据操作，大体上来说，可以分为两种：</p><ul><li>针对 key 的操作，相关的方法就在 RedisTemplate 中<li>针对具体数据类型的操作，相关的方法需要首先获取对应的数据类型，获取相应数据类型的操作方法是 opsForXXX</ul><p>RedisTemplate 中，key 默认的序列化方案是 JdkSerializationRedisSerializer 。</p><p>而在 StringRedisTemplate 中，key 默认的序列化方案是 StringRedisSerializer ，因此，如果使用 StringRedisTemplate ，默认情况下 key 前面不会有前缀。</p><p>不过开发者也可以自行修改 RedisTemplate 中的序列化方案，如下:</p><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
</pre><td class="rouge-code"><pre><span class="nd">@Service</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">HelloService</span> <span class="o">{</span>
    <span class="nd">@Autowired</span>
    <span class="nc">RedisTemplate</span> <span class="n">redisTemplate</span><span class="o">;</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">hello</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">redisTemplate</span><span class="o">.</span><span class="na">setKeySerializer</span><span class="o">(</span><span class="k">new</span> <span class="nc">StringRedisSerializer</span><span class="o">());</span>
        <span class="nc">ValueOperations</span> <span class="n">ops</span> <span class="o">=</span> <span class="n">redisTemplate</span><span class="o">.</span><span class="na">opsForValue</span><span class="o">();</span>
        <span class="n">ops</span><span class="o">.</span><span class="na">set</span><span class="o">(</span><span class="s">"k1"</span><span class="o">,</span> <span class="s">"v1"</span><span class="o">);</span>
        <span class="nc">Object</span> <span class="n">k1</span> <span class="o">=</span> <span class="n">ops</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">"k1"</span><span class="o">);</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">k1</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></table></code></div></div><p>当然也可以直接使用 StringRedisTemplate：</p><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
</pre><td class="rouge-code"><pre><span class="nd">@Service</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">HelloService</span> <span class="o">{</span>
    <span class="nd">@Autowired</span>
    <span class="nc">StringRedisTemplate</span> <span class="n">stringRedisTemplate</span><span class="o">;</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">hello2</span><span class="o">()</span> <span class="o">{</span>
        <span class="nc">ValueOperations</span> <span class="n">ops</span> <span class="o">=</span> <span class="n">stringRedisTemplate</span><span class="o">.</span><span class="na">opsForValue</span><span class="o">();</span>
        <span class="n">ops</span><span class="o">.</span><span class="na">set</span><span class="o">(</span><span class="s">"k2"</span><span class="o">,</span> <span class="s">"v2"</span><span class="o">);</span>
        <span class="nc">Object</span> <span class="n">k1</span> <span class="o">=</span> <span class="n">ops</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">"k2"</span><span class="o">);</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">k1</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></table></code></div></div><p>另外需要注意 ，Spring Boot 的自动化配置，只能配置单机的 Redis ，如果是 Redis 集群，则所有的东西都需要自己手动配置</p><h1 id="spring-session">Spring Session</h1><h2 id="引入依赖-1"><span class="mr-2">引入依赖</span><a href="#引入依赖-1" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><p>pom 需要引入 redis 和 session 的依赖</p><div class="language-xml highlighter-rouge"><div class="code-header"> <span data-label-text="XML"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
</pre><td class="rouge-code"><pre><span class="nt">&lt;dependency&gt;</span>
    <span class="nt">&lt;groupId&gt;</span>org.springframework.boot<span class="nt">&lt;/groupId&gt;</span>
    <span class="nt">&lt;artifactId&gt;</span>spring-boot-starter-data-redis<span class="nt">&lt;/artifactId&gt;</span>
<span class="nt">&lt;/dependency&gt;</span>
<span class="nt">&lt;dependency&gt;</span>
    <span class="nt">&lt;groupId&gt;</span>org.springframework.session<span class="nt">&lt;/groupId&gt;</span>
    <span class="nt">&lt;artifactId&gt;</span>spring-session-data-redis<span class="nt">&lt;/artifactId&gt;</span>
<span class="nt">&lt;/dependency&gt;</span>
<span class="nt">&lt;dependency&gt;</span>
    <span class="nt">&lt;groupId&gt;</span>org.springframework.boot<span class="nt">&lt;/groupId&gt;</span>
    <span class="nt">&lt;artifactId&gt;</span>spring-boot-starter-web<span class="nt">&lt;/artifactId&gt;</span>
<span class="nt">&lt;/dependency&gt;</span>
</pre></table></code></div></div><h2 id="配置"><span class="mr-2">配置</span><a href="#配置" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><div file="application.properties" class="language-properties highlighter-rouge"><div class="code-header"> <span data-label-text="application.properties"><i class="far fa-file-code"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre><span class="py">spring.redis.host</span><span class="p">=</span><span class="s">localhost</span>
<span class="py">spring.redis.port</span><span class="p">=</span><span class="s">6379</span>
<span class="py">spring.redis.password</span><span class="p">=</span><span class="s">Redis.127</span>
<span class="c"># session存储类型使用redis
</span><span class="py">spring.session.store-type</span><span class="p">=</span><span class="s">redis</span>
</pre></table></code></div></div><p>启动类添加 @EnableRedisHttpSession 注解</p><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre><td class="rouge-code"><pre><span class="nd">@SpringBootApplication</span>
<span class="nd">@EnableRedisHttpSession</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">CoreApplication</span> <span class="o">{</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">SpringApplication</span><span class="o">.</span><span class="na">run</span><span class="o">(</span><span class="nc">CoreApplication</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">args</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></table></code></div></div><h2 id="测试"><span class="mr-2">测试</span><a href="#测试" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><ol><li>启动两个或以上服务，端口分别为8080，8081……<li>分别调用：http://127.0.0.1:8080/getSessionId,http://127.0.0.1:8081/getSessionId</ol><p>若sessionId是一样的，redis里也存在同样的session信息，以上，说明session共享已完成。</p><h1 id="直接使用-redis-客户端">直接使用 Redis 客户端</h1><h2 id="lettuce-集成-redis-服务"><span class="mr-2">Lettuce 集成 Redis 服务</span><a href="#lettuce-集成-redis-服务" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><h3 id="依赖和配置"><span class="mr-2">依赖和配置</span><a href="#依赖和配置" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><blockquote class="prompt-tip"><div><p>由于 Spring Boot 2.X 默认集成了 Lettuce ，所以无需导入依赖。</p></div></blockquote><div file="application.properties" class="language-properties highlighter-rouge"><div class="code-header"> <span data-label-text="application.properties"><i class="far fa-file-code"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
</pre><td class="rouge-code"><pre><span class="c">################ Redis 基础配置 ##############
# Redis数据库索引（默认为0）
</span><span class="py">spring.redis.database</span><span class="p">=</span><span class="s">0  </span>
<span class="c"># Redis服务器地址
</span><span class="py">spring.redis.host</span><span class="p">=</span><span class="s">127.0.0.1</span>
<span class="c"># Redis服务器连接端口
</span><span class="py">spring.redis.port</span><span class="p">=</span><span class="s">6379  </span>
<span class="c"># Redis服务器连接密码（默认为空）
</span><span class="py">spring.redis.password</span><span class="p">=</span><span class="s">*********</span>
<span class="c"># 链接超时时间 单位 ms（毫秒）
</span><span class="py">spring.redis.timeout</span><span class="p">=</span><span class="s">3000</span>
<span class="c">################ Redis 线程池设置 ##############
# 连接池最大连接数（使用负值表示没有限制） 默认 8
</span><span class="py">spring.redis.lettuce.pool.max-active</span><span class="p">=</span><span class="s">8</span>
<span class="c"># 连接池最大阻塞等待时间（使用负值表示没有限制） 默认 -1
</span><span class="py">spring.redis.lettuce.pool.max-wait</span><span class="p">=</span><span class="s">-1</span>
<span class="c"># 连接池中的最大空闲连接 默认 8
</span><span class="py">spring.redis.lettuce.pool.max-idle</span><span class="p">=</span><span class="s">8</span>
<span class="c"># 连接池中的最小空闲连接 默认 0
</span><span class="py">spring.redis.lettuce.pool.min-idle</span><span class="p">=</span><span class="s">0</span>
</pre></table></code></div></div><h3 id="自定义-redistemplate"><span class="mr-2">自定义 RedisTemplate</span><a href="#自定义-redistemplate" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><p>默认情况下的模板只能支持 RedisTemplate&lt;String,String&gt;，只能存入字符串，很多时候，我们需要自定义 RedisTemplate ，设置序列化器，这样我们可以很方便的操作实例对象。如下所示：</p><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
</pre><td class="rouge-code"><pre><span class="nd">@Configuration</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">LettuceRedisConfig</span> <span class="o">{</span>

	<span class="nd">@Bean</span>
	<span class="kd">public</span> <span class="nc">RedisTemplate</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">Serializable</span><span class="o">&gt;</span> <span class="nf">redisTemplate</span><span class="o">(</span><span class="nc">LettuceConnectionFactory</span> <span class="n">connectionFactory</span><span class="o">)</span> <span class="o">{</span>
		<span class="nc">RedisTemplate</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">Serializable</span><span class="o">&gt;</span> <span class="n">redisTemplate</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">RedisTemplate</span><span class="o">&lt;&gt;();</span>
		<span class="n">redisTemplate</span><span class="o">.</span><span class="na">setKeySerializer</span><span class="o">(</span><span class="k">new</span> <span class="nc">StringRedisSerializer</span><span class="o">());</span>
		<span class="n">redisTemplate</span><span class="o">.</span><span class="na">setValueSerializer</span><span class="o">(</span><span class="k">new</span> <span class="nc">GenericJackson2JsonRedisSerializer</span><span class="o">());</span>
		<span class="n">redisTemplate</span><span class="o">.</span><span class="na">setConnectionFactory</span><span class="o">(</span><span class="n">connectionFactory</span><span class="o">);</span>
		<span class="k">return</span> <span class="n">redisTemplate</span><span class="o">;</span>
	<span class="o">}</span>
<span class="o">}</span>
</pre></table></code></div></div><h3 id="序列化实体类"><span class="mr-2">序列化实体类</span><a href="#序列化实体类" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
</pre><td class="rouge-code"><pre><span class="kd">public</span> <span class="kd">class</span> <span class="nc">UserEntity</span> <span class="kd">implements</span> <span class="nc">Serializable</span> <span class="o">{</span>
	<span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">long</span> <span class="n">serialVersionUID</span> <span class="o">=</span> <span class="mi">6455431221321343103305078L</span><span class="o">;</span>
	
	<span class="kd">private</span> <span class="nc">Long</span> <span class="n">id</span><span class="o">;</span>
	<span class="kd">private</span> <span class="nc">String</span> <span class="n">userName</span><span class="o">;</span>
	<span class="kd">private</span> <span class="nc">String</span> <span class="n">userSex</span><span class="o">;</span>
	<span class="kd">public</span> <span class="nc">Long</span> <span class="nf">getId</span><span class="o">()</span> <span class="o">{</span>
		<span class="k">return</span> <span class="n">id</span><span class="o">;</span>
	<span class="o">}</span>
	<span class="kd">public</span> <span class="kt">void</span> <span class="nf">setId</span><span class="o">(</span><span class="nc">Long</span> <span class="n">id</span><span class="o">)</span> <span class="o">{</span>
		<span class="k">this</span><span class="o">.</span><span class="na">id</span> <span class="o">=</span> <span class="n">id</span><span class="o">;</span>
	<span class="o">}</span>
	<span class="kd">public</span> <span class="nc">String</span> <span class="nf">getUserName</span><span class="o">()</span> <span class="o">{</span>
		<span class="k">return</span> <span class="n">userName</span><span class="o">;</span>
	<span class="o">}</span>
	<span class="kd">public</span> <span class="kt">void</span> <span class="nf">setUserName</span><span class="o">(</span><span class="nc">String</span> <span class="n">userName</span><span class="o">)</span> <span class="o">{</span>
		<span class="k">this</span><span class="o">.</span><span class="na">userName</span> <span class="o">=</span> <span class="n">userName</span><span class="o">;</span>
	<span class="o">}</span>
	<span class="kd">public</span> <span class="nc">String</span> <span class="nf">getUserSex</span><span class="o">()</span> <span class="o">{</span>
		<span class="k">return</span> <span class="n">userSex</span><span class="o">;</span>
	<span class="o">}</span>
<span class="o">}</span>
</pre></table></code></div></div><h3 id="测试-1"><span class="mr-2">测试</span><a href="#测试-1" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
</pre><td class="rouge-code"><pre><span class="nd">@RunWith</span><span class="o">(</span><span class="nc">SpringRunner</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
<span class="nd">@SpringBootTest</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">SpringBootRedisApplicationTests</span> <span class="o">{</span>

	<span class="nd">@Autowired</span>
	<span class="kd">private</span> <span class="nc">RedisTemplate</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">String</span><span class="o">&gt;</span> <span class="n">strRedisTemplate</span><span class="o">;</span>
	<span class="nd">@Autowired</span>
	<span class="kd">private</span> <span class="nc">RedisTemplate</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">Serializable</span><span class="o">&gt;</span> <span class="n">serializableRedisTemplate</span><span class="o">;</span>
	
	<span class="nd">@Test</span>
	<span class="kd">public</span> <span class="kt">void</span> <span class="nf">testString</span><span class="o">()</span> <span class="o">{</span>
		<span class="n">strRedisTemplate</span><span class="o">.</span><span class="na">opsForValue</span><span class="o">().</span><span class="na">set</span><span class="o">(</span><span class="s">"strKey"</span><span class="o">,</span> <span class="s">"Opt"</span><span class="o">);</span>
		<span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">strRedisTemplate</span><span class="o">.</span><span class="na">opsForValue</span><span class="o">().</span><span class="na">get</span><span class="o">(</span><span class="s">"strKey"</span><span class="o">));</span>
	<span class="o">}</span>
	
	<span class="nd">@Test</span>
	<span class="kd">public</span> <span class="kt">void</span> <span class="nf">testSerializable</span><span class="o">()</span> <span class="o">{</span>
		<span class="nc">UserEntity</span> <span class="n">user</span><span class="o">=</span><span class="k">new</span> <span class="nc">UserEntity</span><span class="o">();</span>
		<span class="n">user</span><span class="o">.</span><span class="na">setId</span><span class="o">(</span><span class="mi">1L</span><span class="o">);</span>
		<span class="n">user</span><span class="o">.</span><span class="na">setUserName</span><span class="o">(</span><span class="s">"Optimus"</span><span class="o">);</span>
		<span class="n">user</span><span class="o">.</span><span class="na">setUserSex</span><span class="o">(</span><span class="s">"男"</span><span class="o">);</span>		
		<span class="n">serializableRedisTemplate</span><span class="o">.</span><span class="na">opsForValue</span><span class="o">().</span><span class="na">set</span><span class="o">(</span><span class="s">"user"</span><span class="o">,</span> <span class="n">user</span><span class="o">);</span>		
		<span class="nc">UserEntity</span> <span class="n">user2</span> <span class="o">=</span> <span class="o">(</span><span class="nc">UserEntity</span><span class="o">)</span> <span class="n">serializableRedisTemplate</span><span class="o">.</span><span class="na">opsForValue</span><span class="o">().</span><span class="na">get</span><span class="o">(</span><span class="s">"user"</span><span class="o">);</span>
		<span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"user:"</span><span class="o">+</span><span class="n">user2</span><span class="o">.</span><span class="na">getId</span><span class="o">()+</span><span class="s">","</span><span class="o">+</span><span class="n">user2</span><span class="o">.</span><span class="na">getUserName</span><span class="o">()+</span><span class="s">","</span><span class="o">+</span><span class="n">user2</span><span class="o">.</span><span class="na">getUserSex</span><span class="o">());</span>
	<span class="o">}</span>
<span class="o">}</span>
</pre></table></code></div></div><h2 id="jedis-集成-redis-服务"><span class="mr-2">Jedis 集成 Redis 服务</span><a href="#jedis-集成-redis-服务" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><h3 id="导入依赖和配置"><span class="mr-2">导入依赖和配置</span><a href="#导入依赖和配置" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><div class="language-xml highlighter-rouge"><div class="code-header"> <span data-label-text="XML"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
</pre><td class="rouge-code"><pre><span class="nt">&lt;dependency&gt;</span>
			<span class="nt">&lt;groupId&gt;</span>org.springframework.boot<span class="nt">&lt;/groupId&gt;</span>
			<span class="nt">&lt;artifactId&gt;</span>spring-boot-starter-data-redis<span class="nt">&lt;/artifactId&gt;</span>
			<span class="nt">&lt;exclusions&gt;</span>
				<span class="c">&lt;!-- 排除lettuce包 --&gt;</span>
				<span class="nt">&lt;exclusion&gt;</span>
					<span class="nt">&lt;groupId&gt;</span>io.lettuce<span class="nt">&lt;/groupId&gt;</span>
					<span class="nt">&lt;artifactId&gt;</span>lettuce-core<span class="nt">&lt;/artifactId&gt;</span>
				<span class="nt">&lt;/exclusion&gt;</span>
			<span class="nt">&lt;/exclusions&gt;</span>
		<span class="nt">&lt;/dependency&gt;</span>
		<span class="c">&lt;!-- 添加jedis客户端 --&gt;</span>
		<span class="nt">&lt;dependency&gt;</span>
			<span class="nt">&lt;groupId&gt;</span>redis.clients<span class="nt">&lt;/groupId&gt;</span>
			<span class="nt">&lt;artifactId&gt;</span>jedis<span class="nt">&lt;/artifactId&gt;</span>
		<span class="nt">&lt;/dependency&gt;</span>
</pre></table></code></div></div><div file="application.properties" class="language-properties highlighter-rouge"><div class="code-header"> <span data-label-text="application.properties"><i class="far fa-file-code"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
</pre><td class="rouge-code"><pre><span class="c">################ Redis 基础配置 ##############
# Redis数据库索引（默认为0）
</span><span class="py">spring.redis.database</span><span class="p">=</span><span class="s">0  </span>
<span class="c"># Redis服务器地址
</span><span class="py">spring.redis.host</span><span class="p">=</span><span class="s">127.0.0.1</span>
<span class="c"># Redis服务器连接端口
</span><span class="py">spring.redis.port</span><span class="p">=</span><span class="s">6379  </span>
<span class="c"># Redis服务器连接密码（默认为空）
</span><span class="py">spring.redis.password</span><span class="p">=</span><span class="s">**********</span>
<span class="c"># 链接超时时间 单位 ms（毫秒）
</span><span class="py">spring.redis.timeout</span><span class="p">=</span><span class="s">3000</span>
<span class="c">################ Redis 线程池设置 ##############
# 连接池最大连接数（使用负值表示没有限制） 默认 8
</span><span class="py">spring.redis.lettuce.pool.max-active</span><span class="p">=</span><span class="s">8</span>
<span class="c"># 连接池最大阻塞等待时间（使用负值表示没有限制） 默认 -1
</span><span class="py">spring.redis.lettuce.pool.max-wait</span><span class="p">=</span><span class="s">-1</span>
<span class="c"># 连接池中的最大空闲连接 默认 8
</span><span class="py">spring.redis.lettuce.pool.max-idle</span><span class="p">=</span><span class="s">8</span>
<span class="c"># 连接池中的最小空闲连接 默认 0
</span><span class="py">spring.redis.lettuce.pool.min-idle</span><span class="p">=</span><span class="s">0</span>
</pre></table></code></div></div><h3 id="jedisredisconfig"><span class="mr-2">JedisRedisConfig</span><a href="#jedisredisconfig" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
</pre><td class="rouge-code"><pre><span class="nd">@Configuration</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">JedisRedisConfig</span> <span class="o">{</span>

	<span class="nd">@Value</span><span class="o">(</span><span class="s">"${spring.redis.database}"</span><span class="o">)</span>
	<span class="kd">private</span> <span class="kt">int</span> <span class="n">database</span><span class="o">;</span>
	<span class="nd">@Value</span><span class="o">(</span><span class="s">"${spring.redis.host}"</span><span class="o">)</span>
	<span class="kd">private</span> <span class="nc">String</span> <span class="n">host</span><span class="o">;</span>
	<span class="nd">@Value</span><span class="o">(</span><span class="s">"${spring.redis.port}"</span><span class="o">)</span>
	<span class="kd">private</span> <span class="kt">int</span> <span class="n">port</span><span class="o">;</span>
	<span class="nd">@Value</span><span class="o">(</span><span class="s">"${spring.redis.password}"</span><span class="o">)</span>
	<span class="kd">private</span> <span class="nc">String</span> <span class="n">password</span><span class="o">;</span>
	<span class="nd">@Value</span><span class="o">(</span><span class="s">"${spring.redis.timeout}"</span><span class="o">)</span>
	<span class="kd">private</span> <span class="kt">int</span> <span class="n">timeout</span><span class="o">;</span>
	<span class="nd">@Value</span><span class="o">(</span><span class="s">"${spring.redis.jedis.pool.max-active}"</span><span class="o">)</span>
	<span class="kd">private</span> <span class="kt">int</span> <span class="n">maxActive</span><span class="o">;</span>
	<span class="nd">@Value</span><span class="o">(</span><span class="s">"${spring.redis.jedis.pool.max-wait}"</span><span class="o">)</span>
	<span class="kd">private</span> <span class="kt">long</span> <span class="n">maxWaitMillis</span><span class="o">;</span>
	<span class="nd">@Value</span><span class="o">(</span><span class="s">"${spring.redis.jedis.pool.max-idle}"</span><span class="o">)</span>
	<span class="kd">private</span> <span class="kt">int</span> <span class="n">maxIdle</span><span class="o">;</span>
	<span class="nd">@Value</span><span class="o">(</span><span class="s">"${spring.redis.jedis.pool.min-idle}"</span><span class="o">)</span>
	<span class="kd">private</span> <span class="kt">int</span> <span class="n">minIdle</span><span class="o">;</span>

	<span class="cm">/**
	 * 连接池配置信息
	 */</span>

	<span class="nd">@Bean</span>
	<span class="kd">public</span> <span class="nc">JedisPoolConfig</span> <span class="nf">jedisPoolConfig</span><span class="o">()</span> <span class="o">{</span>
		<span class="nc">JedisPoolConfig</span> <span class="n">jedisPoolConfig</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">JedisPoolConfig</span><span class="o">();</span>
		<span class="c1">// 最大连接数</span>
		<span class="n">jedisPoolConfig</span><span class="o">.</span><span class="na">setMaxTotal</span><span class="o">(</span><span class="n">maxActive</span><span class="o">);</span>
		<span class="c1">// 当池内没有可用连接时，最大等待时间</span>
		<span class="n">jedisPoolConfig</span><span class="o">.</span><span class="na">setMaxWaitMillis</span><span class="o">(</span><span class="n">maxWaitMillis</span><span class="o">);</span>
		<span class="c1">// 最大空闲连接数</span>
		<span class="n">jedisPoolConfig</span><span class="o">.</span><span class="na">setMinIdle</span><span class="o">(</span><span class="n">maxIdle</span><span class="o">);</span>
		<span class="c1">// 最小空闲连接数</span>
		<span class="n">jedisPoolConfig</span><span class="o">.</span><span class="na">setMinIdle</span><span class="o">(</span><span class="n">minIdle</span><span class="o">);</span>
		<span class="c1">// 其他属性可以自行添加</span>
		<span class="k">return</span> <span class="n">jedisPoolConfig</span><span class="o">;</span>
	<span class="o">}</span>

	<span class="cm">/**
	 * Jedis 连接
	 * 
	 * @param jedisPoolConfig
	 * @return
	 */</span>
	<span class="nd">@Bean</span>
	<span class="kd">public</span> <span class="nc">JedisConnectionFactory</span> <span class="nf">jedisConnectionFactory</span><span class="o">(</span><span class="nc">JedisPoolConfig</span> <span class="n">jedisPoolConfig</span><span class="o">)</span> <span class="o">{</span>
		<span class="nc">JedisClientConfiguration</span> <span class="n">jedisClientConfiguration</span> <span class="o">=</span> <span class="nc">JedisClientConfiguration</span><span class="o">.</span><span class="na">builder</span><span class="o">().</span><span class="na">usePooling</span><span class="o">()</span>
				<span class="o">.</span><span class="na">poolConfig</span><span class="o">(</span><span class="n">jedisPoolConfig</span><span class="o">).</span><span class="na">and</span><span class="o">().</span><span class="na">readTimeout</span><span class="o">(</span><span class="nc">Duration</span><span class="o">.</span><span class="na">ofMillis</span><span class="o">(</span><span class="n">timeout</span><span class="o">)).</span><span class="na">build</span><span class="o">();</span>
		<span class="nc">RedisStandaloneConfiguration</span> <span class="n">redisStandaloneConfiguration</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">RedisStandaloneConfiguration</span><span class="o">();</span>
		<span class="n">redisStandaloneConfiguration</span><span class="o">.</span><span class="na">setHostName</span><span class="o">(</span><span class="n">host</span><span class="o">);</span>
		<span class="n">redisStandaloneConfiguration</span><span class="o">.</span><span class="na">setPort</span><span class="o">(</span><span class="n">port</span><span class="o">);</span>
		<span class="n">redisStandaloneConfiguration</span><span class="o">.</span><span class="na">setPassword</span><span class="o">(</span><span class="nc">RedisPassword</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="n">password</span><span class="o">));</span>
		<span class="k">return</span> <span class="k">new</span> <span class="nf">JedisConnectionFactory</span><span class="o">(</span><span class="n">redisStandaloneConfiguration</span><span class="o">,</span> <span class="n">jedisClientConfiguration</span><span class="o">);</span>
	<span class="o">}</span>

	<span class="cm">/**
	 * 缓存管理器
	 * 
	 * @param connectionFactory
	 * @return
	 */</span>
	<span class="nd">@Bean</span>
	<span class="kd">public</span> <span class="nc">RedisCacheManager</span> <span class="nf">cacheManager</span><span class="o">(</span><span class="nc">RedisConnectionFactory</span> <span class="n">connectionFactory</span><span class="o">)</span> <span class="o">{</span>
		<span class="k">return</span> <span class="nc">RedisCacheManager</span><span class="o">.</span><span class="na">create</span><span class="o">(</span><span class="n">connectionFactory</span><span class="o">);</span>
	<span class="o">}</span>

	<span class="nd">@Bean</span>
	<span class="kd">public</span> <span class="nc">RedisTemplate</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">Serializable</span><span class="o">&gt;</span> <span class="nf">redisTemplate</span><span class="o">(</span><span class="nc">JedisConnectionFactory</span> <span class="n">connectionFactory</span><span class="o">)</span> <span class="o">{</span>
		<span class="nc">RedisTemplate</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">Serializable</span><span class="o">&gt;</span> <span class="n">redisTemplate</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">RedisTemplate</span><span class="o">&lt;&gt;();</span>
		<span class="n">redisTemplate</span><span class="o">.</span><span class="na">setKeySerializer</span><span class="o">(</span><span class="k">new</span> <span class="nc">StringRedisSerializer</span><span class="o">());</span>
		<span class="n">redisTemplate</span><span class="o">.</span><span class="na">setValueSerializer</span><span class="o">(</span><span class="k">new</span> <span class="nc">GenericJackson2JsonRedisSerializer</span><span class="o">());</span>
		<span class="n">redisTemplate</span><span class="o">.</span><span class="na">setConnectionFactory</span><span class="o">(</span><span class="n">jedisConnectionFactory</span><span class="o">(</span><span class="n">jedisPoolConfig</span><span class="o">()));</span>
		<span class="k">return</span> <span class="n">redisTemplate</span><span class="o">;</span>
	<span class="o">}</span>
<span class="o">}</span>
</pre></table></code></div></div><h3 id="测试-2"><span class="mr-2">测试</span><a href="#测试-2" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
</pre><td class="rouge-code"><pre><span class="nd">@RunWith</span><span class="o">(</span><span class="nc">SpringRunner</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
<span class="nd">@SpringBootTest</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">SpringBootRedisApplicationTests</span> <span class="o">{</span>

	<span class="nd">@Autowired</span>
	<span class="kd">private</span> <span class="nc">RedisTemplate</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">String</span><span class="o">&gt;</span> <span class="n">strRedisTemplate</span><span class="o">;</span>
	<span class="nd">@Autowired</span>
	<span class="kd">private</span> <span class="nc">RedisTemplate</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">Serializable</span><span class="o">&gt;</span> <span class="n">serializableRedisTemplate</span><span class="o">;</span>
	
	<span class="nd">@Test</span>
	<span class="kd">public</span> <span class="kt">void</span> <span class="nf">testString</span><span class="o">()</span> <span class="o">{</span>
		<span class="n">strRedisTemplate</span><span class="o">.</span><span class="na">opsForValue</span><span class="o">().</span><span class="na">set</span><span class="o">(</span><span class="s">"strKey"</span><span class="o">,</span> <span class="s">"Opt"</span><span class="o">);</span>
		<span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">strRedisTemplate</span><span class="o">.</span><span class="na">opsForValue</span><span class="o">().</span><span class="na">get</span><span class="o">(</span><span class="s">"strKey"</span><span class="o">));</span>
	<span class="o">}</span>
	
	<span class="nd">@Test</span>
	<span class="kd">public</span> <span class="kt">void</span> <span class="nf">testSerializable</span><span class="o">()</span> <span class="o">{</span>
		<span class="nc">UserEntity</span> <span class="n">user</span><span class="o">=</span><span class="k">new</span> <span class="nc">UserEntity</span><span class="o">();</span>
		<span class="n">user</span><span class="o">.</span><span class="na">setId</span><span class="o">(</span><span class="mi">1L</span><span class="o">);</span>
		<span class="n">user</span><span class="o">.</span><span class="na">setUserName</span><span class="o">(</span><span class="s">"Optimus"</span><span class="o">);</span>
		<span class="n">user</span><span class="o">.</span><span class="na">setUserSex</span><span class="o">(</span><span class="s">"男"</span><span class="o">);</span>		
		<span class="n">serializableRedisTemplate</span><span class="o">.</span><span class="na">opsForValue</span><span class="o">().</span><span class="na">set</span><span class="o">(</span><span class="s">"user"</span><span class="o">,</span> <span class="n">user</span><span class="o">);</span>		
		<span class="nc">UserEntity</span> <span class="n">user2</span> <span class="o">=</span> <span class="o">(</span><span class="nc">UserEntity</span><span class="o">)</span> <span class="n">serializableRedisTemplate</span><span class="o">.</span><span class="na">opsForValue</span><span class="o">().</span><span class="na">get</span><span class="o">(</span><span class="s">"user"</span><span class="o">);</span>
		<span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"user:"</span><span class="o">+</span><span class="n">user2</span><span class="o">.</span><span class="na">getId</span><span class="o">()+</span><span class="s">","</span><span class="o">+</span><span class="n">user2</span><span class="o">.</span><span class="na">getUserName</span><span class="o">()+</span><span class="s">","</span><span class="o">+</span><span class="n">user2</span><span class="o">.</span><span class="na">getUserSex</span><span class="o">());</span>
	<span class="o">}</span>
<span class="o">}</span>
</pre></table></code></div></div></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/software-development/'>Software Development</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/java/" class="post-tag no-text-decoration" >Java</a> <a href="/tags/spring/" class="post-tag no-text-decoration" >Spring</a> <a href="/tags/redis/" class="post-tag no-text-decoration" >Redis</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> 本文由作者按照 <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> 进行授权</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">分享</span> <span class="share-icons"> <a href="https://t.me/share/url?url=https://optimus-xs.github.io/posts/integrate-redis-in-springboot/&amp;text=在 SpringBoot 中集成 Redis - Optimus-Xs&#39; Blog" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <a href="https://www.linkedin.com/sharing/share-offsite/?url=https://optimus-xs.github.io/posts/integrate-redis-in-springboot/" data-toggle="tooltip" data-placement="top" title="Linkedin" target="_blank" rel="noopener" aria-label="Linkedin"> <i class="fa-fw fab fa-linkedin"></i> </a> <i id="copy-link" class="fa-fw fas fa-link small" data-toggle="tooltip" data-placement="top" title="分享链接" data-title-succeed="链接已复制！"> </i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted"><div class="access"><div id="access-lastmod" class="post"><div class="panel-heading">最近更新</div><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/how-to-write-a-dockerfile-elegantly/">如何优雅的编写Dockerfile</a><li><a href="/posts/java-file-io-usage/">Java 文件 IO 使用方法</a><li><a href="/posts/jvm-gc-mechanism/">JVM 的垃圾回收机制</a><li><a href="/posts/docker-engine-installation-on-ubuntu/">在 Ubuntu 上安装 Dockers Engine 流程</a></ul></div><div id="access-tags"><div class="panel-heading">热门标签</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/java/">Java</a> <a class="post-tag" href="/tags/spring/">Spring</a> <a class="post-tag" href="/tags/devdairy/">DevDairy</a> <a class="post-tag" href="/tags/data-structure/">Data Structure</a> <a class="post-tag" href="/tags/%E5%AE%89%E8%A3%85%E6%B5%81%E7%A8%8B/">安装流程</a> <a class="post-tag" href="/tags/geekdairy/">GeekDairy</a> <a class="post-tag" href="/tags/linux/">Linux</a> <a class="post-tag" href="/tags/network/">Network</a> <a class="post-tag" href="/tags/redis/">Redis</a> <a class="post-tag" href="/tags/docker/">Docker</a></div></div></div><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5"><div class="panel-heading pl-3 pt-2 mb-2">文章内容</div><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="tail-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>相关文章</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/why-autowired-not-recommended/"><div class="card-body"> <em class="timeago small" data-ts="1602220140" > 2020-10-09 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>为什么使用 @Autowired 提示不推荐</h3><div class="text-muted small"><p> @Autowired注解相信每个Spring开发者都不陌生了！ 但是当我们使用IDEA写代码的时候，经常会发现@Autowired注解下面是有小黄线的，我们把小鼠标悬停在上面，可以看到这个如下图所示的警告信息： 那么为什么IDEA会给出Field injection is not recommended这样的警告呢？ 下面带着这样的问题，一起来全面的了解下Spring中的三种注入方...</p></div></div></a></div><div class="card"> <a href="/posts/spring-security-usage/"><div class="card-body"> <em class="timeago small" data-ts="1614408060" > 2021-02-27 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>SpringSecurity 使用方法</h3><div class="text-muted small"><p> 简介 Spring Security 是一个相对复杂的安全管理框架，功能比 Shiro 更加强大，权限控制细粒度更高，对 OAuth 2 的支持也更友好。 由于 Spring Security 源自 Spring 家族，因此可以和 Spring 框架无缝整合，特别是 Spring Boot 中提供的自动化配置方案，可以让 Spring Security 的使用更加便捷。 依赖配置 &amp;lt;...</p></div></div></a></div><div class="card"> <a href="/posts/spring-integrate-jwt-auth/"><div class="card-body"> <em class="timeago small" data-ts="1614609960" > 2021-03-01 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>SpringSecurity 集成JWT权限验证</h3><div class="text-muted small"><p> 一般来讲，对于RESTful API都会有认证(Authentication)和授权(Authorization)过程，保证API的安全性。 Authentication指的是确定这个用户的身份，Authorization是确定该用户拥有什么操作权限。 认证方式一般有三种 Basic Authentication 这种方式是直接将用户名和密码放到Header中，使用Autho...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/same-origin-policy-and-how-to-achieve-corss-origin-access/" class="btn btn-outline-primary" prompt="上一篇"><p>同源策略和实现跨域访问的方法</p></a> <a href="/posts/send-email-with-springboot/" class="btn btn-outline-primary" prompt="下一篇"><p>使用 SpringBoot 发送邮件</p></a></div></div></div></div><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center text-muted"><div class="footer-left"><p class="mb-0"> © 2023 <a href="https://github.com/Optimus-Xs">Optimus-Xs</a>. <span data-toggle="tooltip" data-placement="top" title="除非另有说明，本网站上的博客文章均由作者按照知识共享署名 4.0 国际 (CC BY 4.0) 许可协议进行授权。">保留部分权利。</span></p></div><div class="footer-right"><p class="mb-0"> 本站由 <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> 生成，采用 <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> 主题。</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><div id="access-tags"><div class="panel-heading">热门标签</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/java/">Java</a> <a class="post-tag" href="/tags/spring/">Spring</a> <a class="post-tag" href="/tags/devdairy/">DevDairy</a> <a class="post-tag" href="/tags/data-structure/">Data Structure</a> <a class="post-tag" href="/tags/%E5%AE%89%E8%A3%85%E6%B5%81%E7%A8%8B/">安装流程</a> <a class="post-tag" href="/tags/geekdairy/">GeekDairy</a> <a class="post-tag" href="/tags/linux/">Linux</a> <a class="post-tag" href="/tags/network/">Network</a> <a class="post-tag" href="/tags/redis/">Redis</a> <a class="post-tag" href="/tags/docker/">Docker</a></div></div></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">搜索结果为空</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script> <script src="https://cdn.jsdelivr.net/combine/npm/magnific-popup@1/dist/jquery.magnific-popup.min.js,npm/lozad/dist/lozad.min.js,npm/clipboard@2/dist/clipboard.min.js"></script> <script src="https://cdn.jsdelivr.net/combine/npm/dayjs@1/dayjs.min.js,npm/dayjs@1/locale/zh-cn.min.js,npm/dayjs@1/plugin/relativeTime.min.js,npm/dayjs@1/plugin/localizedFormat.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/js/bootstrap.bundle.min.js"></script> <script defer src="/app.js"></script>
