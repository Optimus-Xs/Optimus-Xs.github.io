<!DOCTYPE html><html lang="zh-CN" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="prefer-datetime-locale" content="zh-cn"><meta name="generator" content="Jekyll v4.2.2" /><meta property="og:title" content="Java 反射使用方法" /><meta property="og:locale" content="zh_CN" /><meta name="description" content="反射基础 什么是反射 反射 (Reflection) 是 Java 的特征之一，它允许运行中的 Java 程序获取自身的信息，并且可以操作类或对象的内部属性。" /><meta property="og:description" content="反射基础 什么是反射 反射 (Reflection) 是 Java 的特征之一，它允许运行中的 Java 程序获取自身的信息，并且可以操作类或对象的内部属性。" /><link rel="canonical" href="https://optimus-xs.github.io/posts/java-reflection-usage/" /><meta property="og:url" content="https://optimus-xs.github.io/posts/java-reflection-usage/" /><meta property="og:site_name" content="Optimus-Xs’ Blog" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2020-10-23T15:28:00+08:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="Java 反射使用方法" /><meta name="twitter:site" content="@twitter_username" /><meta name="google-site-verification" content="VWHcsZQRCRLxZT171OOZpP1emj_N4gMlSvgq8UReWz4" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2020-10-23T15:28:00+08:00","datePublished":"2020-10-23T15:28:00+08:00","description":"反射基础 什么是反射 反射 (Reflection) 是 Java 的特征之一，它允许运行中的 Java 程序获取自身的信息，并且可以操作类或对象的内部属性。","headline":"Java 反射使用方法","mainEntityOfPage":{"@type":"WebPage","@id":"https://optimus-xs.github.io/posts/java-reflection-usage/"},"url":"https://optimus-xs.github.io/posts/java-reflection-usage/"}</script><title>Java 反射使用方法 | Optimus-Xs' Blog</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="Optimus-Xs' Blog"><meta name="application-name" content="Optimus-Xs' Blog"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link rel="dns-prefetch" href="https://fonts.gstatic.com" crossorigin><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://cdn.jsdelivr.net" ><link rel="dns-prefetch" href="https://cdn.jsdelivr.net" ><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato&family=Source+Sans+Pro:wght@400;600;700;900&display=swap"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get MODE_ATTR() { return "data-mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } static get ID() { return "mode-toggle"; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } let self = this; /* always follow the system prefers */ this.sysDarkPrefers.addEventListener("change", () => { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.notify(); }); } /* constructor() */ get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode === ModeToggle.DARK_MODE; } get isLightMode() { return this.mode === ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer)) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } setDark() { $('html').attr(ModeToggle.MODE_ATTR, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_ATTR, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_ATTR); sessionStorage.removeItem(ModeToggle.MODE_KEY); } /* Notify another plugins that the theme mode has changed */ notify() { window.postMessage({ direction: ModeToggle.ID, message: this.modeStatus }, "*"); } } /* ModeToggle */ const toggle = new ModeToggle(); function flipMode() { if (toggle.hasMode) { if (toggle.isSysDarkPrefer) { if (toggle.isLightMode) { toggle.clearMode(); } else { toggle.setLight(); } } else { if (toggle.isDarkMode) { toggle.clearMode(); } else { toggle.setDark(); } } } else { if (toggle.isSysDarkPrefer) { toggle.setLight(); } else { toggle.setDark(); } } toggle.notify(); } /* flipMode() */ </script><body data-spy="scroll" data-target="#toc" data-topbar-visible="true"><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" alt="avatar" class="mx-auto"> <img src=" /assets/img/miTu.jpg " alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">Optimus-Xs' Blog</a></div><div class="site-subtitle font-italic">「Think Different」</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>首页</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>分类</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tag ml-xl-3 mr-xl-3 unloaded"></i> <span>标签</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>归档</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info-circle ml-xl-3 mr-xl-3 unloaded"></i> <span>关于</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center align-items-center"> <button class="mode-toggle btn" aria-label="Switch Mode"> <i class="fas fa-adjust"></i> </button> <span class="icon-border"></span> <a href="https://github.com/Optimus-Xs" aria-label="github" target="_blank" rel="noopener"> <i class="fab fa-github"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['Wenlong.Zuo','outlook.com'].join('@')" aria-label="email" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" > <i class="fas fa-rss"></i> </a></div></div><div id="topbar-wrapper" class="row justify-content-center"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/"> 首页 </a> </span> <span>Java 反射使用方法</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> 文章</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="搜索..."> </span> <span id="search-cancel" >取消</span></div></div><div id="main-wrapper"><div id="main"><div class="row"><div id="core-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip>Java 反射使用方法</h1><div class="post-meta text-muted"><div> 作者 <em> <a href="https://github.com/Optimus-Xs">Optimus-Xs</a> </em></div><div class="d-flex"><div> <span> 发表于 <em class="timeago" data-ts="1603438080" data-toggle="tooltip" data-placement="bottom" data-tooltip-df="llll" > 2020-10-23 </em> </span> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="14526 字"> <em>80 分钟</em>阅读</span></div></div></div><div class="post-content"><h1 id="反射基础">反射基础</h1><h2 id="什么是反射"><span class="mr-2">什么是反射</span><a href="#什么是反射" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><p>反射 (Reflection) 是 Java 的特征之一，它允许运行中的 Java 程序获取自身的信息，并且可以操作类或对象的内部属性。</p><p>反射之中包含了一个「反」字，所以想要解释反射就必须先从「正」开始解释。</p><p>一般情况下，我们使用某个类时必定知道它是什么类，是用来做什么的。于是我们直接对这个类进行实例化，之后使用这个类对象进行操作。</p><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre><span class="nc">Apple</span> <span class="n">apple</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Apple</span><span class="o">();</span> <span class="c1">//直接初始化，「正射」</span>
<span class="n">apple</span><span class="o">.</span><span class="na">setPrice</span><span class="o">(</span><span class="mi">4</span><span class="o">);</span>
</pre></table></code></div></div><p>上面这样子进行类对象的初始化，我们可以理解为「正」。</p><p>而反射则是一开始并不知道我要初始化的类对象是什么，自然也无法使用 new 关键字来创建对象了。</p><p>这时候，我们使用 JDK 提供的反射 API 进行反射调用：</p><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre><span class="nc">Class</span> <span class="n">clz</span> <span class="o">=</span> <span class="nc">Class</span><span class="o">.</span><span class="na">forName</span><span class="o">(</span><span class="s">"com.chenshuyi.reflect.Apple"</span><span class="o">);</span>
<span class="nc">Method</span> <span class="n">method</span> <span class="o">=</span> <span class="n">clz</span><span class="o">.</span><span class="na">getMethod</span><span class="o">(</span><span class="s">"setPrice"</span><span class="o">,</span> <span class="kt">int</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
<span class="nc">Constructor</span> <span class="n">constructor</span> <span class="o">=</span> <span class="n">clz</span><span class="o">.</span><span class="na">getConstructor</span><span class="o">();</span>
<span class="nc">Object</span> <span class="n">object</span> <span class="o">=</span> <span class="n">constructor</span><span class="o">.</span><span class="na">newInstance</span><span class="o">();</span>
<span class="n">method</span><span class="o">.</span><span class="na">invoke</span><span class="o">(</span><span class="n">object</span><span class="o">,</span> <span class="mi">4</span><span class="o">);</span>
</pre></table></code></div></div><p>上面两段代码的执行结果，其实是完全一样的。但是其思路完全不一样，第一段代码在未运行时就已经确定了要运行的类（Apple），而第二段代码则是在运行时通过字符串值才得知要运行的类（com.chenshuyi.reflect.Apple）。</p><p>所以说什么是反射？</p><blockquote class="prompt-tip"><div><p>反射就是在运行时才知道要操作的类是什么，并且可以在运行时获取类的完整构造，并调用对应的方法。</p></div></blockquote><p>Oracle 官方对反射的解释是：</p><blockquote><p>Reflection enables Java code to discover information about the fields, methods and constructors of loaded classes, and to use reflected fields, methods, and constructors to operate on their underlying counterparts, within security restrictions.</p><p>The API accommodates applications that need access to either the public members of a target object (based on its runtime class) or the members declared by a given class. It also allows programs to suppress default reflective access control.</p></blockquote><p>简而言之，通过反射，我们可以在运行时获得程序或程序集中每一个类型的成员和成员的信息。程序中一般的对象的类型都是在编译期就确定下来的，而 Java 反射机制可以动态地创建对象并调用其属性，这样的对象的类型在编译期是未知的。所以我们可以通过反射机制直接创建对象，即使这个对象的类型在编译期是未知的。</p><p>反射的核心是 JVM 在运行时才动态加载类或调用方法/访问属性，它不需要事先（写代码的时候或编译期）知道运行对象是谁。</p><p>Java 反射主要提供以下功能：</p><ul><li>在运行时判断任意一个对象所属的类；<li>在运行时构造任意一个类的对象；<li>在运行时判断任意一个类所具有的成员变量和方法（通过反射甚至可以调用private方法）；<li>在运行时调用任意一个对象的方法</ul><blockquote class="prompt-tip"><div><p>重点：是运行时而不是编译时</p></div></blockquote><h2 id="反射的主要用途"><span class="mr-2">反射的主要用途</span><a href="#反射的主要用途" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><p>很多人都认为反射在实际的 Java 开发应用中并不广泛，其实不然。当我们在使用 IDE(如 Eclipse，IDEA)时，当我们输入一个对象或类并想调用它的属性或方法时，一按点号，编译器就会自动列出它的属性或方法，这里就会用到反射。</p><p>反射最重要的用途就是开发各种通用框架。很多框架（比如 Spring）都是配置化的（比如通过 XML 文件配置 Bean），为了保证框架的通用性，它们可能需要根据配置文件加载不同的对象或类，调用不同的方法，这个时候就必须用到反射，运行时动态加载需要加载的对象。</p><p>举一个例子，在运用 Struts 2 框架的开发中我们一般会在 struts.xml 里去配置 Action，比如：</p><div class="language-xml highlighter-rouge"><div class="code-header"> <span data-label-text="XML"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre><td class="rouge-code"><pre><span class="nt">&lt;action</span> <span class="na">name=</span><span class="s">"login"</span>
        <span class="na">class=</span><span class="s">"org.Optimus-Xs.test.action.SimpleLoginAction"</span>
        <span class="na">method=</span><span class="s">"execute"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;result&gt;</span>/shop/shop-index.jsp<span class="nt">&lt;/result&gt;</span>
    <span class="nt">&lt;result</span> <span class="na">name=</span><span class="s">"error"</span><span class="nt">&gt;</span>login.jsp<span class="nt">&lt;/result&gt;</span>
<span class="nt">&lt;/action&gt;</span>
</pre></table></code></div></div><p>配置文件与 Action 建立了一种映射关系，当 View 层发出请求时，请求会被 StrutsPrepareAndExecuteFilter 拦截，然后 StrutsPrepareAndExecuteFilter 会去动态地创建 Action 实例。比如我们请求 login.action，那么 StrutsPrepareAndExecuteFilter就会去解析struts.xml文件，检索action中name为login的Action，并根据class属性创建SimpleLoginAction实例，并用invoke方法来调用execute方法，这个过程离不开反射。</p><p>对与框架开发人员来说，反射虽小但作用非常大，它是各种容器实现的核心。而对于一般的开发者来说，不深入框架开发则用反射用的就会少一点，不过了解一下框架的底层机制有助于丰富自己的编程思想，也是很有益的。</p><h2 id="class类"><span class="mr-2">Class类</span><a href="#class类" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><p>RTIT（Run-Time Type Identification）运行时类型识别。在《Thinking in Java》一书第十四章中有提到，其作用是在运行时识别一个对象的类型和类的信息。主要有两种方式：一种是“传统的”RTTI，它假定我们在编译时已经知道了所有的类型；另一种是“反射”机制，它允许我们在运行时发现和使用类的信息。</p><p>反射就是把java类中的各种成分映射成一个个的Java对象</p><p>例如：一个类有：成员变量、方法、构造方法、包等等信息，利用反射技术可以对一个类进行解剖，把个个组成部分映射成一个个对象。</p><blockquote class="prompt-tip"><div><p>这里我们首先需要理解 Class类，以及类的加载机制； 然后基于此我们如何通过反射获取Class类以及类中的成员变量、方法、构造方法等。</p></div></blockquote><p>Class类，Class类也是一个实实在在的类，存在于JDK的java.lang包中。Class类的实例表示java应用运行时的类(class ans enum)或接口(interface and annotation)（每个java类运行时都在JVM里表现为一个class对象，可通过类名.class、类型.getClass()、Class.forName(“类名”)等方法获取class对象）。数组同样也被映射为class 对象的一个类，所有具有相同元素类型和维数的数组都共享该 Class 对象。基本类型boolean，byte，char，short，int，long，float，double和关键字void同样表现为 class 对象。</p><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
</pre><td class="rouge-code"><pre><span class="kd">public</span> <span class="kd">final</span> <span class="kd">class</span> <span class="nc">Class</span><span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;</span> <span class="kd">implements</span> <span class="n">java</span><span class="o">.</span><span class="na">io</span><span class="o">.</span><span class="na">Serializable</span><span class="o">,</span>
                              <span class="nc">GenericDeclaration</span><span class="o">,</span>
                              <span class="nc">Type</span><span class="o">,</span>
                              <span class="nc">AnnotatedElement</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="no">ANNOTATION</span><span class="o">=</span> <span class="mh">0x00002000</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="no">ENUM</span>      <span class="o">=</span> <span class="mh">0x00004000</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="no">SYNTHETIC</span> <span class="o">=</span> <span class="mh">0x00001000</span><span class="o">;</span>

    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">native</span> <span class="kt">void</span> <span class="nf">registerNatives</span><span class="o">();</span>
    <span class="kd">static</span> <span class="o">{</span>
        <span class="n">registerNatives</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="cm">/*
     * Private constructor. Only the Java Virtual Machine creates Class objects.   //私有构造器，只有JVM才能调用创建Class对象
     * This constructor is not used and prevents the default constructor being
     * generated.
     */</span>
    <span class="kd">private</span> <span class="nf">Class</span><span class="o">(</span><span class="nc">ClassLoader</span> <span class="n">loader</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">// Initialize final field for classLoader.  The initialization value of non-null</span>
        <span class="c1">// prevents future JIT optimizations from assuming this final field is null.</span>
        <span class="n">classLoader</span> <span class="o">=</span> <span class="n">loader</span><span class="o">;</span>
    <span class="o">}</span>
</pre></table></code></div></div><p>到这我们也就可以得出以下几点信息：</p><ul><li>Class类也是类的一种，与class关键字是不一样的。<li>手动编写的类被编译后会产生一个Class对象，其表示的是创建的类的类型信息，而且这个Class对象保存在同名.class的文件中(字节码文件)<li>每个通过关键字class标识的类，在内存中有且只有一个与之对应的Class对象来描述其类型信息，无论创建多少个实例对象，其依据的都是用一个Class对象。<li>Class类只存私有构造函数，因此对应Class对象只能有JVM创建和加载<li>Class类的对象作用是运行时提供或获得某个对象的类型信息，这点对于反射技术很重要(关于反射稍后分析)。</ul><h1 id="反射的api使用">反射的API使用</h1><p>在Java中，Class类与java.lang.reflect类库一起对反射技术进行了全力的支持。在反射包中，我们常用的类主要有Constructor类表示的是Class 对象所表示的类的构造方法，利用它可以在运行时动态创建对象、Field表示Class对象所表示的类的成员变量，通过它可以在运行时动态修改成员变量的属性值(包含private)、Method表示Class对象所表示的类的成员方法，通过它可以动态调用对象的方法(包含private)，下面将对这几个重要类进行分别说明。</p><h2 id="class类对象的获取"><span class="mr-2">Class类对象的获取</span><a href="#class类对象的获取" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><p>在类加载的时候，jvm会创建一个class对象</p><p>class对象是可以说是反射中最常用的，获取class对象的方式的主要有三种</p><ul><li>根据类名：类名.class<li>根据对象：对象.getClass()<li>根据全限定类名：Class.forName(全限定类名)</ul><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
</pre><td class="rouge-code"><pre>    <span class="nd">@Test</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">classTest</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
        <span class="c1">// 获取Class对象的三种方式</span>
        <span class="n">logger</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">"根据类名:  \t"</span> <span class="o">+</span> <span class="nc">User</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
        <span class="n">logger</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">"根据对象:  \t"</span> <span class="o">+</span> <span class="k">new</span> <span class="nc">User</span><span class="o">().</span><span class="na">getClass</span><span class="o">());</span>
        <span class="n">logger</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">"根据全限定类名:\t"</span> <span class="o">+</span> <span class="nc">Class</span><span class="o">.</span><span class="na">forName</span><span class="o">(</span><span class="s">"com.test.User"</span><span class="o">));</span>
        <span class="c1">// 常用的方法</span>
        <span class="n">logger</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">"获取全限定类名:\t"</span> <span class="o">+</span> <span class="n">userClass</span><span class="o">.</span><span class="na">getName</span><span class="o">());</span>
        <span class="n">logger</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">"获取类名:\t"</span> <span class="o">+</span> <span class="n">userClass</span><span class="o">.</span><span class="na">getSimpleName</span><span class="o">());</span>
        <span class="n">logger</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">"实例化:\t"</span> <span class="o">+</span> <span class="n">userClass</span><span class="o">.</span><span class="na">newInstance</span><span class="o">());</span>
    <span class="o">}</span>

    <span class="c1">// ...</span>
    <span class="kn">package</span> <span class="nn">com.test</span><span class="o">;</span>

    <span class="kd">public</span> <span class="kd">class</span> <span class="nc">User</span> <span class="o">{</span>
        <span class="kd">private</span> <span class="nc">String</span> <span class="n">name</span> <span class="o">=</span> <span class="s">"init"</span><span class="o">;</span>
        <span class="kd">private</span> <span class="kt">int</span> <span class="n">age</span><span class="o">;</span>
        <span class="kd">public</span> <span class="nf">User</span><span class="o">()</span> <span class="o">{}</span>
        <span class="kd">public</span> <span class="nf">User</span><span class="o">(</span><span class="nc">String</span> <span class="n">name</span><span class="o">,</span> <span class="kt">int</span> <span class="n">age</span><span class="o">)</span> <span class="o">{</span>
            <span class="kd">super</span><span class="o">();</span>
            <span class="k">this</span><span class="o">.</span><span class="na">name</span> <span class="o">=</span> <span class="n">name</span><span class="o">;</span>
            <span class="k">this</span><span class="o">.</span><span class="na">age</span> <span class="o">=</span> <span class="n">age</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="kd">private</span> <span class="nc">String</span> <span class="nf">getName</span><span class="o">()</span> <span class="o">{</span>
            <span class="k">return</span> <span class="n">name</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="kd">private</span> <span class="kt">void</span> <span class="nf">setName</span><span class="o">(</span><span class="nc">String</span> <span class="n">name</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">this</span><span class="o">.</span><span class="na">name</span> <span class="o">=</span> <span class="n">name</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="kd">public</span> <span class="kt">int</span> <span class="nf">getAge</span><span class="o">()</span> <span class="o">{</span>
            <span class="k">return</span> <span class="n">age</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setAge</span><span class="o">(</span><span class="kt">int</span> <span class="n">age</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">this</span><span class="o">.</span><span class="na">age</span> <span class="o">=</span> <span class="n">age</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="nd">@Override</span>
        <span class="kd">public</span> <span class="nc">String</span> <span class="nf">toString</span><span class="o">()</span> <span class="o">{</span>
            <span class="k">return</span> <span class="s">"User [name="</span> <span class="o">+</span> <span class="n">name</span> <span class="o">+</span> <span class="s">", age="</span> <span class="o">+</span> <span class="n">age</span> <span class="o">+</span> <span class="s">"]"</span><span class="o">;</span>
        <span class="o">}</span>
    <span class="o">}</span>
</pre></table></code></div></div><p>输出结果：</p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre><td class="rouge-code"><pre>根据类名:  	class com.test.User
根据对象:  	class com.test.User
根据全限定类名:	class com.test.User
获取全限定类名:	com.test.User
获取类名:	User
实例化:	User [name=init, age=0]
</pre></table></code></div></div><p>再来看看 Class类的方法</p><div class="table-wrapper"><table><thead><tr><th style="text-align: left">方法名<th style="text-align: left">说明<tbody><tr><td style="text-align: left">forName()<td style="text-align: left">(1)获取Class对象的一个引用，但引用的类还没有加载(该类的第一个对象没有生成)就加载了这个类。<br /> (2)为了产生Class引用，forName()立即就进行了初始化。<tr><td style="text-align: left">Object-getClass()<td style="text-align: left">获取Class对象的一个引用，返回表示该对象的实际类型的Class引用。<tr><td style="text-align: left">getName()<td style="text-align: left">取全限定的类名(包括包名)，即类的完整名字。<tr><td style="text-align: left">getSimpleName()<td style="text-align: left">获取类名(不包括包名)<tr><td style="text-align: left">getCanonicalName()<td style="text-align: left">获取全限定的类名(包括包名)<tr><td style="text-align: left">isInterface()<td style="text-align: left">判断Class对象是否是表示一个接口<tr><td style="text-align: left">getInterfaces()<td style="text-align: left">返回Class对象数组，表示Class对象所引用的类所实现的所有接口。<tr><td style="text-align: left">getSupercalss()<td style="text-align: left">返回Class对象，表示Class对象所引用的类所继承的直接基类。应用该方法可在运行时发现一个对象完整的继承结构。<tr><td style="text-align: left">newInstance()<td style="text-align: left">返回一个Oject对象，是实现“虚拟构造器”的一种途径。使用该方法创建的类，必须带有无参的构造器。<tr><td style="text-align: left">getFields()<td style="text-align: left">获得某个类的所有的公共（public）的字段，包括继承自父类的所有公共字段。 类似的还有getMethods和getConstructors。<tr><td style="text-align: left">getDeclaredFields()<td style="text-align: left">获得某个类的自己声明的字段，即包括public、private和proteced，默认但是不包括父类声明的任何字段。类似的还有getDeclaredMethods和getDeclaredConstructors。</table></div><p>简单测试下</p><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
</pre><td class="rouge-code"><pre><span class="kd">interface</span> <span class="nc">I1</span> <span class="o">{</span>
<span class="o">}</span>
<span class="kd">interface</span> <span class="nc">I2</span> <span class="o">{</span>
<span class="o">}</span>
<span class="kd">class</span> <span class="nc">Cell</span><span class="o">{</span>
    <span class="kd">public</span> <span class="kt">int</span> <span class="n">mCellPublic</span><span class="o">;</span>
<span class="o">}</span>
<span class="kd">class</span> <span class="nc">Animal</span> <span class="kd">extends</span>  <span class="nc">Cell</span><span class="o">{</span>
    <span class="kd">private</span> <span class="kt">int</span> <span class="n">mAnimalPrivate</span><span class="o">;</span>
    <span class="kd">protected</span> <span class="kt">int</span> <span class="n">mAnimalProtected</span><span class="o">;</span>
    <span class="kt">int</span> <span class="n">mAnimalDefault</span><span class="o">;</span>
    <span class="kd">public</span> <span class="kt">int</span> <span class="n">mAnimalPublic</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kt">int</span> <span class="n">sAnimalPrivate</span><span class="o">;</span>
    <span class="kd">protected</span> <span class="kd">static</span> <span class="kt">int</span> <span class="n">sAnimalProtected</span><span class="o">;</span>
    <span class="kd">static</span> <span class="kt">int</span> <span class="n">sAnimalDefault</span><span class="o">;</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">int</span> <span class="n">sAnimalPublic</span><span class="o">;</span>
<span class="o">}</span>
<span class="kd">class</span> <span class="nc">Dog</span> <span class="kd">extends</span> <span class="nc">Animal</span> <span class="kd">implements</span> <span class="no">I1</span><span class="o">,</span> <span class="no">I2</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="kt">int</span> <span class="n">mDogPrivate</span><span class="o">;</span>
    <span class="kd">public</span> <span class="kt">int</span> <span class="n">mDogPublic</span><span class="o">;</span>
    <span class="kd">protected</span> <span class="kt">int</span> <span class="n">mDogProtected</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kt">int</span> <span class="n">mDogDefault</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kt">int</span> <span class="n">sDogPrivate</span><span class="o">;</span>
    <span class="kd">protected</span> <span class="kd">static</span> <span class="kt">int</span> <span class="n">sDogProtected</span><span class="o">;</span>
    <span class="kd">static</span> <span class="kt">int</span> <span class="n">sDogDefault</span><span class="o">;</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">int</span> <span class="n">sDogPublic</span><span class="o">;</span>
<span class="o">}</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Test</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">IllegalAccessException</span><span class="o">,</span> <span class="nc">InstantiationException</span> <span class="o">{</span>
        <span class="nc">Class</span><span class="o">&lt;</span><span class="nc">Dog</span><span class="o">&gt;</span> <span class="n">dog</span> <span class="o">=</span> <span class="nc">Dog</span><span class="o">.</span><span class="na">class</span><span class="o">;</span>
        <span class="c1">//类名打印</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">dog</span><span class="o">.</span><span class="na">getName</span><span class="o">());</span> <span class="c1">//Optimus-Xs.github.io.Dog</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">dog</span><span class="o">.</span><span class="na">getSimpleName</span><span class="o">());</span> <span class="c1">//Dog</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">dog</span><span class="o">.</span><span class="na">getCanonicalName</span><span class="o">());</span><span class="c1">//Optimus-Xs.github.io.Dog</span>
        <span class="c1">//接口</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">dog</span><span class="o">.</span><span class="na">isInterface</span><span class="o">());</span> <span class="c1">//false</span>
        <span class="k">for</span> <span class="o">(</span><span class="nc">Class</span> <span class="n">iI</span> <span class="o">:</span> <span class="n">dog</span><span class="o">.</span><span class="na">getInterfaces</span><span class="o">())</span> <span class="o">{</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">iI</span><span class="o">);</span>
        <span class="o">}</span>
         <span class="cm">/*
          interface Optimus-Xs.github.io.I1
          interface Optimus-Xs.github.io.I2
         */</span>

        <span class="c1">//父类</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">dog</span><span class="o">.</span><span class="na">getSuperclass</span><span class="o">());</span><span class="c1">//class Optimus-Xs.github.io.Animal</span>
        <span class="c1">//创建对象</span>
        <span class="nc">Dog</span> <span class="n">d</span> <span class="o">=</span> <span class="n">dog</span><span class="o">.</span><span class="na">newInstance</span><span class="o">();</span>
        <span class="c1">//字段</span>
        <span class="k">for</span> <span class="o">(</span><span class="nc">Field</span> <span class="n">f</span> <span class="o">:</span> <span class="n">dog</span><span class="o">.</span><span class="na">getFields</span><span class="o">())</span> <span class="o">{</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">f</span><span class="o">.</span><span class="na">getName</span><span class="o">());</span>
        <span class="o">}</span>
        <span class="cm">/*
            mDogPublic
            sDogPublic
            mAnimalPublic
            sAnimalPublic
            mCellPublic  //父类的父类的公共字段也打印出来了
         */</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"---------"</span><span class="o">);</span>
        <span class="k">for</span> <span class="o">(</span><span class="nc">Field</span> <span class="n">f</span> <span class="o">:</span> <span class="n">dog</span><span class="o">.</span><span class="na">getDeclaredFields</span><span class="o">())</span> <span class="o">{</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">f</span><span class="o">.</span><span class="na">getName</span><span class="o">());</span>
        <span class="o">}</span>
        <span class="cm">/** 只有自己类声明的字段
         mDogPrivate
         mDogPublic
         mDogProtected
         mDogDefault
         sDogPrivate
         sDogProtected
         sDogDefault
         sDogPublic
         */</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></table></code></div></div><p>getName、getCanonicalName与getSimpleName的区别：</p><ul><li>getSimpleName：只获取类名<li>getName：类的全限定名，jvm中Class的表示，可以用于动态加载Class对象，例如Class.forName。<li>getCanonicalName：返回更容易理解的表示，主要用于输出（toString）或log打印，大多数情况下和getName一样，但是在内部类、数组等类型的表示形式就不同了。</ul><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
</pre><td class="rouge-code"><pre><span class="kn">package</span> <span class="nn">Optimus</span><span class="o">-</span><span class="nc">Xs</span><span class="o">.</span><span class="na">github</span><span class="o">.</span><span class="na">io</span><span class="o">;</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Test</span> <span class="o">{</span>
    <span class="kd">private</span>  <span class="kd">class</span> <span class="nc">inner</span><span class="o">{</span>
    <span class="o">}</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">ClassNotFoundException</span> <span class="o">{</span>
        <span class="c1">//普通类</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="nc">Test</span><span class="o">.</span><span class="na">class</span><span class="o">.</span><span class="na">getSimpleName</span><span class="o">());</span> <span class="c1">//Test</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="nc">Test</span><span class="o">.</span><span class="na">class</span><span class="o">.</span><span class="na">getName</span><span class="o">());</span> <span class="c1">//Optimus-Xs.github.io.Test</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="nc">Test</span><span class="o">.</span><span class="na">class</span><span class="o">.</span><span class="na">getCanonicalName</span><span class="o">());</span> <span class="c1">//Optimus-Xs.github.io.Test</span>
        <span class="c1">//内部类</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">inner</span><span class="o">.</span><span class="na">class</span><span class="o">.</span><span class="na">getSimpleName</span><span class="o">());</span> <span class="c1">//inner</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">inner</span><span class="o">.</span><span class="na">class</span><span class="o">.</span><span class="na">getName</span><span class="o">());</span> <span class="c1">//Optimus-Xs.github.io.Test$inner</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">inner</span><span class="o">.</span><span class="na">class</span><span class="o">.</span><span class="na">getCanonicalName</span><span class="o">());</span> <span class="c1">//Optimus-Xs.github.io.Test.inner</span>
        <span class="c1">//数组</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">args</span><span class="o">.</span><span class="na">getClass</span><span class="o">().</span><span class="na">getSimpleName</span><span class="o">());</span> <span class="c1">//String[]</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">args</span><span class="o">.</span><span class="na">getClass</span><span class="o">().</span><span class="na">getName</span><span class="o">());</span> <span class="c1">//[Ljava.lang.String;</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">args</span><span class="o">.</span><span class="na">getClass</span><span class="o">().</span><span class="na">getCanonicalName</span><span class="o">());</span> <span class="c1">//java.lang.String[]</span>
        <span class="c1">//我们不能用getCanonicalName去加载类对象，必须用getName</span>
        <span class="c1">//Class.forName(inner.class.getCanonicalName()); 报错</span>
        <span class="nc">Class</span><span class="o">.</span><span class="na">forName</span><span class="o">(</span><span class="n">inner</span><span class="o">.</span><span class="na">class</span><span class="o">.</span><span class="na">getName</span><span class="o">());</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></table></code></div></div><h2 id="constructor类及其用法"><span class="mr-2">Constructor类及其用法</span><a href="#constructor类及其用法" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><blockquote class="prompt-info"><div><p>Constructor类存在于反射包(java.lang.reflect)中，反映的是Class 对象所表示的类的构造方法。</p></div></blockquote><p>获取Constructor对象是通过Class类中的方法获取的，Class类与Constructor相关的主要方法如下：</p><div class="table-wrapper"><table><thead><tr><th style="text-align: left">方法返回值<th style="text-align: left">方法名称<th style="text-align: left">方法说明<tbody><tr><td style="text-align: left">static Class&lt;?&gt;<td style="text-align: left">forName(String className)<td style="text-align: left">返回与带有给定字符串名的类或接口相关联的 Class 对象。<tr><td style="text-align: left">Constructor<td style="text-align: left">getConstructor(Class&lt;?&gt;… parameterTypes)<td style="text-align: left">返回指定参数类型、具有public访问权限的构造函数对象<tr><td style="text-align: left">Constructor&lt;?&gt;[]<td style="text-align: left">getConstructors()<td style="text-align: left">返回所有具有public访问权限的构造函数的Constructor对象数组<tr><td style="text-align: left">Constructor<td style="text-align: left">getDeclaredConstructor(Class&lt;?&gt;… parameterTypes)<td style="text-align: left">返回指定参数类型、所有声明的（包括private）构造函数对象<tr><td style="text-align: left">Constructor&lt;?&gt;[]<td style="text-align: left">getDeclaredConstructor()<td style="text-align: left">返回所有声明的（包括private）构造函数对象<tr><td style="text-align: left">T<td style="text-align: left">newInstance()<td style="text-align: left">调用无参构造器创建此 Class 对象所表示的类的一个新实例。</table></div><p>下面看一个简单例子来了解Constructor对象的使用：</p><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
</pre><td class="rouge-code"><pre><span class="kd">public</span> <span class="kd">class</span> <span class="nc">ConstructionTest</span> <span class="kd">implements</span> <span class="nc">Serializable</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>

        <span class="nc">Class</span><span class="o">&lt;?&gt;</span> <span class="n">clazz</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>

        <span class="c1">//获取Class对象的引用</span>
        <span class="n">clazz</span> <span class="o">=</span> <span class="nc">Class</span><span class="o">.</span><span class="na">forName</span><span class="o">(</span><span class="s">"com.example.javabase.User"</span><span class="o">);</span>

        <span class="c1">//第一种方法，实例化默认构造方法，User必须无参构造函数,否则将抛异常</span>
        <span class="nc">User</span> <span class="n">user</span> <span class="o">=</span> <span class="o">(</span><span class="nc">User</span><span class="o">)</span> <span class="n">clazz</span><span class="o">.</span><span class="na">newInstance</span><span class="o">();</span>
        <span class="n">user</span><span class="o">.</span><span class="na">setAge</span><span class="o">(</span><span class="mi">20</span><span class="o">);</span>
        <span class="n">user</span><span class="o">.</span><span class="na">setName</span><span class="o">(</span><span class="s">"Jack"</span><span class="o">);</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">user</span><span class="o">);</span>

        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"--------------------------------------------"</span><span class="o">);</span>

        <span class="c1">//获取带String参数的public构造函数</span>
        <span class="nc">Constructor</span> <span class="n">cs1</span> <span class="o">=</span><span class="n">clazz</span><span class="o">.</span><span class="na">getConstructor</span><span class="o">(</span><span class="nc">String</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
        <span class="c1">//创建User</span>
        <span class="nc">User</span> <span class="n">user1</span><span class="o">=</span> <span class="o">(</span><span class="nc">User</span><span class="o">)</span> <span class="n">cs1</span><span class="o">.</span><span class="na">newInstance</span><span class="o">(</span><span class="s">"hiway"</span><span class="o">);</span>
        <span class="n">user1</span><span class="o">.</span><span class="na">setAge</span><span class="o">(</span><span class="mi">22</span><span class="o">);</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"user1:"</span><span class="o">+</span><span class="n">user1</span><span class="o">.</span><span class="na">toString</span><span class="o">());</span>

        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"--------------------------------------------"</span><span class="o">);</span>

        <span class="c1">//取得指定带int和String参数构造函数,该方法是私有构造private</span>
        <span class="nc">Constructor</span> <span class="n">cs2</span><span class="o">=</span><span class="n">clazz</span><span class="o">.</span><span class="na">getDeclaredConstructor</span><span class="o">(</span><span class="kt">int</span><span class="o">.</span><span class="na">class</span><span class="o">,</span><span class="nc">String</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
        <span class="c1">//由于是private必须设置可访问</span>
        <span class="n">cs2</span><span class="o">.</span><span class="na">setAccessible</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
        <span class="c1">//创建user对象</span>
        <span class="nc">User</span> <span class="n">user2</span><span class="o">=</span> <span class="o">(</span><span class="nc">User</span><span class="o">)</span> <span class="n">cs2</span><span class="o">.</span><span class="na">newInstance</span><span class="o">(</span><span class="mi">25</span><span class="o">,</span><span class="s">"hiway2"</span><span class="o">);</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"user2:"</span><span class="o">+</span><span class="n">user2</span><span class="o">.</span><span class="na">toString</span><span class="o">());</span>

        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"--------------------------------------------"</span><span class="o">);</span>

        <span class="c1">//获取所有构造包含private</span>
        <span class="nc">Constructor</span><span class="o">&lt;?&gt;</span> <span class="n">cons</span><span class="o">[]</span> <span class="o">=</span> <span class="n">clazz</span><span class="o">.</span><span class="na">getDeclaredConstructors</span><span class="o">();</span>
        <span class="c1">// 查看每个构造方法需要的参数</span>
        <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">cons</span><span class="o">.</span><span class="na">length</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
            <span class="c1">//获取构造函数参数类型</span>
            <span class="nc">Class</span><span class="o">&lt;?&gt;</span> <span class="n">clazzs</span><span class="o">[]</span> <span class="o">=</span> <span class="n">cons</span><span class="o">[</span><span class="n">i</span><span class="o">].</span><span class="na">getParameterTypes</span><span class="o">();</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"构造函数["</span><span class="o">+</span><span class="n">i</span><span class="o">+</span><span class="s">"]:"</span><span class="o">+</span><span class="n">cons</span><span class="o">[</span><span class="n">i</span><span class="o">].</span><span class="na">toString</span><span class="o">()</span> <span class="o">);</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">print</span><span class="o">(</span><span class="s">"参数类型["</span><span class="o">+</span><span class="n">i</span><span class="o">+</span><span class="s">"]:("</span><span class="o">);</span>
            <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">clazzs</span><span class="o">.</span><span class="na">length</span><span class="o">;</span> <span class="n">j</span><span class="o">++)</span> <span class="o">{</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">j</span> <span class="o">==</span> <span class="n">clazzs</span><span class="o">.</span><span class="na">length</span> <span class="o">-</span> <span class="mi">1</span><span class="o">)</span>
                    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">print</span><span class="o">(</span><span class="n">clazzs</span><span class="o">[</span><span class="n">j</span><span class="o">].</span><span class="na">getName</span><span class="o">());</span>
                <span class="k">else</span>
                    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">print</span><span class="o">(</span><span class="n">clazzs</span><span class="o">[</span><span class="n">j</span><span class="o">].</span><span class="na">getName</span><span class="o">()</span> <span class="o">+</span> <span class="s">","</span><span class="o">);</span>
            <span class="o">}</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">")"</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>


<span class="kd">class</span> <span class="nc">User</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="kt">int</span> <span class="n">age</span><span class="o">;</span>
    <span class="kd">private</span> <span class="nc">String</span> <span class="n">name</span><span class="o">;</span>
    <span class="kd">public</span> <span class="nf">User</span><span class="o">()</span> <span class="o">{</span>
        <span class="kd">super</span><span class="o">();</span>
    <span class="o">}</span>
    <span class="kd">public</span> <span class="nf">User</span><span class="o">(</span><span class="nc">String</span> <span class="n">name</span><span class="o">)</span> <span class="o">{</span>
        <span class="kd">super</span><span class="o">();</span>
        <span class="k">this</span><span class="o">.</span><span class="na">name</span> <span class="o">=</span> <span class="n">name</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="cm">/**
     * 私有构造
     * @param age
     * @param name
     */</span>
    <span class="kd">private</span> <span class="nf">User</span><span class="o">(</span><span class="kt">int</span> <span class="n">age</span><span class="o">,</span> <span class="nc">String</span> <span class="n">name</span><span class="o">)</span> <span class="o">{</span>
        <span class="kd">super</span><span class="o">();</span>
        <span class="k">this</span><span class="o">.</span><span class="na">age</span> <span class="o">=</span> <span class="n">age</span><span class="o">;</span>
        <span class="k">this</span><span class="o">.</span><span class="na">name</span> <span class="o">=</span> <span class="n">name</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">int</span> <span class="nf">getAge</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">age</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setAge</span><span class="o">(</span><span class="kt">int</span> <span class="n">age</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">age</span> <span class="o">=</span> <span class="n">age</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="nc">String</span> <span class="nf">getName</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">name</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setName</span><span class="o">(</span><span class="nc">String</span> <span class="n">name</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">name</span> <span class="o">=</span> <span class="n">name</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="nc">String</span> <span class="nf">toString</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="s">"User{"</span> <span class="o">+</span>
                <span class="s">"age="</span> <span class="o">+</span> <span class="n">age</span> <span class="o">+</span>
                <span class="s">", name='"</span> <span class="o">+</span> <span class="n">name</span> <span class="o">+</span> <span class="sc">'\''</span> <span class="o">+</span>
                <span class="sc">'}'</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></table></code></div></div><p>输出结果</p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
</pre><td class="rouge-code"><pre>User{age=20, name='Jack'}
--------------------------------------------
user1:User{age=22, name='hiway'}
--------------------------------------------
user2:User{age=25, name='hiway2'}
--------------------------------------------
构造函数[0]:private com.example.javabase.User(int,java.lang.String)
参数类型[0]:(int,java.lang.String)
构造函数[1]:public com.example.javabase.User(java.lang.String)
参数类型[1]:(java.lang.String)
构造函数[2]:public com.example.javabase.User()
参数类型[2]:()
</pre></table></code></div></div><p>关于Constructor类本身一些常用方法如下(仅部分，其他可查API)</p><div class="table-wrapper"><table><thead><tr><th style="text-align: left">方法返回值<th style="text-align: left">方法名称<th style="text-align: left">方法说明<tbody><tr><td style="text-align: left">Class<td style="text-align: left">getDeclaringClass()<td style="text-align: left">返回 Class 对象，该对象表示声明由此 Constructor 对象表示的构造方法的类,其实就是返回真实类型（不包含参数）<tr><td style="text-align: left">Type[]<td style="text-align: left">getGenericParameterTypes()<td style="text-align: left">按照声明顺序返回一组 Type 对象，返回的就是 Constructor对象构造函数的形参类型。<tr><td style="text-align: left">String<td style="text-align: left">getName()<td style="text-align: left">以字符串形式返回此构造方法的名称。<tr><td style="text-align: left">Class&lt;?&gt;[]<td style="text-align: left">getParameterTypes()<td style="text-align: left">按照声明顺序返回一组 Class 对象，即返回Constructor 对象所表示构造方法的形参类型<tr><td style="text-align: left">T<td style="text-align: left">newInstance(Object… initargs)<td style="text-align: left">使用此 Constructor对象表示的构造函数来创建新实例<tr><td style="text-align: left">String<td style="text-align: left">toGenericString()<td style="text-align: left">返回描述此 Constructor 的字符串，其中包括类型参数。</table></div><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
</pre><td class="rouge-code"><pre><span class="nc">Constructor</span> <span class="n">cs3</span> <span class="o">=</span> <span class="n">clazz</span><span class="o">.</span><span class="na">getDeclaredConstructor</span><span class="o">(</span><span class="kt">int</span><span class="o">.</span><span class="na">class</span><span class="o">,</span><span class="nc">String</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
<span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"-----getDeclaringClass-----"</span><span class="o">);</span>
<span class="nc">Class</span> <span class="n">uclazz</span><span class="o">=</span><span class="n">cs3</span><span class="o">.</span><span class="na">getDeclaringClass</span><span class="o">();</span>
<span class="c1">//Constructor对象表示的构造方法的类</span>
<span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"构造方法的类:"</span><span class="o">+</span><span class="n">uclazz</span><span class="o">.</span><span class="na">getName</span><span class="o">());</span>

<span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"-----getGenericParameterTypes-----"</span><span class="o">);</span>
<span class="c1">//对象表示此 Constructor 对象所表示的方法的形参类型</span>
<span class="nc">Type</span><span class="o">[]</span> <span class="n">tps</span><span class="o">=</span><span class="n">cs3</span><span class="o">.</span><span class="na">getGenericParameterTypes</span><span class="o">();</span>
<span class="k">for</span> <span class="o">(</span><span class="nc">Type</span> <span class="nl">tp:</span><span class="n">tps</span><span class="o">)</span> <span class="o">{</span>
    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"参数名称tp:"</span><span class="o">+</span><span class="n">tp</span><span class="o">);</span>
<span class="o">}</span>
<span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"-----getParameterTypes-----"</span><span class="o">);</span>
<span class="c1">//获取构造函数参数类型</span>
<span class="nc">Class</span><span class="o">&lt;?&gt;</span> <span class="n">clazzs</span><span class="o">[]</span> <span class="o">=</span> <span class="n">cs3</span><span class="o">.</span><span class="na">getParameterTypes</span><span class="o">();</span>
<span class="k">for</span> <span class="o">(</span><span class="nc">Class</span> <span class="nl">claz:</span><span class="n">clazzs</span><span class="o">)</span> <span class="o">{</span>
    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"参数名称:"</span><span class="o">+</span><span class="n">claz</span><span class="o">.</span><span class="na">getName</span><span class="o">());</span>
<span class="o">}</span>
<span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"-----getName-----"</span><span class="o">);</span>
<span class="c1">//以字符串形式返回此构造方法的名称</span>
<span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"getName:"</span><span class="o">+</span><span class="n">cs3</span><span class="o">.</span><span class="na">getName</span><span class="o">());</span>

<span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"-----getoGenericString-----"</span><span class="o">);</span>
<span class="c1">//返回描述此 Constructor 的字符串，其中包括类型参数。</span>
<span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"getoGenericString():"</span><span class="o">+</span><span class="n">cs3</span><span class="o">.</span><span class="na">toGenericString</span><span class="o">());</span>
</pre></table></code></div></div><p>输出结果</p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
</pre><td class="rouge-code"><pre>-----getDeclaringClass-----
构造方法的类:com.example.javabase.User
-----getGenericParameterTypes-----
参数名称tp:int
参数名称tp:class java.lang.String
-----getParameterTypes-----
参数名称:int
参数名称:java.lang.String
-----getName-----
getName:com.example.javabase.User
-----getoGenericString-----
getoGenericString():private com.example.javabase.User(int,java.lang.String)
</pre></table></code></div></div><h2 id="field类及其用法"><span class="mr-2">Field类及其用法</span><a href="#field类及其用法" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><blockquote class="prompt-info"><div><p>Field 提供有关类或接口的单个字段的信息，以及对它的动态访问权限。反射的字段可能是一个类（静态）字段或实例字段。</p></div></blockquote><p>同样的道理，我们可以通过Class类的提供的方法来获取代表字段信息的Field对象，Class类与Field对象相关方法如下：</p><div class="table-wrapper"><table><thead><tr><th style="text-align: left">方法返回值<th style="text-align: left">方法名称<th style="text-align: left">方法说明<tbody><tr><td style="text-align: left">Field<td style="text-align: left">getDeclaredField(String name)<td style="text-align: left">获取指定name名称的(包含private修饰的) 字段，不包括继承的字段<tr><td style="text-align: left">Field[]<td style="text-align: left">getDeclaredFields()<td style="text-align: left">获取Class对象所表示的类或接口的所有(包含private修饰的)字段, 不包括继承的字段<tr><td style="text-align: left">Field<td style="text-align: left">getField(String name)<td style="text-align: left">获取指定name名称、具有public修饰的字段，包含继承字段<tr><td style="text-align: left">Field[]<td style="text-align: left">getFields()<td style="text-align: left">获取修饰符为public的字段，包含继承字段</table></div><p>下面的代码演示了上述方法的使用过程</p><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
</pre><td class="rouge-code"><pre><span class="kd">public</span> <span class="kd">class</span> <span class="nc">ReflectField</span> <span class="o">{</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">ClassNotFoundException</span><span class="o">,</span> <span class="nc">NoSuchFieldException</span> <span class="o">{</span>
        <span class="nc">Class</span><span class="o">&lt;?&gt;</span> <span class="n">clazz</span> <span class="o">=</span> <span class="nc">Class</span><span class="o">.</span><span class="na">forName</span><span class="o">(</span><span class="s">"reflect.Student"</span><span class="o">);</span>
        <span class="c1">//获取指定字段名称的Field类,注意字段修饰符必须为public而且存在该字段,</span>
        <span class="c1">// 否则抛NoSuchFieldException</span>
        <span class="nc">Field</span> <span class="n">field</span> <span class="o">=</span> <span class="n">clazz</span><span class="o">.</span><span class="na">getField</span><span class="o">(</span><span class="s">"age"</span><span class="o">);</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"field:"</span><span class="o">+</span><span class="n">field</span><span class="o">);</span>

        <span class="c1">//获取所有修饰符为public的字段,包含父类字段,注意修饰符为public才会获取</span>
        <span class="nc">Field</span> <span class="n">fields</span><span class="o">[]</span> <span class="o">=</span> <span class="n">clazz</span><span class="o">.</span><span class="na">getFields</span><span class="o">();</span>
        <span class="k">for</span> <span class="o">(</span><span class="nc">Field</span> <span class="nl">f:</span><span class="n">fields</span><span class="o">)</span> <span class="o">{</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"f:"</span><span class="o">+</span><span class="n">f</span><span class="o">.</span><span class="na">getDeclaringClass</span><span class="o">());</span>
        <span class="o">}</span>

        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"================getDeclaredFields===================="</span><span class="o">);</span>
        <span class="c1">//获取当前类所字段(包含private字段),注意不包含父类的字段</span>
        <span class="nc">Field</span> <span class="n">fields2</span><span class="o">[]</span> <span class="o">=</span> <span class="n">clazz</span><span class="o">.</span><span class="na">getDeclaredFields</span><span class="o">();</span>
        <span class="k">for</span> <span class="o">(</span><span class="nc">Field</span> <span class="nl">f:</span><span class="n">fields2</span><span class="o">)</span> <span class="o">{</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"f2:"</span><span class="o">+</span><span class="n">f</span><span class="o">.</span><span class="na">getDeclaringClass</span><span class="o">());</span>
        <span class="o">}</span>
        <span class="c1">//获取指定字段名称的Field类,可以是任意修饰符的自动,注意不包含父类的字段</span>
        <span class="nc">Field</span> <span class="n">field2</span> <span class="o">=</span> <span class="n">clazz</span><span class="o">.</span><span class="na">getDeclaredField</span><span class="o">(</span><span class="s">"desc"</span><span class="o">);</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"field2:"</span><span class="o">+</span><span class="n">field2</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="cm">/**
      输出结果: 
     field:public int reflect.Person.age
     f:public java.lang.String reflect.Student.desc
     f:public int reflect.Person.age
     f:public java.lang.String reflect.Person.name

     ================getDeclaredFields====================
     f2:public java.lang.String reflect.Student.desc
     f2:private int reflect.Student.score
     field2:public java.lang.String reflect.Student.desc
     */</span>
<span class="o">}</span>

<span class="kd">class</span> <span class="nc">Person</span><span class="o">{</span>
    <span class="kd">public</span> <span class="kt">int</span> <span class="n">age</span><span class="o">;</span>
    <span class="kd">public</span> <span class="nc">String</span> <span class="n">name</span><span class="o">;</span>
    <span class="c1">//省略set和get方法</span>
<span class="o">}</span>

<span class="kd">class</span> <span class="nc">Student</span> <span class="kd">extends</span> <span class="nc">Person</span><span class="o">{</span>
    <span class="kd">public</span> <span class="nc">String</span> <span class="n">desc</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kt">int</span> <span class="n">score</span><span class="o">;</span>
    <span class="c1">//省略set和get方法</span>
<span class="o">}</span>

</pre></table></code></div></div><p>上述方法需要注意的是，如果我们不期望获取其父类的字段，则需使用Class类的getDeclaredField/getDeclaredFields方法来获取字段即可，倘若需要连带获取到父类的字段，那么请使用Class类的getField/getFields，但是也只能获取到public修饰的的字段，无法获取父类的私有字段。下面将通过Field类本身的方法对指定类属性赋值，代码演示如下：</p><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
</pre><td class="rouge-code"><pre><span class="c1">//获取Class对象引用</span>
<span class="nc">Class</span><span class="o">&lt;?&gt;</span> <span class="n">clazz</span> <span class="o">=</span> <span class="nc">Class</span><span class="o">.</span><span class="na">forName</span><span class="o">(</span><span class="s">"reflect.Student"</span><span class="o">);</span>

<span class="nc">Student</span> <span class="n">st</span><span class="o">=</span> <span class="o">(</span><span class="nc">Student</span><span class="o">)</span> <span class="n">clazz</span><span class="o">.</span><span class="na">newInstance</span><span class="o">();</span>
<span class="c1">//获取父类public字段并赋值</span>
<span class="nc">Field</span> <span class="n">ageField</span> <span class="o">=</span> <span class="n">clazz</span><span class="o">.</span><span class="na">getField</span><span class="o">(</span><span class="s">"age"</span><span class="o">);</span>
<span class="n">ageField</span><span class="o">.</span><span class="na">set</span><span class="o">(</span><span class="n">st</span><span class="o">,</span><span class="mi">18</span><span class="o">);</span>
<span class="nc">Field</span> <span class="n">nameField</span> <span class="o">=</span> <span class="n">clazz</span><span class="o">.</span><span class="na">getField</span><span class="o">(</span><span class="s">"name"</span><span class="o">);</span>
<span class="n">nameField</span><span class="o">.</span><span class="na">set</span><span class="o">(</span><span class="n">st</span><span class="o">,</span><span class="s">"Lily"</span><span class="o">);</span>

<span class="c1">//只获取当前类的字段,不获取父类的字段</span>
<span class="nc">Field</span> <span class="n">descField</span> <span class="o">=</span> <span class="n">clazz</span><span class="o">.</span><span class="na">getDeclaredField</span><span class="o">(</span><span class="s">"desc"</span><span class="o">);</span>
<span class="n">descField</span><span class="o">.</span><span class="na">set</span><span class="o">(</span><span class="n">st</span><span class="o">,</span><span class="s">"I am student"</span><span class="o">);</span>
<span class="nc">Field</span> <span class="n">scoreField</span> <span class="o">=</span> <span class="n">clazz</span><span class="o">.</span><span class="na">getDeclaredField</span><span class="o">(</span><span class="s">"score"</span><span class="o">);</span>
<span class="c1">//设置可访问，score是private的</span>
<span class="n">scoreField</span><span class="o">.</span><span class="na">setAccessible</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
<span class="n">scoreField</span><span class="o">.</span><span class="na">set</span><span class="o">(</span><span class="n">st</span><span class="o">,</span><span class="mi">88</span><span class="o">);</span>
<span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">st</span><span class="o">.</span><span class="na">toString</span><span class="o">());</span>

<span class="c1">//输出结果：Student{age=18, name='Lily ,desc='I am student', score=88} </span>

<span class="c1">//获取字段值</span>
<span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">scoreField</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">st</span><span class="o">));</span>
<span class="c1">// 88</span>
</pre></table></code></div></div><p>其中的set(Object obj, Object value)方法是Field类本身的方法，用于设置字段的值，而get(Object obj)则是获取字段的值，当然关于Field类还有其他常用的方法如下：</p><div class="table-wrapper"><table><thead><tr><th style="text-align: left">方法返回值<th style="text-align: left">方法名称<th style="text-align: left">方法说明<tbody><tr><td style="text-align: left">void<td style="text-align: left">set(Object obj, Object value)<td style="text-align: left">将指定对象变量上此 Field 对象表示的字段设置为指定的新值。<tr><td style="text-align: left">Object<td style="text-align: left">get(Object obj)<td style="text-align: left">返回指定对象上此 Field 表示的字段的值<tr><td style="text-align: left">Class&lt;?&gt;<td style="text-align: left">getType()<td style="text-align: left">返回一个 Class 对象，它标识了此Field 对象所表示字段的声明类型。<tr><td style="text-align: left">boolean<td style="text-align: left">isEnumConstant()<td style="text-align: left">如果此字段表示枚举类型的元素则返回 true；否则返回 false<tr><td style="text-align: left">String<td style="text-align: left">toGenericString()<td style="text-align: left">返回一个描述此 Field（包括其一般类型）的字符串<tr><td style="text-align: left">String<td style="text-align: left">getName()<td style="text-align: left">返回此 Field 对象表示的字段的名称<tr><td style="text-align: left">Class&lt;?&gt;<td style="text-align: left">getDeclaringClass()<td style="text-align: left">返回表示类或接口的 Class 对象，该类或接口声明由此 Field 对象表示的字段<tr><td style="text-align: left">void<td style="text-align: left">setAccessible(boolean flag)<td style="text-align: left">将此对象的 accessible 标志设置为指示的布尔值,即设置其可访问性</table></div><p>上述方法可能是较为常用的，事实上在设置值的方法上，Field类还提供了专门针对基本数据类型的方法，如setInt()/getInt()、setBoolean()/getBoolean、setChar()/getChar()等等方法，这里就不全部列出了，需要时查API文档即可。需要特别注意的是被final关键字修饰的Field字段是安全的，在运行时可以接收任何修改，但最终其实际值是不会发生改变的</p><h2 id="method类及其用法"><span class="mr-2">Method类及其用法</span><a href="#method类及其用法" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><blockquote class="prompt-info"><div><p>Method 提供关于类或接口上单独某个方法（以及如何访问该方法）的信息，所反映的方法可能是类方法或实例方法（包括抽象方法）。</p></div></blockquote><p>下面是Class类获取Method对象相关的方法：</p><div class="table-wrapper"><table><thead><tr><th style="text-align: left">方法返回值<th style="text-align: left">方法名称<th style="text-align: left">方法说明<tbody><tr><td style="text-align: left">Method<td style="text-align: left">getDeclaredMethod(String name, Class&lt;?&gt;… parameterTypes)<td style="text-align: left">返回一个指定参数的Method对象，该对象反映此 Class 对象所表示的类或接口的指定已声明方法。<tr><td style="text-align: left">Method[]<td style="text-align: left">getDeclaredMethod()<td style="text-align: left">返回 Method 对象的一个数组，这些对象反映此 Class 对象表示的类或接口声明的所有方法，包括公共、保护、默认（包）访问和私有方法，但不包括继承的方法。<tr><td style="text-align: left">Method<td style="text-align: left">getMethod(String name, Class&lt;?&gt;… parameterTypes)<td style="text-align: left">返回一个 Method 对象，它反映此 Class 对象所表示的类或接口的指定公共成员方法。<tr><td style="text-align: left">Method[]<td style="text-align: left">getMethods()<td style="text-align: left">返回一个包含某些 Method 对象的数组，这些对象反映此 Class 对象所表示的类或接口（包括那些由该类或接口声明的以及从超类和超接口继承的那些的类或接口）的公共 member 方法。</table></div><p>同样通过案例演示上述方法</p><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
</pre><td class="rouge-code"><pre><span class="kn">import</span> <span class="nn">java.lang.reflect.Method</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">ReflectMethod</span>  <span class="o">{</span>


    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">ClassNotFoundException</span><span class="o">,</span> <span class="nc">NoSuchMethodException</span> <span class="o">{</span>

        <span class="nc">Class</span> <span class="n">clazz</span> <span class="o">=</span> <span class="nc">Class</span><span class="o">.</span><span class="na">forName</span><span class="o">(</span><span class="s">"reflect.Circle"</span><span class="o">);</span>

        <span class="c1">//根据参数获取public的Method,包含继承自父类的方法</span>
        <span class="nc">Method</span> <span class="n">method</span> <span class="o">=</span> <span class="n">clazz</span><span class="o">.</span><span class="na">getMethod</span><span class="o">(</span><span class="s">"draw"</span><span class="o">,</span><span class="kt">int</span><span class="o">.</span><span class="na">class</span><span class="o">,</span><span class="nc">String</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>

        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"method:"</span><span class="o">+</span><span class="n">method</span><span class="o">);</span>

        <span class="c1">//获取所有public的方法:</span>
        <span class="nc">Method</span><span class="o">[]</span> <span class="n">methods</span> <span class="o">=</span><span class="n">clazz</span><span class="o">.</span><span class="na">getMethods</span><span class="o">();</span>
        <span class="k">for</span> <span class="o">(</span><span class="nc">Method</span> <span class="nl">m:</span><span class="n">methods</span><span class="o">){</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"m::"</span><span class="o">+</span><span class="n">m</span><span class="o">);</span>
        <span class="o">}</span>

        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"========================================="</span><span class="o">);</span>

        <span class="c1">//获取当前类的方法包含private,该方法无法获取继承自父类的method</span>
        <span class="nc">Method</span> <span class="n">method1</span> <span class="o">=</span> <span class="n">clazz</span><span class="o">.</span><span class="na">getDeclaredMethod</span><span class="o">(</span><span class="s">"drawCircle"</span><span class="o">);</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"method1::"</span><span class="o">+</span><span class="n">method1</span><span class="o">);</span>
        <span class="c1">//获取当前类的所有方法包含private,该方法无法获取继承自父类的method</span>
        <span class="nc">Method</span><span class="o">[]</span> <span class="n">methods1</span><span class="o">=</span><span class="n">clazz</span><span class="o">.</span><span class="na">getDeclaredMethods</span><span class="o">();</span>
        <span class="k">for</span> <span class="o">(</span><span class="nc">Method</span> <span class="nl">m:</span><span class="n">methods1</span><span class="o">){</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"m1::"</span><span class="o">+</span><span class="n">m</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>

<span class="kd">class</span> <span class="nc">Shape</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">draw</span><span class="o">(){</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"draw"</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">draw</span><span class="o">(</span><span class="kt">int</span> <span class="n">count</span> <span class="o">,</span> <span class="nc">String</span> <span class="n">name</span><span class="o">){</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"draw "</span><span class="o">+</span> <span class="n">name</span> <span class="o">+</span><span class="s">",count="</span><span class="o">+</span><span class="n">count</span><span class="o">);</span>
    <span class="o">}</span>

<span class="o">}</span>
<span class="kd">class</span> <span class="nc">Circle</span> <span class="kd">extends</span> <span class="nc">Shape</span><span class="o">{</span>

    <span class="kd">private</span> <span class="kt">void</span> <span class="nf">drawCircle</span><span class="o">(){</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"drawCircle"</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="kd">public</span> <span class="kt">int</span> <span class="nf">getAllCount</span><span class="o">(){</span>
        <span class="k">return</span> <span class="mi">100</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></table></code></div></div><p>输出结果:</p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
</pre><td class="rouge-code"><pre>method:public void reflect.Shape.draw(int,java.lang.String)

m::public int reflect.Circle.getAllCount()
m::public void reflect.Shape.draw()
m::public void reflect.Shape.draw(int,java.lang.String)
m::public final void java.lang.Object.wait(long,int) throws java.lang.InterruptedException
m::public final native void java.lang.Object.wait(long) throws java.lang.InterruptedException
m::public final void java.lang.Object.wait() throws java.lang.InterruptedException
m::public boolean java.lang.Object.equals(java.lang.Object)
m::public java.lang.String java.lang.Object.toString()
m::public native int java.lang.Object.hashCode()
m::public final native java.lang.Class java.lang.Object.getClass()
m::public final native void java.lang.Object.notify()
m::public final native void java.lang.Object.notifyAll()

=========================================
method1::private void reflect.Circle.drawCircle()

m1::public int reflect.Circle.getAllCount()
m1::private void reflect.Circle.drawCircle()
</pre></table></code></div></div><p>在通过getMethods方法获取Method对象时，会把父类的方法也获取到，如上的输出结果，把Object类的方法都打印出来了。而getDeclaredMethod/getDeclaredMethods方法都只能获取当前类的方法。我们在使用时根据情况选择即可。下面将演示通过Method对象调用指定类的方法</p><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
</pre><td class="rouge-code"><pre><span class="nc">Class</span> <span class="n">clazz</span> <span class="o">=</span> <span class="nc">Class</span><span class="o">.</span><span class="na">forName</span><span class="o">(</span><span class="s">"reflect.Circle"</span><span class="o">);</span>
<span class="c1">//创建对象</span>
<span class="nc">Circle</span> <span class="n">circle</span> <span class="o">=</span> <span class="o">(</span><span class="nc">Circle</span><span class="o">)</span> <span class="n">clazz</span><span class="o">.</span><span class="na">newInstance</span><span class="o">();</span>

<span class="c1">//获取指定参数的方法对象Method</span>
<span class="nc">Method</span> <span class="n">method</span> <span class="o">=</span> <span class="n">clazz</span><span class="o">.</span><span class="na">getMethod</span><span class="o">(</span><span class="s">"draw"</span><span class="o">,</span><span class="kt">int</span><span class="o">.</span><span class="na">class</span><span class="o">,</span><span class="nc">String</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>

<span class="c1">//通过Method对象的invoke(Object obj,Object... args)方法调用</span>
<span class="n">method</span><span class="o">.</span><span class="na">invoke</span><span class="o">(</span><span class="n">circle</span><span class="o">,</span><span class="mi">15</span><span class="o">,</span><span class="s">"圈圈"</span><span class="o">);</span>

<span class="c1">//对私有无参方法的操作</span>
<span class="nc">Method</span> <span class="n">method1</span> <span class="o">=</span> <span class="n">clazz</span><span class="o">.</span><span class="na">getDeclaredMethod</span><span class="o">(</span><span class="s">"drawCircle"</span><span class="o">);</span>
<span class="c1">//修改私有方法的访问标识</span>
<span class="n">method1</span><span class="o">.</span><span class="na">setAccessible</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
<span class="n">method1</span><span class="o">.</span><span class="na">invoke</span><span class="o">(</span><span class="n">circle</span><span class="o">);</span>

<span class="c1">//对有返回值得方法操作</span>
<span class="nc">Method</span> <span class="n">method2</span> <span class="o">=</span><span class="n">clazz</span><span class="o">.</span><span class="na">getDeclaredMethod</span><span class="o">(</span><span class="s">"getAllCount"</span><span class="o">);</span>
<span class="nc">Integer</span> <span class="n">count</span> <span class="o">=</span> <span class="o">(</span><span class="nc">Integer</span><span class="o">)</span> <span class="n">method2</span><span class="o">.</span><span class="na">invoke</span><span class="o">(</span><span class="n">circle</span><span class="o">);</span>
<span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"count:"</span><span class="o">+</span><span class="n">count</span><span class="o">);</span>
</pre></table></code></div></div><p>输出结果</p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre>draw 圈圈,count=15
drawCircle
count:100
</pre></table></code></div></div><p>在上述代码中调用方法，使用了Method类的invoke(Object obj,Object… args)第一个参数代表调用的对象，第二个参数传递的调用方法的参数。这样就完成了类方法的动态调用。</p><div class="table-wrapper"><table><thead><tr><th style="text-align: left">方法返回值<th style="text-align: left">方法名称<th style="text-align: left">方法说明<tbody><tr><td style="text-align: left">bject<td style="text-align: left">invoke(Object obj, Object… args)<td style="text-align: left">对带有指定参数的指定对象调用由此 Method 对象表示的底层方法。<tr><td style="text-align: left">lass&lt;?&gt;<td style="text-align: left">getReturnType()<td style="text-align: left">返回一个 Class 对象，该对象描述了此 Method 对象所表示的方法的正式返回类型,即方法的返回类型<tr><td style="text-align: left">ype<td style="text-align: left">getGenericReturnType()<td style="text-align: left">返回表示由此 Method 对象所表示方法的正式返回类型的 Type 对象，也是方法的返回类型。<tr><td style="text-align: left">lass&lt;?&gt;[]<td style="text-align: left">getParameterTypes()<td style="text-align: left">按照声明顺序返回 Class 对象的数组，这些对象描述了此 Method 对象所表示的方法的形参类型。即返回方法的参数类型组成的数组<tr><td style="text-align: left">ype[]<td style="text-align: left">getGenericParameterTypes()<td style="text-align: left">按照声明顺序返回 Type 对象的数组，这些对象描述了此 Method 对象所表示的方法的形参类型的，也是返回方法的参数类型<tr><td style="text-align: left">tring<td style="text-align: left">getName()<td style="text-align: left">以 String 形式返回此 Method 对象表示的方法名称，即返回方法的名称<tr><td style="text-align: left">oolean<td style="text-align: left">isVarArgs()<td style="text-align: left">判断方法是否带可变参数，如果将此方法声明为带有可变数量的参数，则返回 true；否则，返回 false。<tr><td style="text-align: left">tring<td style="text-align: left">toGenericString()<td style="text-align: left">返回描述此 Method 的字符串，包括类型参数。</table></div><p>getReturnType方法/getGenericReturnType方法都是获取Method对象表示的方法的返回类型，只不过前者返回的Class类型后者返回的Type(前面已分析过)，Type就是一个接口而已，在Java8中新增一个默认的方法实现，返回的就参数类型信息</p><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre><td class="rouge-code"><pre><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">Type</span> <span class="o">{</span>
    <span class="c1">//1.8新增</span>
    <span class="k">default</span> <span class="nc">String</span> <span class="nf">getTypeName</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="nf">toString</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></table></code></div></div><p>而getParameterTypes/getGenericParameterTypes也是同样的道理，都是获取Method对象所表示的方法的参数类型，其他方法与前面的Field和Constructor是类似的。</p><h1 id="反射的基本运用示例">反射的基本运用示例</h1><blockquote class="prompt-tip"><div><p>由于反射会额外消耗一定的系统资源，因此如果不需要动态地创建一个对象，那么就不需要用反射。 另外，反射调用方法时可以忽略权限检查，因此可能会破坏封装性而导致安全问题。</p></div></blockquote><h2 id="获得-class-对象"><span class="mr-2">获得 Class 对象</span><a href="#获得-class-对象" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><p>方法有三种: 使用 Class 类的 forName 静态方法:</p><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre><span class="kd">public</span> <span class="kd">static</span> <span class="nc">Class</span><span class="o">&lt;?&gt;</span> <span class="n">forName</span><span class="o">(</span><span class="nc">String</span> <span class="n">className</span><span class="o">)</span>
<span class="c1">//比如在 JDBC 开发中常用此方法加载数据库驱动:</span>
<span class="nc">Class</span><span class="o">.</span><span class="na">forName</span><span class="o">(</span><span class="n">driver</span><span class="o">);</span>
</pre></table></code></div></div><p>直接获取某一个对象的 class，比如:</p><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre><span class="nc">Class</span><span class="o">&lt;?&gt;</span> <span class="n">klass</span> <span class="o">=</span> <span class="kt">int</span><span class="o">.</span><span class="na">class</span><span class="o">;</span>
<span class="nc">Class</span><span class="o">&lt;?&gt;</span> <span class="n">classInt</span> <span class="o">=</span> <span class="nc">Integer</span><span class="o">.</span><span class="na">TYPE</span><span class="o">;</span>
</pre></table></code></div></div><p>调用某个对象的 getClass() 方法，比如:</p><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre><span class="nc">StringBuilder</span> <span class="n">str</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">StringBuilder</span><span class="o">(</span><span class="s">"123"</span><span class="o">);</span>
<span class="nc">Class</span><span class="o">&lt;?&gt;</span> <span class="n">klass</span> <span class="o">=</span> <span class="n">str</span><span class="o">.</span><span class="na">getClass</span><span class="o">();</span>
</pre></table></code></div></div><h2 id="判断是否为某个类的实例"><span class="mr-2">判断是否为某个类的实例</span><a href="#判断是否为某个类的实例" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><p>一般地，我们用 instanceof 关键字来判断是否为某个类的实例。同时我们也可以借助反射中 Class 对象的 isInstance() 方法来判断是否为某个类的实例，它是一个 native 方法：</p><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="kd">public</span> <span class="kd">native</span> <span class="kt">boolean</span> <span class="nf">isInstance</span><span class="o">(</span><span class="nc">Object</span> <span class="n">obj</span><span class="o">);</span>
</pre></table></code></div></div><h2 id="创建实例"><span class="mr-2">创建实例</span><a href="#创建实例" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><p>通过反射来生成对象主要有两种方式。 使用Class对象的newInstance()方法来创建Class对象对应类的实例</p><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre><span class="nc">Class</span><span class="o">&lt;?&gt;</span> <span class="n">c</span> <span class="o">=</span> <span class="nc">String</span><span class="o">.</span><span class="na">class</span><span class="o">;</span>
<span class="nc">Object</span> <span class="n">str</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="na">newInstance</span><span class="o">();</span>

</pre></table></code></div></div><p>先通过Class对象获取指定的Constructor对象，再调用Constructor对象的newInstance()方法来创建实例。这种方法可以用指定的构造器构造类的实例</p><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre><td class="rouge-code"><pre><span class="c1">//获取String所对应的Class对象</span>
<span class="nc">Class</span><span class="o">&lt;?&gt;</span> <span class="n">c</span> <span class="o">=</span> <span class="nc">String</span><span class="o">.</span><span class="na">class</span><span class="o">;</span>
<span class="c1">//获取String类带一个String参数的构造器</span>
<span class="nc">Constructor</span> <span class="n">constructor</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="na">getConstructor</span><span class="o">(</span><span class="nc">String</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
<span class="c1">//根据构造器创建实例</span>
<span class="nc">Object</span> <span class="n">obj</span> <span class="o">=</span> <span class="n">constructor</span><span class="o">.</span><span class="na">newInstance</span><span class="o">(</span><span class="s">"23333"</span><span class="o">);</span>
<span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">obj</span><span class="o">);</span>
</pre></table></code></div></div><h2 id="获取方法"><span class="mr-2">获取方法</span><a href="#获取方法" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><p>获取某个Class对象的方法集合，主要有以下几个方法：</p><p>getDeclaredMethods 方法返回类或接口声明的所有方法，包括公共、保护、默认（包）访问和私有方法，但不包括继承的方法。</p><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="kd">public</span> <span class="nc">Method</span><span class="o">[]</span> <span class="nf">getDeclaredMethods</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">SecurityException</span>
</pre></table></code></div></div><p>getMethods 方法返回某个类的所有公用（public）方法，包括其继承类的公用方法。</p><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="kd">public</span> <span class="nc">Method</span><span class="o">[]</span> <span class="nf">getMethods</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">SecurityException</span>
</pre></table></code></div></div><p>getMethod 方法返回一个特定的方法，其中第一个参数为方法名称，后面的参数为方法的参数对应Class的对象。</p><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="kd">public</span> <span class="nc">Method</span> <span class="nf">getMethod</span><span class="o">(</span><span class="nc">String</span> <span class="n">name</span><span class="o">,</span> <span class="nc">Class</span><span class="o">&lt;?&gt;...</span> <span class="n">parameterTypes</span><span class="o">)</span>
</pre></table></code></div></div><p>只是这样描述的话可能难以理解，我们用例子来理解这三个方法：</p><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
</pre><td class="rouge-code"><pre><span class="kd">public</span> <span class="kd">class</span> <span class="nc">test1</span> <span class="o">{</span>
	<span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">test</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">IllegalAccessException</span><span class="o">,</span> <span class="nc">InstantiationException</span><span class="o">,</span> <span class="nc">NoSuchMethodException</span><span class="o">,</span> <span class="nc">InvocationTargetException</span> <span class="o">{</span>
	        <span class="nc">Class</span><span class="o">&lt;?&gt;</span> <span class="n">c</span> <span class="o">=</span> <span class="n">methodClass</span><span class="o">.</span><span class="na">class</span><span class="o">;</span>
	        <span class="nc">Object</span> <span class="n">object</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="na">newInstance</span><span class="o">();</span>
	        <span class="nc">Method</span><span class="o">[]</span> <span class="n">methods</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="na">getMethods</span><span class="o">();</span>
	        <span class="nc">Method</span><span class="o">[]</span> <span class="n">declaredMethods</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="na">getDeclaredMethods</span><span class="o">();</span>
	        <span class="c1">//获取methodClass类的add方法</span>
	        <span class="nc">Method</span> <span class="n">method</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="na">getMethod</span><span class="o">(</span><span class="s">"add"</span><span class="o">,</span> <span class="kt">int</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="kt">int</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
	        <span class="c1">//getMethods()方法获取的所有方法</span>
	        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"getMethods获取的方法："</span><span class="o">);</span>
	        <span class="k">for</span><span class="o">(</span><span class="nc">Method</span> <span class="nl">m:</span><span class="n">methods</span><span class="o">)</span>
	            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">m</span><span class="o">);</span>
	        <span class="c1">//getDeclaredMethods()方法获取的所有方法</span>
	        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"getDeclaredMethods获取的方法："</span><span class="o">);</span>
	        <span class="k">for</span><span class="o">(</span><span class="nc">Method</span> <span class="nl">m:</span><span class="n">declaredMethods</span><span class="o">)</span>
	            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">m</span><span class="o">);</span>
	    <span class="o">}</span>
    <span class="o">}</span>
<span class="kd">class</span> <span class="nc">methodClass</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">fuck</span> <span class="o">=</span> <span class="mi">3</span><span class="o">;</span>
    <span class="kd">public</span> <span class="kt">int</span> <span class="nf">add</span><span class="o">(</span><span class="kt">int</span> <span class="n">a</span><span class="o">,</span><span class="kt">int</span> <span class="n">b</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">a</span><span class="o">+</span><span class="n">b</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="kd">public</span> <span class="kt">int</span> <span class="nf">sub</span><span class="o">(</span><span class="kt">int</span> <span class="n">a</span><span class="o">,</span><span class="kt">int</span> <span class="n">b</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">a</span><span class="o">+</span><span class="n">b</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></table></code></div></div><p>程序运行的结果如下:</p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
</pre><td class="rouge-code"><pre>getMethods获取的方法：
public int org.Optimus-Xs.common.methodClass.add(int,int)
public int org.Optimus-Xs.common.methodClass.sub(int,int)
public final void java.lang.Object.wait() throws java.lang.InterruptedException
public final void java.lang.Object.wait(long,int) throws java.lang.InterruptedException
public final native void java.lang.Object.wait(long) throws java.lang.InterruptedException
public boolean java.lang.Object.equals(java.lang.Object)
public java.lang.String java.lang.Object.toString()
public native int java.lang.Object.hashCode()
public final native java.lang.Class java.lang.Object.getClass()
public final native void java.lang.Object.notify()
public final native void java.lang.Object.notifyAll()
getDeclaredMethods获取的方法：
public int org.Optimus-Xs.common.methodClass.add(int,int)
public int org.Optimus-Xs.common.methodClass.sub(int,int)
</pre></table></code></div></div><p>可以看到，通过 getMethods() 获取的方法可以获取到父类的方法,比如 java.lang.Object 下定义的各个方法。</p><h2 id="获取构造器信息"><span class="mr-2">获取构造器信息</span><a href="#获取构造器信息" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><p>获取类构造器的用法与上述获取方法的用法类似。主要是通过Class类的getConstructor方法得到Constructor类的一个实例，而Constructor类有一个newInstance方法可以创建一个对象实例:</p><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="kd">public</span> <span class="no">T</span> <span class="nf">newInstance</span><span class="o">(</span><span class="nc">Object</span> <span class="o">...</span> <span class="n">initargs</span><span class="o">)</span>
</pre></table></code></div></div><p>此方法可以根据传入的参数来调用对应的Constructor创建对象实例</p><h2 id="获取类的成员变量字段信息"><span class="mr-2">获取类的成员变量（字段）信息</span><a href="#获取类的成员变量字段信息" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><p>主要是这几个方法，在此不再赘述：</p><ul><li>getFiled：访问公有的成员变量<li>getDeclaredField：所有已声明的成员变量，但不能得到其父类的成员变量</ul><p>getFileds 和 getDeclaredFields 方法用法同上（参照 Method）</p><h2 id="调用方法"><span class="mr-2">调用方法</span><a href="#调用方法" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><p>当我们从类中获取了一个方法后，我们就可以用 invoke() 方法来调用这个方法。invoke 方法的原型为:</p><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre><span class="kd">public</span> <span class="nc">Object</span> <span class="nf">invoke</span><span class="o">(</span><span class="nc">Object</span> <span class="n">obj</span><span class="o">,</span> <span class="nc">Object</span><span class="o">...</span> <span class="n">args</span><span class="o">)</span>
        <span class="kd">throws</span> <span class="nc">IllegalAccessException</span><span class="o">,</span> <span class="nc">IllegalArgumentException</span><span class="o">,</span>
           <span class="nc">InvocationTargetException</span>
</pre></table></code></div></div><p>下面是一个实例</p><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
</pre><td class="rouge-code"><pre><span class="kd">public</span> <span class="kd">class</span> <span class="nc">test1</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">IllegalAccessException</span><span class="o">,</span> <span class="nc">InstantiationException</span><span class="o">,</span> <span class="nc">NoSuchMethodException</span><span class="o">,</span> <span class="nc">InvocationTargetException</span> <span class="o">{</span>
        <span class="nc">Class</span><span class="o">&lt;?&gt;</span> <span class="n">klass</span> <span class="o">=</span> <span class="n">methodClass</span><span class="o">.</span><span class="na">class</span><span class="o">;</span>
        <span class="c1">//创建methodClass的实例</span>
        <span class="nc">Object</span> <span class="n">obj</span> <span class="o">=</span> <span class="n">klass</span><span class="o">.</span><span class="na">newInstance</span><span class="o">();</span>
        <span class="c1">//获取methodClass类的add方法</span>
        <span class="nc">Method</span> <span class="n">method</span> <span class="o">=</span> <span class="n">klass</span><span class="o">.</span><span class="na">getMethod</span><span class="o">(</span><span class="s">"add"</span><span class="o">,</span><span class="kt">int</span><span class="o">.</span><span class="na">class</span><span class="o">,</span><span class="kt">int</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
        <span class="c1">//调用method对应的方法 =&gt; add(1,4)</span>
        <span class="nc">Object</span> <span class="n">result</span> <span class="o">=</span> <span class="n">method</span><span class="o">.</span><span class="na">invoke</span><span class="o">(</span><span class="n">obj</span><span class="o">,</span><span class="mi">1</span><span class="o">,</span><span class="mi">4</span><span class="o">);</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">result</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
<span class="kd">class</span> <span class="nc">methodClass</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">fuck</span> <span class="o">=</span> <span class="mi">3</span><span class="o">;</span>
    <span class="kd">public</span> <span class="kt">int</span> <span class="nf">add</span><span class="o">(</span><span class="kt">int</span> <span class="n">a</span><span class="o">,</span><span class="kt">int</span> <span class="n">b</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">a</span><span class="o">+</span><span class="n">b</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="kd">public</span> <span class="kt">int</span> <span class="nf">sub</span><span class="o">(</span><span class="kt">int</span> <span class="n">a</span><span class="o">,</span><span class="kt">int</span> <span class="n">b</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">a</span><span class="o">+</span><span class="n">b</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></table></code></div></div><h2 id="利用反射创建数组"><span class="mr-2">利用反射创建数组</span><a href="#利用反射创建数组" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><p>数组在Java里是比较特殊的一种类型，它可以赋值给一个Object Reference。下面我们看一看利用反射创建数组的例子：</p><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
</pre><td class="rouge-code"><pre><span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">testArray</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">ClassNotFoundException</span> <span class="o">{</span>
    <span class="nc">Class</span><span class="o">&lt;?&gt;</span> <span class="n">cls</span> <span class="o">=</span> <span class="nc">Class</span><span class="o">.</span><span class="na">forName</span><span class="o">(</span><span class="s">"java.lang.String"</span><span class="o">);</span>
    <span class="nc">Object</span> <span class="n">array</span> <span class="o">=</span> <span class="nc">Array</span><span class="o">.</span><span class="na">newInstance</span><span class="o">(</span><span class="n">cls</span><span class="o">,</span><span class="mi">25</span><span class="o">);</span>
    <span class="c1">//往数组里添加内容</span>
    <span class="nc">Array</span><span class="o">.</span><span class="na">set</span><span class="o">(</span><span class="n">array</span><span class="o">,</span><span class="mi">0</span><span class="o">,</span><span class="s">"hello"</span><span class="o">);</span>
    <span class="nc">Array</span><span class="o">.</span><span class="na">set</span><span class="o">(</span><span class="n">array</span><span class="o">,</span><span class="mi">1</span><span class="o">,</span><span class="s">"Java"</span><span class="o">);</span>
    <span class="nc">Array</span><span class="o">.</span><span class="na">set</span><span class="o">(</span><span class="n">array</span><span class="o">,</span><span class="mi">2</span><span class="o">,</span><span class="s">"fuck"</span><span class="o">);</span>
    <span class="nc">Array</span><span class="o">.</span><span class="na">set</span><span class="o">(</span><span class="n">array</span><span class="o">,</span><span class="mi">3</span><span class="o">,</span><span class="s">"Scala"</span><span class="o">);</span>
    <span class="nc">Array</span><span class="o">.</span><span class="na">set</span><span class="o">(</span><span class="n">array</span><span class="o">,</span><span class="mi">4</span><span class="o">,</span><span class="s">"Clojure"</span><span class="o">);</span>
    <span class="c1">//获取某一项的内容</span>
    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="nc">Array</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">array</span><span class="o">,</span><span class="mi">3</span><span class="o">));</span>
<span class="o">}</span>
</pre></table></code></div></div><p>其中的Array类为java.lang.reflect.Array类。我们通过Array.newInstance()创建数组对象，它的原型是:</p><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre><span class="kd">public</span> <span class="kd">static</span> <span class="nc">Object</span> <span class="nf">newInstance</span><span class="o">(</span><span class="nc">Class</span><span class="o">&lt;?&gt;</span> <span class="n">componentType</span><span class="o">,</span> <span class="kt">int</span> <span class="n">length</span><span class="o">)</span>
    <span class="kd">throws</span> <span class="nc">NegativeArraySizeException</span> <span class="o">{</span>
    <span class="k">return</span> <span class="nf">newArray</span><span class="o">(</span><span class="n">componentType</span><span class="o">,</span> <span class="n">length</span><span class="o">);</span>
<span class="o">}</span>
</pre></table></code></div></div><p>而 newArray 方法是一个 native 方法，它在 HotSpot JVM 里的具体实现我们后边再研究，这里先把源码贴出来：</p><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="kd">private</span> <span class="kd">static</span> <span class="kd">native</span> <span class="nc">Object</span> <span class="nf">newArray</span><span class="o">(</span><span class="nc">Class</span><span class="o">&lt;?&gt;</span> <span class="n">componentType</span><span class="o">,</span> <span class="kt">int</span> <span class="n">length</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">NegativeArraySizeException</span><span class="o">;</span>
</pre></table></code></div></div><div file="openjdk\hotspot\src\share\vm\runtime\reflection.cpp" class="language-c++ highlighter-rouge"><div class="code-header"> <span data-label-text="openjdk\hotspot\src\share\vm\runtime\reflection.cpp"><i class="far fa-file-code"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
</pre><td class="rouge-code"><pre><span class="n">arrayOop</span> <span class="n">Reflection</span><span class="o">::</span><span class="n">reflect_new_array</span><span class="p">(</span><span class="n">oop</span> <span class="n">element_mirror</span><span class="p">,</span> <span class="n">jint</span> <span class="n">length</span><span class="p">,</span> <span class="n">TRAPS</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">element_mirror</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">THROW_0</span><span class="p">(</span><span class="n">vmSymbols</span><span class="o">::</span><span class="n">java_lang_NullPointerException</span><span class="p">());</span>
  <span class="p">}</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">length</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">THROW_0</span><span class="p">(</span><span class="n">vmSymbols</span><span class="o">::</span><span class="n">java_lang_NegativeArraySizeException</span><span class="p">());</span>
  <span class="p">}</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">java_lang_Class</span><span class="o">::</span><span class="n">is_primitive</span><span class="p">(</span><span class="n">element_mirror</span><span class="p">))</span> <span class="p">{</span>
    <span class="n">Klass</span><span class="o">*</span> <span class="n">tak</span> <span class="o">=</span> <span class="n">basic_type_mirror_to_arrayklass</span><span class="p">(</span><span class="n">element_mirror</span><span class="p">,</span> <span class="n">CHECK_NULL</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">TypeArrayKlass</span><span class="o">::</span><span class="n">cast</span><span class="p">(</span><span class="n">tak</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">allocate</span><span class="p">(</span><span class="n">length</span><span class="p">,</span> <span class="n">THREAD</span><span class="p">);</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="n">Klass</span><span class="o">*</span> <span class="n">k</span> <span class="o">=</span> <span class="n">java_lang_Class</span><span class="o">::</span><span class="n">as_Klass</span><span class="p">(</span><span class="n">element_mirror</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">k</span><span class="o">-&gt;</span><span class="n">oop_is_array</span><span class="p">()</span> <span class="o">&amp;&amp;</span> <span class="n">ArrayKlass</span><span class="o">::</span><span class="n">cast</span><span class="p">(</span><span class="n">k</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">dimension</span><span class="p">()</span> <span class="o">&gt;=</span> <span class="n">MAX_DIM</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">THROW_0</span><span class="p">(</span><span class="n">vmSymbols</span><span class="o">::</span><span class="n">java_lang_IllegalArgumentException</span><span class="p">());</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">oopFactory</span><span class="o">::</span><span class="n">new_objArray</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">length</span><span class="p">,</span> <span class="n">THREAD</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></table></code></div></div><blockquote class="prompt-tip"><div><p>另外，Array 类的 set 和 get 方法都为 native 方法，在 HotSpot JVM 里分别对应 Reflection::array_set 和 Reflection::array_get 方法</p></div></blockquote><h1 id="反射机制执行的流程">反射机制执行的流程</h1><p>先看个例子</p><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
</pre><td class="rouge-code"><pre><span class="kd">public</span> <span class="kd">class</span> <span class="nc">HelloReflect</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="c1">// 1. 使用外部配置的实现，进行动态加载类</span>
            <span class="nc">TempFunctionTest</span> <span class="n">test</span> <span class="o">=</span> <span class="o">(</span><span class="nc">TempFunctionTest</span><span class="o">)</span><span class="nc">Class</span><span class="o">.</span><span class="na">forName</span><span class="o">(</span><span class="s">"com.tester.HelloReflect"</span><span class="o">).</span><span class="na">newInstance</span><span class="o">();</span>
            <span class="n">test</span><span class="o">.</span><span class="na">sayHello</span><span class="o">(</span><span class="s">"call directly"</span><span class="o">);</span>
            <span class="c1">// 2. 根据配置的函数名，进行方法调用（不需要通用的接口抽象）</span>
            <span class="nc">Object</span> <span class="n">t2</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">TempFunctionTest</span><span class="o">();</span>
            <span class="nc">Method</span> <span class="n">method</span> <span class="o">=</span> <span class="n">t2</span><span class="o">.</span><span class="na">getClass</span><span class="o">().</span><span class="na">getDeclaredMethod</span><span class="o">(</span><span class="s">"sayHello"</span><span class="o">,</span> <span class="nc">String</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
            <span class="n">method</span><span class="o">.</span><span class="na">invoke</span><span class="o">(</span><span class="n">test</span><span class="o">,</span> <span class="s">"method invoke"</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">ClassNotFoundException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">InstantiationException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">IllegalAccessException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">NoSuchMethodException</span> <span class="n">e</span> <span class="o">)</span> <span class="o">{</span>
            <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">InvocationTargetException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
        <span class="o">}</span>
    <span class="o">}</span>
    
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">sayHello</span><span class="o">(</span><span class="nc">String</span> <span class="n">word</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"hello,"</span> <span class="o">+</span> <span class="n">word</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></table></code></div></div><p>来看执行流程</p><p><img data-src="https://i.ibb.co/Bn4RDYt/java-basic-reflection-1.png" alt="执行流程" data-proofer-ignore></p><h2 id="反射获取类实例"><span class="mr-2">反射获取类实例</span><a href="#反射获取类实例" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><p>首先调用了 java.lang.Class 的静态方法，获取类信息。</p><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre><td class="rouge-code"><pre>    <span class="nd">@CallerSensitive</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="nc">Class</span><span class="o">&lt;?&gt;</span> <span class="n">forName</span><span class="o">(</span><span class="nc">String</span> <span class="n">className</span><span class="o">)</span>
                <span class="kd">throws</span> <span class="nc">ClassNotFoundException</span> <span class="o">{</span>
        <span class="c1">// 先通过反射，获取调用进来的类信息，从而获取当前的 classLoader</span>
        <span class="nc">Class</span><span class="o">&lt;?&gt;</span> <span class="n">caller</span> <span class="o">=</span> <span class="nc">Reflection</span><span class="o">.</span><span class="na">getCallerClass</span><span class="o">();</span>
        <span class="c1">// 调用native方法进行获取class信息</span>
        <span class="k">return</span> <span class="nf">forName0</span><span class="o">(</span><span class="n">className</span><span class="o">,</span> <span class="kc">true</span><span class="o">,</span> <span class="nc">ClassLoader</span><span class="o">.</span><span class="na">getClassLoader</span><span class="o">(</span><span class="n">caller</span><span class="o">),</span> <span class="n">caller</span><span class="o">);</span>
    <span class="o">}</span>
</pre></table></code></div></div><p>forName()反射获取类信息，并没有将实现留给了java,而是交给了jvm去加载。</p><p>主要是先获取 ClassLoader, 然后调用 native 方法，获取信息，加载类则是回调 java.lang.ClassLoader.</p><p>最后，jvm又会回调 ClassLoader 进类加载。</p><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
</pre><td class="rouge-code"><pre>
    <span class="c1">// </span>
    <span class="kd">public</span> <span class="nc">Class</span><span class="o">&lt;?&gt;</span> <span class="n">loadClass</span><span class="o">(</span><span class="nc">String</span> <span class="n">name</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">ClassNotFoundException</span> <span class="o">{</span>
        <span class="k">return</span> <span class="nf">loadClass</span><span class="o">(</span><span class="n">name</span><span class="o">,</span> <span class="kc">false</span><span class="o">);</span>
    <span class="o">}</span>
    
        <span class="c1">// sun.misc.Launcher</span>
        <span class="kd">public</span> <span class="nc">Class</span><span class="o">&lt;?&gt;</span> <span class="n">loadClass</span><span class="o">(</span><span class="nc">String</span> <span class="n">var1</span><span class="o">,</span> <span class="kt">boolean</span> <span class="n">var2</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">ClassNotFoundException</span> <span class="o">{</span>
            <span class="kt">int</span> <span class="n">var3</span> <span class="o">=</span> <span class="n">var1</span><span class="o">.</span><span class="na">lastIndexOf</span><span class="o">(</span><span class="mi">46</span><span class="o">);</span>
            <span class="k">if</span><span class="o">(</span><span class="n">var3</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="o">)</span> <span class="o">{</span>
                <span class="nc">SecurityManager</span> <span class="n">var4</span> <span class="o">=</span> <span class="nc">System</span><span class="o">.</span><span class="na">getSecurityManager</span><span class="o">();</span>
                <span class="k">if</span><span class="o">(</span><span class="n">var4</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                    <span class="n">var4</span><span class="o">.</span><span class="na">checkPackageAccess</span><span class="o">(</span><span class="n">var1</span><span class="o">.</span><span class="na">substring</span><span class="o">(</span><span class="mi">0</span><span class="o">,</span> <span class="n">var3</span><span class="o">));</span>
                <span class="o">}</span>
            <span class="o">}</span>

            <span class="k">if</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">ucp</span><span class="o">.</span><span class="na">knownToNotExist</span><span class="o">(</span><span class="n">var1</span><span class="o">))</span> <span class="o">{</span>
                <span class="nc">Class</span> <span class="n">var5</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">findLoadedClass</span><span class="o">(</span><span class="n">var1</span><span class="o">);</span>
                <span class="k">if</span><span class="o">(</span><span class="n">var5</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                    <span class="k">if</span><span class="o">(</span><span class="n">var2</span><span class="o">)</span> <span class="o">{</span>
                        <span class="k">this</span><span class="o">.</span><span class="na">resolveClass</span><span class="o">(</span><span class="n">var5</span><span class="o">);</span>
                    <span class="o">}</span>

                    <span class="k">return</span> <span class="n">var5</span><span class="o">;</span>
                <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
                    <span class="k">throw</span> <span class="k">new</span> <span class="nf">ClassNotFoundException</span><span class="o">(</span><span class="n">var1</span><span class="o">);</span>
                <span class="o">}</span>
            <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
                <span class="k">return</span> <span class="kd">super</span><span class="o">.</span><span class="na">loadClass</span><span class="o">(</span><span class="n">var1</span><span class="o">,</span> <span class="n">var2</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="c1">// java.lang.ClassLoader</span>
    <span class="kd">protected</span> <span class="nc">Class</span><span class="o">&lt;?&gt;</span> <span class="n">loadClass</span><span class="o">(</span><span class="nc">String</span> <span class="n">name</span><span class="o">,</span> <span class="kt">boolean</span> <span class="n">resolve</span><span class="o">)</span>
        <span class="kd">throws</span> <span class="nc">ClassNotFoundException</span>
    <span class="o">{</span>
        <span class="c1">// 先获取锁</span>
        <span class="kd">synchronized</span> <span class="o">(</span><span class="n">getClassLoadingLock</span><span class="o">(</span><span class="n">name</span><span class="o">))</span> <span class="o">{</span>
            <span class="c1">// First, check if the class has already been loaded</span>
            <span class="c1">// 如果已经加载了的话，就不用再加载了</span>
            <span class="nc">Class</span><span class="o">&lt;?&gt;</span> <span class="n">c</span> <span class="o">=</span> <span class="n">findLoadedClass</span><span class="o">(</span><span class="n">name</span><span class="o">);</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">c</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                <span class="kt">long</span> <span class="n">t0</span> <span class="o">=</span> <span class="nc">System</span><span class="o">.</span><span class="na">nanoTime</span><span class="o">();</span>
                <span class="k">try</span> <span class="o">{</span>
                    <span class="c1">// 双亲委托加载</span>
                    <span class="k">if</span> <span class="o">(</span><span class="n">parent</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                        <span class="n">c</span> <span class="o">=</span> <span class="n">parent</span><span class="o">.</span><span class="na">loadClass</span><span class="o">(</span><span class="n">name</span><span class="o">,</span> <span class="kc">false</span><span class="o">);</span>
                    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
                        <span class="n">c</span> <span class="o">=</span> <span class="n">findBootstrapClassOrNull</span><span class="o">(</span><span class="n">name</span><span class="o">);</span>
                    <span class="o">}</span>
                <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">ClassNotFoundException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                    <span class="c1">// ClassNotFoundException thrown if class not found</span>
                    <span class="c1">// from the non-null parent class loader</span>
                <span class="o">}</span>

                <span class="c1">// 父类没有加载到时，再自己加载</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">c</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                    <span class="c1">// If still not found, then invoke findClass in order</span>
                    <span class="c1">// to find the class.</span>
                    <span class="kt">long</span> <span class="n">t1</span> <span class="o">=</span> <span class="nc">System</span><span class="o">.</span><span class="na">nanoTime</span><span class="o">();</span>
                    <span class="n">c</span> <span class="o">=</span> <span class="n">findClass</span><span class="o">(</span><span class="n">name</span><span class="o">);</span>

                    <span class="c1">// this is the defining class loader; record the stats</span>
                    <span class="n">sun</span><span class="o">.</span><span class="na">misc</span><span class="o">.</span><span class="na">PerfCounter</span><span class="o">.</span><span class="na">getParentDelegationTime</span><span class="o">().</span><span class="na">addTime</span><span class="o">(</span><span class="n">t1</span> <span class="o">-</span> <span class="n">t0</span><span class="o">);</span>
                    <span class="n">sun</span><span class="o">.</span><span class="na">misc</span><span class="o">.</span><span class="na">PerfCounter</span><span class="o">.</span><span class="na">getFindClassTime</span><span class="o">().</span><span class="na">addElapsedTimeFrom</span><span class="o">(</span><span class="n">t1</span><span class="o">);</span>
                    <span class="n">sun</span><span class="o">.</span><span class="na">misc</span><span class="o">.</span><span class="na">PerfCounter</span><span class="o">.</span><span class="na">getFindClasses</span><span class="o">().</span><span class="na">increment</span><span class="o">();</span>
                <span class="o">}</span>
            <span class="o">}</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">resolve</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">resolveClass</span><span class="o">(</span><span class="n">c</span><span class="o">);</span>
            <span class="o">}</span>
            <span class="k">return</span> <span class="n">c</span><span class="o">;</span>
        <span class="o">}</span>
    <span class="o">}</span>
    
    <span class="kd">protected</span> <span class="nc">Object</span> <span class="nf">getClassLoadingLock</span><span class="o">(</span><span class="nc">String</span> <span class="n">className</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">Object</span> <span class="n">lock</span> <span class="o">=</span> <span class="k">this</span><span class="o">;</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">parallelLockMap</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="c1">// 使用 ConcurrentHashMap来保存锁</span>
            <span class="nc">Object</span> <span class="n">newLock</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Object</span><span class="o">();</span>
            <span class="n">lock</span> <span class="o">=</span> <span class="n">parallelLockMap</span><span class="o">.</span><span class="na">putIfAbsent</span><span class="o">(</span><span class="n">className</span><span class="o">,</span> <span class="n">newLock</span><span class="o">);</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">lock</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">lock</span> <span class="o">=</span> <span class="n">newLock</span><span class="o">;</span>
            <span class="o">}</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="n">lock</span><span class="o">;</span>
    <span class="o">}</span>
    
    <span class="kd">protected</span> <span class="kd">final</span> <span class="nc">Class</span><span class="o">&lt;?&gt;</span> <span class="n">findLoadedClass</span><span class="o">(</span><span class="nc">String</span> <span class="n">name</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(!</span><span class="n">checkName</span><span class="o">(</span><span class="n">name</span><span class="o">))</span>
            <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
        <span class="k">return</span> <span class="nf">findLoadedClass0</span><span class="o">(</span><span class="n">name</span><span class="o">);</span>
    <span class="o">}</span>
</pre></table></code></div></div><p>下面来看一下 newInstance() 的实现方式。</p><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
</pre><td class="rouge-code"><pre>    <span class="c1">// 首先肯定是 Class.newInstance</span>
    <span class="nd">@CallerSensitive</span>
    <span class="kd">public</span> <span class="no">T</span> <span class="nf">newInstance</span><span class="o">()</span>
        <span class="kd">throws</span> <span class="nc">InstantiationException</span><span class="o">,</span> <span class="nc">IllegalAccessException</span>
    <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="nc">System</span><span class="o">.</span><span class="na">getSecurityManager</span><span class="o">()</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">checkMemberAccess</span><span class="o">(</span><span class="nc">Member</span><span class="o">.</span><span class="na">PUBLIC</span><span class="o">,</span> <span class="nc">Reflection</span><span class="o">.</span><span class="na">getCallerClass</span><span class="o">(),</span> <span class="kc">false</span><span class="o">);</span>
        <span class="o">}</span>

        <span class="c1">// NOTE: the following code may not be strictly correct under</span>
        <span class="c1">// the current Java memory model.</span>

        <span class="c1">// Constructor lookup</span>
        <span class="c1">// newInstance() 其实相当于调用类的无参构造函数，所以，首先要找到其无参构造器</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">cachedConstructor</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">if</span> <span class="o">(</span><span class="k">this</span> <span class="o">==</span> <span class="nc">Class</span><span class="o">.</span><span class="na">class</span><span class="o">)</span> <span class="o">{</span>
                <span class="c1">// 不允许调用 Class 的 newInstance() 方法</span>
                <span class="k">throw</span> <span class="k">new</span> <span class="nf">IllegalAccessException</span><span class="o">(</span>
                    <span class="s">"Can not call newInstance() on the Class for java.lang.Class"</span>
                <span class="o">);</span>
            <span class="o">}</span>
            <span class="k">try</span> <span class="o">{</span>
                <span class="c1">// 获取无参构造器</span>
                <span class="nc">Class</span><span class="o">&lt;?&gt;[]</span> <span class="n">empty</span> <span class="o">=</span> <span class="o">{};</span>
                <span class="kd">final</span> <span class="nc">Constructor</span><span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;</span> <span class="n">c</span> <span class="o">=</span> <span class="n">getConstructor0</span><span class="o">(</span><span class="n">empty</span><span class="o">,</span> <span class="nc">Member</span><span class="o">.</span><span class="na">DECLARED</span><span class="o">);</span>
                <span class="c1">// Disable accessibility checks on the constructor</span>
                <span class="c1">// since we have to do the security check here anyway</span>
                <span class="c1">// (the stack depth is wrong for the Constructor's</span>
                <span class="c1">// security check to work)</span>
                <span class="n">java</span><span class="o">.</span><span class="na">security</span><span class="o">.</span><span class="na">AccessController</span><span class="o">.</span><span class="na">doPrivileged</span><span class="o">(</span>
                    <span class="k">new</span> <span class="n">java</span><span class="o">.</span><span class="na">security</span><span class="o">.</span><span class="na">PrivilegedAction</span><span class="o">&lt;</span><span class="nc">Void</span><span class="o">&gt;()</span> <span class="o">{</span>
                        <span class="kd">public</span> <span class="nc">Void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
                                <span class="n">c</span><span class="o">.</span><span class="na">setAccessible</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
                                <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
                            <span class="o">}</span>
                        <span class="o">});</span>
                <span class="n">cachedConstructor</span> <span class="o">=</span> <span class="n">c</span><span class="o">;</span>
            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">NoSuchMethodException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">throw</span> <span class="o">(</span><span class="nc">InstantiationException</span><span class="o">)</span>
                    <span class="k">new</span> <span class="nf">InstantiationException</span><span class="o">(</span><span class="n">getName</span><span class="o">()).</span><span class="na">initCause</span><span class="o">(</span><span class="n">e</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">}</span>
        <span class="nc">Constructor</span><span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;</span> <span class="n">tmpConstructor</span> <span class="o">=</span> <span class="n">cachedConstructor</span><span class="o">;</span>
        <span class="c1">// Security check (same as in java.lang.reflect.Constructor)</span>
        <span class="kt">int</span> <span class="n">modifiers</span> <span class="o">=</span> <span class="n">tmpConstructor</span><span class="o">.</span><span class="na">getModifiers</span><span class="o">();</span>
        <span class="k">if</span> <span class="o">(!</span><span class="nc">Reflection</span><span class="o">.</span><span class="na">quickCheckMemberAccess</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="n">modifiers</span><span class="o">))</span> <span class="o">{</span>
            <span class="nc">Class</span><span class="o">&lt;?&gt;</span> <span class="n">caller</span> <span class="o">=</span> <span class="nc">Reflection</span><span class="o">.</span><span class="na">getCallerClass</span><span class="o">();</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">newInstanceCallerCache</span> <span class="o">!=</span> <span class="n">caller</span><span class="o">)</span> <span class="o">{</span>
                <span class="nc">Reflection</span><span class="o">.</span><span class="na">ensureMemberAccess</span><span class="o">(</span><span class="n">caller</span><span class="o">,</span> <span class="k">this</span><span class="o">,</span> <span class="kc">null</span><span class="o">,</span> <span class="n">modifiers</span><span class="o">);</span>
                <span class="n">newInstanceCallerCache</span> <span class="o">=</span> <span class="n">caller</span><span class="o">;</span>
            <span class="o">}</span>
        <span class="o">}</span>
        <span class="c1">// Run constructor</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="c1">// 调用无参构造器</span>
            <span class="k">return</span> <span class="n">tmpConstructor</span><span class="o">.</span><span class="na">newInstance</span><span class="o">((</span><span class="nc">Object</span><span class="o">[])</span><span class="kc">null</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">InvocationTargetException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="nc">Unsafe</span><span class="o">.</span><span class="na">getUnsafe</span><span class="o">().</span><span class="na">throwException</span><span class="o">(</span><span class="n">e</span><span class="o">.</span><span class="na">getTargetException</span><span class="o">());</span>
            <span class="c1">// Not reached</span>
            <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
        <span class="o">}</span>
    <span class="o">}</span>
</pre></table></code></div></div><p>newInstance() 主要做了三件事：</p><ul><li>权限检测，如果不通过直接抛出异常；<li>查找无参构造器，并将其缓存起来；<li>调用具体方法的无参构造方法，生成实例并返回；</ul><p>下面是获取构造器的过程：</p><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
</pre><td class="rouge-code"><pre><span class="kd">private</span> <span class="nc">Constructor</span><span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;</span> <span class="nf">getConstructor0</span><span class="o">(</span><span class="nc">Class</span><span class="o">&lt;?&gt;[]</span> <span class="n">parameterTypes</span><span class="o">,</span> <span class="kt">int</span> <span class="n">which</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">NoSuchMethodException</span>
<span class="o">{</span>
    <span class="c1">// 获取所有构造器</span>
    <span class="nc">Constructor</span><span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;[]</span> <span class="n">constructors</span> <span class="o">=</span> <span class="n">privateGetDeclaredConstructors</span><span class="o">((</span><span class="n">which</span> <span class="o">==</span> <span class="nc">Member</span><span class="o">.</span><span class="na">PUBLIC</span><span class="o">));</span>
    <span class="k">for</span> <span class="o">(</span><span class="nc">Constructor</span><span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;</span> <span class="n">constructor</span> <span class="o">:</span> <span class="n">constructors</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">arrayContentsEq</span><span class="o">(</span><span class="n">parameterTypes</span><span class="o">,</span>
                            <span class="n">constructor</span><span class="o">.</span><span class="na">getParameterTypes</span><span class="o">()))</span> <span class="o">{</span>
            <span class="k">return</span> <span class="nf">getReflectionFactory</span><span class="o">().</span><span class="na">copyConstructor</span><span class="o">(</span><span class="n">constructor</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>
    <span class="k">throw</span> <span class="k">new</span> <span class="nf">NoSuchMethodException</span><span class="o">(</span><span class="n">getName</span><span class="o">()</span> <span class="o">+</span> <span class="s">".&lt;init&gt;"</span> <span class="o">+</span> <span class="n">argumentTypesToString</span><span class="o">(</span><span class="n">parameterTypes</span><span class="o">));</span>
<span class="o">}</span>
</pre></table></code></div></div><p>getConstructor0() 为获取匹配的构造方器；分三步：</p><ul><li>先获取所有的constructors, 然后通过进行参数类型比较；<li>找到匹配后，通过 ReflectionFactory copy一份constructor返回；<li>否则抛出 NoSuchMethodException;</ul><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
</pre><td class="rouge-code"><pre>
    <span class="c1">// 获取当前类所有的构造方法，通过jvm或者缓存</span>
    <span class="c1">// Returns an array of "root" constructors. These Constructor</span>
    <span class="c1">// objects must NOT be propagated to the outside world, but must</span>
    <span class="c1">// instead be copied via ReflectionFactory.copyConstructor.</span>
    <span class="kd">private</span> <span class="nc">Constructor</span><span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;[]</span> <span class="nf">privateGetDeclaredConstructors</span><span class="o">(</span><span class="kt">boolean</span> <span class="n">publicOnly</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">checkInitted</span><span class="o">();</span>
        <span class="nc">Constructor</span><span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;[]</span> <span class="n">res</span><span class="o">;</span>
        <span class="c1">// 调用 reflectionData(), 获取保存的信息，使用软引用保存，从而使内存不够可以回收</span>
        <span class="nc">ReflectionData</span><span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;</span> <span class="n">rd</span> <span class="o">=</span> <span class="n">reflectionData</span><span class="o">();</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">rd</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">res</span> <span class="o">=</span> <span class="n">publicOnly</span> <span class="o">?</span> <span class="n">rd</span><span class="o">.</span><span class="na">publicConstructors</span> <span class="o">:</span> <span class="n">rd</span><span class="o">.</span><span class="na">declaredConstructors</span><span class="o">;</span>
            <span class="c1">// 存在缓存，则直接返回</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">res</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="k">return</span> <span class="n">res</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="c1">// No cached value available; request value from VM</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">isInterface</span><span class="o">())</span> <span class="o">{</span>
            <span class="nd">@SuppressWarnings</span><span class="o">(</span><span class="s">"unchecked"</span><span class="o">)</span>
            <span class="nc">Constructor</span><span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;[]</span> <span class="n">temporaryRes</span> <span class="o">=</span> <span class="o">(</span><span class="nc">Constructor</span><span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;[])</span> <span class="k">new</span> <span class="nc">Constructor</span><span class="o">&lt;?&gt;[</span><span class="mi">0</span><span class="o">];</span>
            <span class="n">res</span> <span class="o">=</span> <span class="n">temporaryRes</span><span class="o">;</span>
        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
            <span class="c1">// 使用native方法从jvm获取构造器</span>
            <span class="n">res</span> <span class="o">=</span> <span class="n">getDeclaredConstructors0</span><span class="o">(</span><span class="n">publicOnly</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">rd</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="c1">// 最后，将从jvm中读取的内容，存入缓存</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">publicOnly</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">rd</span><span class="o">.</span><span class="na">publicConstructors</span> <span class="o">=</span> <span class="n">res</span><span class="o">;</span>
            <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
                <span class="n">rd</span><span class="o">.</span><span class="na">declaredConstructors</span> <span class="o">=</span> <span class="n">res</span><span class="o">;</span>
            <span class="o">}</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="n">res</span><span class="o">;</span>
    <span class="o">}</span>
    
    <span class="c1">// Lazily create and cache ReflectionData</span>
    <span class="kd">private</span> <span class="nc">ReflectionData</span><span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;</span> <span class="nf">reflectionData</span><span class="o">()</span> <span class="o">{</span>
        <span class="nc">SoftReference</span><span class="o">&lt;</span><span class="nc">ReflectionData</span><span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;&gt;</span> <span class="n">reflectionData</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">reflectionData</span><span class="o">;</span>
        <span class="kt">int</span> <span class="n">classRedefinedCount</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">classRedefinedCount</span><span class="o">;</span>
        <span class="nc">ReflectionData</span><span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;</span> <span class="n">rd</span><span class="o">;</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">useCaches</span> <span class="o">&amp;&amp;</span>
            <span class="n">reflectionData</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span>
            <span class="o">(</span><span class="n">rd</span> <span class="o">=</span> <span class="n">reflectionData</span><span class="o">.</span><span class="na">get</span><span class="o">())</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span>
            <span class="n">rd</span><span class="o">.</span><span class="na">redefinedCount</span> <span class="o">==</span> <span class="n">classRedefinedCount</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">return</span> <span class="n">rd</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="c1">// else no SoftReference or cleared SoftReference or stale ReflectionData</span>
        <span class="c1">// -&gt; create and replace new instance</span>
        <span class="k">return</span> <span class="nf">newReflectionData</span><span class="o">(</span><span class="n">reflectionData</span><span class="o">,</span> <span class="n">classRedefinedCount</span><span class="o">);</span>
    <span class="o">}</span>
    
    <span class="c1">// 新创建缓存，保存反射信息</span>
    <span class="kd">private</span> <span class="nc">ReflectionData</span><span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;</span> <span class="nf">newReflectionData</span><span class="o">(</span><span class="nc">SoftReference</span><span class="o">&lt;</span><span class="nc">ReflectionData</span><span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;&gt;</span> <span class="n">oldReflectionData</span><span class="o">,</span>
                                                <span class="kt">int</span> <span class="n">classRedefinedCount</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(!</span><span class="n">useCaches</span><span class="o">)</span> <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>

        <span class="c1">// 使用cas保证更新的线程安全性，所以反射是保证线程安全的</span>
        <span class="k">while</span> <span class="o">(</span><span class="kc">true</span><span class="o">)</span> <span class="o">{</span>
            <span class="nc">ReflectionData</span><span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;</span> <span class="n">rd</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ReflectionData</span><span class="o">&lt;&gt;(</span><span class="n">classRedefinedCount</span><span class="o">);</span>
            <span class="c1">// try to CAS it...</span>
            <span class="k">if</span> <span class="o">(</span><span class="nc">Atomic</span><span class="o">.</span><span class="na">casReflectionData</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="n">oldReflectionData</span><span class="o">,</span> <span class="k">new</span> <span class="nc">SoftReference</span><span class="o">&lt;&gt;(</span><span class="n">rd</span><span class="o">)))</span> <span class="o">{</span>
                <span class="k">return</span> <span class="n">rd</span><span class="o">;</span>
            <span class="o">}</span>
            <span class="c1">// 先使用CAS更新，如果更新成功，则立即返回，否则测查当前已被其他线程更新的情况，如果和自己想要更新的状态一致，则也算是成功了</span>
            <span class="n">oldReflectionData</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">reflectionData</span><span class="o">;</span>
            <span class="n">classRedefinedCount</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">classRedefinedCount</span><span class="o">;</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">oldReflectionData</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span>
                <span class="o">(</span><span class="n">rd</span> <span class="o">=</span> <span class="n">oldReflectionData</span><span class="o">.</span><span class="na">get</span><span class="o">())</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span>
                <span class="n">rd</span><span class="o">.</span><span class="na">redefinedCount</span> <span class="o">==</span> <span class="n">classRedefinedCount</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">return</span> <span class="n">rd</span><span class="o">;</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>
</pre></table></code></div></div><p>如上，privateGetDeclaredConstructors(), 获取所有的构造器主要步骤；</p><ul><li>先尝试从缓存中获取；<li>如果缓存没有，则从jvm中重新获取，并存入缓存，缓存使用软引用进行保存，保证内存可用；</ul><p>另外，使用 relactionData() 进行缓存保存；ReflectionData 的数据结构如下。</p><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
</pre><td class="rouge-code"><pre><span class="c1">// reflection data that might get invalidated when JVM TI RedefineClasses() is called</span>
<span class="kd">private</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">ReflectionData</span><span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;</span> <span class="o">{</span>
    <span class="kd">volatile</span> <span class="nc">Field</span><span class="o">[]</span> <span class="n">declaredFields</span><span class="o">;</span>
    <span class="kd">volatile</span> <span class="nc">Field</span><span class="o">[]</span> <span class="n">publicFields</span><span class="o">;</span>
    <span class="kd">volatile</span> <span class="nc">Method</span><span class="o">[]</span> <span class="n">declaredMethods</span><span class="o">;</span>
    <span class="kd">volatile</span> <span class="nc">Method</span><span class="o">[]</span> <span class="n">publicMethods</span><span class="o">;</span>
    <span class="kd">volatile</span> <span class="nc">Constructor</span><span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;[]</span> <span class="n">declaredConstructors</span><span class="o">;</span>
    <span class="kd">volatile</span> <span class="nc">Constructor</span><span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;[]</span> <span class="n">publicConstructors</span><span class="o">;</span>
    <span class="c1">// Intermediate results for getFields and getMethods</span>
    <span class="kd">volatile</span> <span class="nc">Field</span><span class="o">[]</span> <span class="n">declaredPublicFields</span><span class="o">;</span>
    <span class="kd">volatile</span> <span class="nc">Method</span><span class="o">[]</span> <span class="n">declaredPublicMethods</span><span class="o">;</span>
    <span class="kd">volatile</span> <span class="nc">Class</span><span class="o">&lt;?&gt;[]</span> <span class="n">interfaces</span><span class="o">;</span>

    <span class="c1">// Value of classRedefinedCount when we created this ReflectionData instance</span>
    <span class="kd">final</span> <span class="kt">int</span> <span class="n">redefinedCount</span><span class="o">;</span>

    <span class="nc">ReflectionData</span><span class="o">(</span><span class="kt">int</span> <span class="n">redefinedCount</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">redefinedCount</span> <span class="o">=</span> <span class="n">redefinedCount</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></table></code></div></div><p>其中，还有一个点，就是如何比较构造是否是要查找构造器，其实就是比较类型完成相等就完了，有一个不相等则返回false。</p><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
</pre><td class="rouge-code"><pre><span class="kd">private</span> <span class="kd">static</span> <span class="kt">boolean</span> <span class="nf">arrayContentsEq</span><span class="o">(</span><span class="nc">Object</span><span class="o">[]</span> <span class="n">a1</span><span class="o">,</span> <span class="nc">Object</span><span class="o">[]</span> <span class="n">a2</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">a1</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">a2</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="n">a2</span><span class="o">.</span><span class="na">length</span> <span class="o">==</span> <span class="mi">0</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="k">if</span> <span class="o">(</span><span class="n">a2</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">a1</span><span class="o">.</span><span class="na">length</span> <span class="o">==</span> <span class="mi">0</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="k">if</span> <span class="o">(</span><span class="n">a1</span><span class="o">.</span><span class="na">length</span> <span class="o">!=</span> <span class="n">a2</span><span class="o">.</span><span class="na">length</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">a1</span><span class="o">.</span><span class="na">length</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">a1</span><span class="o">[</span><span class="n">i</span><span class="o">]</span> <span class="o">!=</span> <span class="n">a2</span><span class="o">[</span><span class="n">i</span><span class="o">])</span> <span class="o">{</span>
            <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
<span class="o">}</span>
<span class="c1">// sun.reflect.ReflectionFactory</span>
<span class="cm">/** Makes a copy of the passed constructor. The returned
    constructor is a "child" of the passed one; see the comments
    in Constructor.java for details. */</span>
<span class="kd">public</span> <span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;</span> <span class="nc">Constructor</span><span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;</span> <span class="nf">copyConstructor</span><span class="o">(</span><span class="nc">Constructor</span><span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;</span> <span class="n">arg</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">return</span> <span class="nf">langReflectAccess</span><span class="o">().</span><span class="na">copyConstructor</span><span class="o">(</span><span class="n">arg</span><span class="o">);</span>
<span class="o">}</span>

<span class="c1">// java.lang.reflect.Constructor, copy 其实就是新new一个 Constructor 出来</span>
<span class="nc">Constructor</span><span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;</span> <span class="nf">copy</span><span class="o">()</span> <span class="o">{</span>
    <span class="c1">// This routine enables sharing of ConstructorAccessor objects</span>
    <span class="c1">// among Constructor objects which refer to the same underlying</span>
    <span class="c1">// method in the VM. (All of this contortion is only necessary</span>
    <span class="c1">// because of the "accessibility" bit in AccessibleObject,</span>
    <span class="c1">// which implicitly requires that new java.lang.reflect</span>
    <span class="c1">// objects be fabricated for each reflective call on Class</span>
    <span class="c1">// objects.)</span>
    <span class="k">if</span> <span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">root</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nf">IllegalArgumentException</span><span class="o">(</span><span class="s">"Can not copy a non-root Constructor"</span><span class="o">);</span>

    <span class="nc">Constructor</span><span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;</span> <span class="n">res</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Constructor</span><span class="o">&lt;&gt;(</span><span class="n">clazz</span><span class="o">,</span>
                                            <span class="n">parameterTypes</span><span class="o">,</span>
                                            <span class="n">exceptionTypes</span><span class="o">,</span> <span class="n">modifiers</span><span class="o">,</span> <span class="n">slot</span><span class="o">,</span>
                                            <span class="n">signature</span><span class="o">,</span>
                                            <span class="n">annotations</span><span class="o">,</span>
                                            <span class="n">parameterAnnotations</span><span class="o">);</span>
    <span class="c1">// root 指向当前 constructor</span>
    <span class="n">res</span><span class="o">.</span><span class="na">root</span> <span class="o">=</span> <span class="k">this</span><span class="o">;</span>
    <span class="c1">// Might as well eagerly propagate this if already present</span>
    <span class="n">res</span><span class="o">.</span><span class="na">constructorAccessor</span> <span class="o">=</span> <span class="n">constructorAccessor</span><span class="o">;</span>
    <span class="k">return</span> <span class="n">res</span><span class="o">;</span>
<span class="o">}</span>
</pre></table></code></div></div><p>通过上面，获取到 Constructor 了。</p><p>接下来就只需调用其相应构造器的 newInstance()，即返回实例了。</p><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
</pre><td class="rouge-code"><pre><span class="c1">// return tmpConstructor.newInstance((Object[])null); </span>
<span class="c1">// java.lang.reflect.Constructor</span>
<span class="nd">@CallerSensitive</span>
<span class="kd">public</span> <span class="no">T</span> <span class="nf">newInstance</span><span class="o">(</span><span class="nc">Object</span> <span class="o">...</span> <span class="n">initargs</span><span class="o">)</span>
    <span class="kd">throws</span> <span class="nc">InstantiationException</span><span class="o">,</span> <span class="nc">IllegalAccessException</span><span class="o">,</span>
            <span class="nc">IllegalArgumentException</span><span class="o">,</span> <span class="nc">InvocationTargetException</span>
<span class="o">{</span>
    <span class="k">if</span> <span class="o">(!</span><span class="n">override</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(!</span><span class="nc">Reflection</span><span class="o">.</span><span class="na">quickCheckMemberAccess</span><span class="o">(</span><span class="n">clazz</span><span class="o">,</span> <span class="n">modifiers</span><span class="o">))</span> <span class="o">{</span>
            <span class="nc">Class</span><span class="o">&lt;?&gt;</span> <span class="n">caller</span> <span class="o">=</span> <span class="nc">Reflection</span><span class="o">.</span><span class="na">getCallerClass</span><span class="o">();</span>
            <span class="n">checkAccess</span><span class="o">(</span><span class="n">caller</span><span class="o">,</span> <span class="n">clazz</span><span class="o">,</span> <span class="kc">null</span><span class="o">,</span> <span class="n">modifiers</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>
    <span class="k">if</span> <span class="o">((</span><span class="n">clazz</span><span class="o">.</span><span class="na">getModifiers</span><span class="o">()</span> <span class="o">&amp;</span> <span class="nc">Modifier</span><span class="o">.</span><span class="na">ENUM</span><span class="o">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="o">)</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nf">IllegalArgumentException</span><span class="o">(</span><span class="s">"Cannot reflectively create enum objects"</span><span class="o">);</span>
    <span class="nc">ConstructorAccessor</span> <span class="n">ca</span> <span class="o">=</span> <span class="n">constructorAccessor</span><span class="o">;</span>   <span class="c1">// read volatile</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">ca</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">ca</span> <span class="o">=</span> <span class="n">acquireConstructorAccessor</span><span class="o">();</span>
    <span class="o">}</span>
    <span class="nd">@SuppressWarnings</span><span class="o">(</span><span class="s">"unchecked"</span><span class="o">)</span>
    <span class="no">T</span> <span class="n">inst</span> <span class="o">=</span> <span class="o">(</span><span class="no">T</span><span class="o">)</span> <span class="n">ca</span><span class="o">.</span><span class="na">newInstance</span><span class="o">(</span><span class="n">initargs</span><span class="o">);</span>
    <span class="k">return</span> <span class="n">inst</span><span class="o">;</span>
<span class="o">}</span>
<span class="c1">// sun.reflect.DelegatingConstructorAccessorImpl</span>
<span class="kd">public</span> <span class="nc">Object</span> <span class="nf">newInstance</span><span class="o">(</span><span class="nc">Object</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span>
  <span class="kd">throws</span> <span class="nc">InstantiationException</span><span class="o">,</span>
          <span class="nc">IllegalArgumentException</span><span class="o">,</span>
          <span class="nc">InvocationTargetException</span>
<span class="o">{</span>
    <span class="k">return</span> <span class="n">delegate</span><span class="o">.</span><span class="na">newInstance</span><span class="o">(</span><span class="n">args</span><span class="o">);</span>
<span class="o">}</span>
<span class="c1">// sun.reflect.NativeConstructorAccessorImpl</span>
<span class="kd">public</span> <span class="nc">Object</span> <span class="nf">newInstance</span><span class="o">(</span><span class="nc">Object</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span>
    <span class="kd">throws</span> <span class="nc">InstantiationException</span><span class="o">,</span>
            <span class="nc">IllegalArgumentException</span><span class="o">,</span>
            <span class="nc">InvocationTargetException</span>
<span class="o">{</span>
    <span class="c1">// We can't inflate a constructor belonging to a vm-anonymous class</span>
    <span class="c1">// because that kind of class can't be referred to by name, hence can't</span>
    <span class="c1">// be found from the generated bytecode.</span>
    <span class="k">if</span> <span class="o">(++</span><span class="n">numInvocations</span> <span class="o">&gt;</span> <span class="nc">ReflectionFactory</span><span class="o">.</span><span class="na">inflationThreshold</span><span class="o">()</span>
            <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nc">ReflectUtil</span><span class="o">.</span><span class="na">isVMAnonymousClass</span><span class="o">(</span><span class="n">c</span><span class="o">.</span><span class="na">getDeclaringClass</span><span class="o">()))</span> <span class="o">{</span>
        <span class="nc">ConstructorAccessorImpl</span> <span class="n">acc</span> <span class="o">=</span> <span class="o">(</span><span class="nc">ConstructorAccessorImpl</span><span class="o">)</span>
            <span class="k">new</span> <span class="nf">MethodAccessorGenerator</span><span class="o">().</span>
                <span class="n">generateConstructor</span><span class="o">(</span><span class="n">c</span><span class="o">.</span><span class="na">getDeclaringClass</span><span class="o">(),</span>
                                    <span class="n">c</span><span class="o">.</span><span class="na">getParameterTypes</span><span class="o">(),</span>
                                    <span class="n">c</span><span class="o">.</span><span class="na">getExceptionTypes</span><span class="o">(),</span>
                                    <span class="n">c</span><span class="o">.</span><span class="na">getModifiers</span><span class="o">());</span>
        <span class="n">parent</span><span class="o">.</span><span class="na">setDelegate</span><span class="o">(</span><span class="n">acc</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="c1">// 调用native方法，进行调用 constructor</span>
    <span class="k">return</span> <span class="nf">newInstance0</span><span class="o">(</span><span class="n">c</span><span class="o">,</span> <span class="n">args</span><span class="o">);</span>
<span class="o">}</span>
</pre></table></code></div></div><p>返回构造器的实例后，可以根据外部进行进行类型转换，从而使用接口或方法进行调用实例功能了</p><h2 id="反射获取方法"><span class="mr-2">反射获取方法</span><a href="#反射获取方法" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><p>第一步，先获取 Method;</p><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
</pre><td class="rouge-code"><pre>  <span class="c1">// java.lang.Class</span>
  <span class="nd">@CallerSensitive</span>
  <span class="kd">public</span> <span class="nc">Method</span> <span class="nf">getDeclaredMethod</span><span class="o">(</span><span class="nc">String</span> <span class="n">name</span><span class="o">,</span> <span class="nc">Class</span><span class="o">&lt;?&gt;...</span> <span class="n">parameterTypes</span><span class="o">)</span>
      <span class="kd">throws</span> <span class="nc">NoSuchMethodException</span><span class="o">,</span> <span class="nc">SecurityException</span> <span class="o">{</span>
      <span class="n">checkMemberAccess</span><span class="o">(</span><span class="nc">Member</span><span class="o">.</span><span class="na">DECLARED</span><span class="o">,</span> <span class="nc">Reflection</span><span class="o">.</span><span class="na">getCallerClass</span><span class="o">(),</span> <span class="kc">true</span><span class="o">);</span>
      <span class="nc">Method</span> <span class="n">method</span> <span class="o">=</span> <span class="n">searchMethods</span><span class="o">(</span><span class="n">privateGetDeclaredMethods</span><span class="o">(</span><span class="kc">false</span><span class="o">),</span> <span class="n">name</span><span class="o">,</span> <span class="n">parameterTypes</span><span class="o">);</span>
      <span class="k">if</span> <span class="o">(</span><span class="n">method</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
          <span class="k">throw</span> <span class="k">new</span> <span class="nf">NoSuchMethodException</span><span class="o">(</span><span class="n">getName</span><span class="o">()</span> <span class="o">+</span> <span class="s">"."</span> <span class="o">+</span> <span class="n">name</span> <span class="o">+</span> <span class="n">argumentTypesToString</span><span class="o">(</span><span class="n">parameterTypes</span><span class="o">));</span>
      <span class="o">}</span>
      <span class="k">return</span> <span class="n">method</span><span class="o">;</span>
  <span class="o">}</span>
</pre></table></code></div></div><p>忽略第一个检查权限，剩下就只有两个动作了。</p><ul><li>获取所有方法列表；<li>根据方法名称和方法列表，选出符合要求的方法；<li>如果没有找到相应方法，抛出异常，否则返回对应方法；</ul><p>所以，先看一下怎样获取类声明的所有方法？</p><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
</pre><td class="rouge-code"><pre>  <span class="c1">// Returns an array of "root" methods. These Method objects must NOT</span>
  <span class="c1">// be propagated to the outside world, but must instead be copied</span>
  <span class="c1">// via ReflectionFactory.copyMethod.</span>
  <span class="kd">private</span> <span class="nc">Method</span><span class="o">[]</span> <span class="nf">privateGetDeclaredMethods</span><span class="o">(</span><span class="kt">boolean</span> <span class="n">publicOnly</span><span class="o">)</span> <span class="o">{</span>
      <span class="n">checkInitted</span><span class="o">();</span>
      <span class="nc">Method</span><span class="o">[]</span> <span class="n">res</span><span class="o">;</span>
      <span class="nc">ReflectionData</span><span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;</span> <span class="n">rd</span> <span class="o">=</span> <span class="n">reflectionData</span><span class="o">();</span>
      <span class="k">if</span> <span class="o">(</span><span class="n">rd</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
          <span class="n">res</span> <span class="o">=</span> <span class="n">publicOnly</span> <span class="o">?</span> <span class="n">rd</span><span class="o">.</span><span class="na">declaredPublicMethods</span> <span class="o">:</span> <span class="n">rd</span><span class="o">.</span><span class="na">declaredMethods</span><span class="o">;</span>
          <span class="k">if</span> <span class="o">(</span><span class="n">res</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="k">return</span> <span class="n">res</span><span class="o">;</span>
      <span class="o">}</span>
      <span class="c1">// No cached value available; request value from VM</span>
      <span class="n">res</span> <span class="o">=</span> <span class="nc">Reflection</span><span class="o">.</span><span class="na">filterMethods</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="n">getDeclaredMethods0</span><span class="o">(</span><span class="n">publicOnly</span><span class="o">));</span>
      <span class="k">if</span> <span class="o">(</span><span class="n">rd</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
          <span class="k">if</span> <span class="o">(</span><span class="n">publicOnly</span><span class="o">)</span> <span class="o">{</span>
              <span class="n">rd</span><span class="o">.</span><span class="na">declaredPublicMethods</span> <span class="o">=</span> <span class="n">res</span><span class="o">;</span>
          <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
              <span class="n">rd</span><span class="o">.</span><span class="na">declaredMethods</span> <span class="o">=</span> <span class="n">res</span><span class="o">;</span>
          <span class="o">}</span>
      <span class="o">}</span>
      <span class="k">return</span> <span class="n">res</span><span class="o">;</span>
  <span class="o">}</span>
</pre></table></code></div></div><p>很相似，和获取所有构造器的方法很相似，都是先从缓存中获取方法，如果没有，则从jvm中获取。</p><p>不同的是，方法列表需要进行过滤 Reflection.filterMethods;当然后面看来，这个方法我们一般不会派上用场</p><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
</pre><td class="rouge-code"><pre>  <span class="c1">// sun.misc.Reflection</span>
  <span class="kd">public</span> <span class="kd">static</span> <span class="nc">Method</span><span class="o">[]</span> <span class="nf">filterMethods</span><span class="o">(</span><span class="nc">Class</span><span class="o">&lt;?&gt;</span> <span class="n">containingClass</span><span class="o">,</span> <span class="nc">Method</span><span class="o">[]</span> <span class="n">methods</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">if</span> <span class="o">(</span><span class="n">methodFilterMap</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
          <span class="c1">// Bootstrapping</span>
          <span class="k">return</span> <span class="n">methods</span><span class="o">;</span>
      <span class="o">}</span>
      <span class="k">return</span> <span class="o">(</span><span class="nc">Method</span><span class="o">[])</span><span class="n">filter</span><span class="o">(</span><span class="n">methods</span><span class="o">,</span> <span class="n">methodFilterMap</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">containingClass</span><span class="o">));</span>
  <span class="o">}</span>
  <span class="c1">// 可以过滤指定的方法，一般为空，如果要指定过滤，可以调用 registerMethodsToFilter(), 或者...</span>
  <span class="kd">private</span> <span class="kd">static</span> <span class="nc">Member</span><span class="o">[]</span> <span class="nf">filter</span><span class="o">(</span><span class="nc">Member</span><span class="o">[]</span> <span class="n">members</span><span class="o">,</span> <span class="nc">String</span><span class="o">[]</span> <span class="n">filteredNames</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">if</span> <span class="o">((</span><span class="n">filteredNames</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">||</span> <span class="o">(</span><span class="n">members</span><span class="o">.</span><span class="na">length</span> <span class="o">==</span> <span class="mi">0</span><span class="o">))</span> <span class="o">{</span>
          <span class="k">return</span> <span class="n">members</span><span class="o">;</span>
      <span class="o">}</span>
      <span class="kt">int</span> <span class="n">numNewMembers</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
      <span class="k">for</span> <span class="o">(</span><span class="nc">Member</span> <span class="n">member</span> <span class="o">:</span> <span class="n">members</span><span class="o">)</span> <span class="o">{</span>
          <span class="kt">boolean</span> <span class="n">shouldSkip</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
          <span class="k">for</span> <span class="o">(</span><span class="nc">String</span> <span class="n">filteredName</span> <span class="o">:</span> <span class="n">filteredNames</span><span class="o">)</span> <span class="o">{</span>
              <span class="k">if</span> <span class="o">(</span><span class="n">member</span><span class="o">.</span><span class="na">getName</span><span class="o">()</span> <span class="o">==</span> <span class="n">filteredName</span><span class="o">)</span> <span class="o">{</span>
                  <span class="n">shouldSkip</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
                  <span class="k">break</span><span class="o">;</span>
              <span class="o">}</span>
          <span class="o">}</span>
          <span class="k">if</span> <span class="o">(!</span><span class="n">shouldSkip</span><span class="o">)</span> <span class="o">{</span>
              <span class="o">++</span><span class="n">numNewMembers</span><span class="o">;</span>
          <span class="o">}</span>
      <span class="o">}</span>
      <span class="nc">Member</span><span class="o">[]</span> <span class="n">newMembers</span> <span class="o">=</span>
          <span class="o">(</span><span class="nc">Member</span><span class="o">[])</span><span class="nc">Array</span><span class="o">.</span><span class="na">newInstance</span><span class="o">(</span><span class="n">members</span><span class="o">[</span><span class="mi">0</span><span class="o">].</span><span class="na">getClass</span><span class="o">(),</span> <span class="n">numNewMembers</span><span class="o">);</span>
      <span class="kt">int</span> <span class="n">destIdx</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
      <span class="k">for</span> <span class="o">(</span><span class="nc">Member</span> <span class="n">member</span> <span class="o">:</span> <span class="n">members</span><span class="o">)</span> <span class="o">{</span>
          <span class="kt">boolean</span> <span class="n">shouldSkip</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
          <span class="k">for</span> <span class="o">(</span><span class="nc">String</span> <span class="n">filteredName</span> <span class="o">:</span> <span class="n">filteredNames</span><span class="o">)</span> <span class="o">{</span>
              <span class="k">if</span> <span class="o">(</span><span class="n">member</span><span class="o">.</span><span class="na">getName</span><span class="o">()</span> <span class="o">==</span> <span class="n">filteredName</span><span class="o">)</span> <span class="o">{</span>
                  <span class="n">shouldSkip</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
                  <span class="k">break</span><span class="o">;</span>
              <span class="o">}</span>
          <span class="o">}</span>
          <span class="k">if</span> <span class="o">(!</span><span class="n">shouldSkip</span><span class="o">)</span> <span class="o">{</span>
              <span class="n">newMembers</span><span class="o">[</span><span class="n">destIdx</span><span class="o">++]</span> <span class="o">=</span> <span class="n">member</span><span class="o">;</span>
          <span class="o">}</span>
      <span class="o">}</span>
      <span class="k">return</span> <span class="n">newMembers</span><span class="o">;</span>
  <span class="o">}</span>
</pre></table></code></div></div><p>第二步，根据方法名和参数类型过滤指定方法返回：</p><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
</pre><td class="rouge-code"><pre>  <span class="kd">private</span> <span class="kd">static</span> <span class="nc">Method</span> <span class="nf">searchMethods</span><span class="o">(</span><span class="nc">Method</span><span class="o">[]</span> <span class="n">methods</span><span class="o">,</span>
                                      <span class="nc">String</span> <span class="n">name</span><span class="o">,</span>
                                      <span class="nc">Class</span><span class="o">&lt;?&gt;[]</span> <span class="n">parameterTypes</span><span class="o">)</span>
  <span class="o">{</span>
      <span class="nc">Method</span> <span class="n">res</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
      <span class="c1">// 使用常量池，避免重复创建String</span>
      <span class="nc">String</span> <span class="n">internedName</span> <span class="o">=</span> <span class="n">name</span><span class="o">.</span><span class="na">intern</span><span class="o">();</span>
      <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">methods</span><span class="o">.</span><span class="na">length</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
          <span class="nc">Method</span> <span class="n">m</span> <span class="o">=</span> <span class="n">methods</span><span class="o">[</span><span class="n">i</span><span class="o">];</span>
          <span class="k">if</span> <span class="o">(</span><span class="n">m</span><span class="o">.</span><span class="na">getName</span><span class="o">()</span> <span class="o">==</span> <span class="n">internedName</span>
              <span class="o">&amp;&amp;</span> <span class="n">arrayContentsEq</span><span class="o">(</span><span class="n">parameterTypes</span><span class="o">,</span> <span class="n">m</span><span class="o">.</span><span class="na">getParameterTypes</span><span class="o">())</span>
              <span class="o">&amp;&amp;</span> <span class="o">(</span><span class="n">res</span> <span class="o">==</span> <span class="kc">null</span>
                  <span class="o">||</span> <span class="n">res</span><span class="o">.</span><span class="na">getReturnType</span><span class="o">().</span><span class="na">isAssignableFrom</span><span class="o">(</span><span class="n">m</span><span class="o">.</span><span class="na">getReturnType</span><span class="o">())))</span>
              <span class="n">res</span> <span class="o">=</span> <span class="n">m</span><span class="o">;</span>
      <span class="o">}</span>

      <span class="k">return</span> <span class="o">(</span><span class="n">res</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">?</span> <span class="n">res</span> <span class="o">:</span> <span class="n">getReflectionFactory</span><span class="o">().</span><span class="na">copyMethod</span><span class="o">(</span><span class="n">res</span><span class="o">));</span>
  <span class="o">}</span>
</pre></table></code></div></div><p>大概意思看得明白，就是匹配到方法名，然后参数类型匹配，才可以。</p><ul><li>但是可以看到，匹配到一个方法，并没有退出for循环，而是继续进行匹配。<li>这里是匹配最精确的子类进行返回（最优匹配）<li>最后，还是通过 ReflectionFactory, copy 方法后返回</ul><h2 id="调用-methodinvoke-方法"><span class="mr-2">调用 method.invoke() 方法</span><a href="#调用-methodinvoke-方法" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
</pre><td class="rouge-code"><pre>  <span class="nd">@CallerSensitive</span>
  <span class="kd">public</span> <span class="nc">Object</span> <span class="nf">invoke</span><span class="o">(</span><span class="nc">Object</span> <span class="n">obj</span><span class="o">,</span> <span class="nc">Object</span><span class="o">...</span> <span class="n">args</span><span class="o">)</span>
      <span class="kd">throws</span> <span class="nc">IllegalAccessException</span><span class="o">,</span> <span class="nc">IllegalArgumentException</span><span class="o">,</span>
          <span class="nc">InvocationTargetException</span>
  <span class="o">{</span>
      <span class="k">if</span> <span class="o">(!</span><span class="n">override</span><span class="o">)</span> <span class="o">{</span>
          <span class="k">if</span> <span class="o">(!</span><span class="nc">Reflection</span><span class="o">.</span><span class="na">quickCheckMemberAccess</span><span class="o">(</span><span class="n">clazz</span><span class="o">,</span> <span class="n">modifiers</span><span class="o">))</span> <span class="o">{</span>
              <span class="nc">Class</span><span class="o">&lt;?&gt;</span> <span class="n">caller</span> <span class="o">=</span> <span class="nc">Reflection</span><span class="o">.</span><span class="na">getCallerClass</span><span class="o">();</span>
              <span class="n">checkAccess</span><span class="o">(</span><span class="n">caller</span><span class="o">,</span> <span class="n">clazz</span><span class="o">,</span> <span class="n">obj</span><span class="o">,</span> <span class="n">modifiers</span><span class="o">);</span>
          <span class="o">}</span>
      <span class="o">}</span>
      <span class="nc">MethodAccessor</span> <span class="n">ma</span> <span class="o">=</span> <span class="n">methodAccessor</span><span class="o">;</span>             <span class="c1">// read volatile</span>
      <span class="k">if</span> <span class="o">(</span><span class="n">ma</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
          <span class="n">ma</span> <span class="o">=</span> <span class="n">acquireMethodAccessor</span><span class="o">();</span>
      <span class="o">}</span>
      <span class="k">return</span> <span class="n">ma</span><span class="o">.</span><span class="na">invoke</span><span class="o">(</span><span class="n">obj</span><span class="o">,</span> <span class="n">args</span><span class="o">);</span>
  <span class="o">}</span>
</pre></table></code></div></div><p>invoke时，是通过 MethodAccessor 进行调用的，而 MethodAccessor 是个接口，在第一次时调用 acquireMethodAccessor() 进行新创建。</p><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
</pre><td class="rouge-code"><pre>  <span class="c1">// probably make the implementation more scalable.</span>
  <span class="kd">private</span> <span class="nc">MethodAccessor</span> <span class="nf">acquireMethodAccessor</span><span class="o">()</span> <span class="o">{</span>
      <span class="c1">// First check to see if one has been created yet, and take it</span>
      <span class="c1">// if so</span>
      <span class="nc">MethodAccessor</span> <span class="n">tmp</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
      <span class="k">if</span> <span class="o">(</span><span class="n">root</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="n">tmp</span> <span class="o">=</span> <span class="n">root</span><span class="o">.</span><span class="na">getMethodAccessor</span><span class="o">();</span>
      <span class="k">if</span> <span class="o">(</span><span class="n">tmp</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
          <span class="c1">// 存在缓存时，存入 methodAccessor，否则调用 ReflectionFactory 创建新的 MethodAccessor</span>
          <span class="n">methodAccessor</span> <span class="o">=</span> <span class="n">tmp</span><span class="o">;</span>
      <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
          <span class="c1">// Otherwise fabricate one and propagate it up to the root</span>
          <span class="n">tmp</span> <span class="o">=</span> <span class="n">reflectionFactory</span><span class="o">.</span><span class="na">newMethodAccessor</span><span class="o">(</span><span class="k">this</span><span class="o">);</span>
          <span class="n">setMethodAccessor</span><span class="o">(</span><span class="n">tmp</span><span class="o">);</span>
      <span class="o">}</span>

      <span class="k">return</span> <span class="n">tmp</span><span class="o">;</span>
  <span class="o">}</span>
  <span class="c1">// sun.reflect.ReflectionFactory</span>
  <span class="kd">public</span> <span class="nc">MethodAccessor</span> <span class="nf">newMethodAccessor</span><span class="o">(</span><span class="nc">Method</span> <span class="n">method</span><span class="o">)</span> <span class="o">{</span>
      <span class="n">checkInitted</span><span class="o">();</span>

      <span class="k">if</span> <span class="o">(</span><span class="n">noInflation</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nc">ReflectUtil</span><span class="o">.</span><span class="na">isVMAnonymousClass</span><span class="o">(</span><span class="n">method</span><span class="o">.</span><span class="na">getDeclaringClass</span><span class="o">()))</span> <span class="o">{</span>
          <span class="k">return</span> <span class="k">new</span> <span class="nf">MethodAccessorGenerator</span><span class="o">().</span>
              <span class="n">generateMethod</span><span class="o">(</span><span class="n">method</span><span class="o">.</span><span class="na">getDeclaringClass</span><span class="o">(),</span>
                              <span class="n">method</span><span class="o">.</span><span class="na">getName</span><span class="o">(),</span>
                              <span class="n">method</span><span class="o">.</span><span class="na">getParameterTypes</span><span class="o">(),</span>
                              <span class="n">method</span><span class="o">.</span><span class="na">getReturnType</span><span class="o">(),</span>
                              <span class="n">method</span><span class="o">.</span><span class="na">getExceptionTypes</span><span class="o">(),</span>
                              <span class="n">method</span><span class="o">.</span><span class="na">getModifiers</span><span class="o">());</span>
      <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
          <span class="nc">NativeMethodAccessorImpl</span> <span class="n">acc</span> <span class="o">=</span>
              <span class="k">new</span> <span class="nf">NativeMethodAccessorImpl</span><span class="o">(</span><span class="n">method</span><span class="o">);</span>
          <span class="nc">DelegatingMethodAccessorImpl</span> <span class="n">res</span> <span class="o">=</span>
              <span class="k">new</span> <span class="nf">DelegatingMethodAccessorImpl</span><span class="o">(</span><span class="n">acc</span><span class="o">);</span>
          <span class="n">acc</span><span class="o">.</span><span class="na">setParent</span><span class="o">(</span><span class="n">res</span><span class="o">);</span>
          <span class="k">return</span> <span class="n">res</span><span class="o">;</span>
      <span class="o">}</span>
  <span class="o">}</span>
</pre></table></code></div></div><p>两个Accessor详情：</p><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
</pre><td class="rouge-code"><pre><span class="c1">//     NativeMethodAccessorImpl / DelegatingMethodAccessorImpl</span>
<span class="kd">class</span> <span class="nc">NativeMethodAccessorImpl</span> <span class="kd">extends</span> <span class="nc">MethodAccessorImpl</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="nc">Method</span> <span class="n">method</span><span class="o">;</span>
    <span class="kd">private</span> <span class="nc">DelegatingMethodAccessorImpl</span> <span class="n">parent</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kt">int</span> <span class="n">numInvocations</span><span class="o">;</span>

    <span class="nc">NativeMethodAccessorImpl</span><span class="o">(</span><span class="nc">Method</span> <span class="n">method</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">method</span> <span class="o">=</span> <span class="n">method</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="nc">Object</span> <span class="nf">invoke</span><span class="o">(</span><span class="nc">Object</span> <span class="n">obj</span><span class="o">,</span> <span class="nc">Object</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span>
        <span class="kd">throws</span> <span class="nc">IllegalArgumentException</span><span class="o">,</span> <span class="nc">InvocationTargetException</span>
    <span class="o">{</span>
        <span class="c1">// We can't inflate methods belonging to vm-anonymous classes because</span>
        <span class="c1">// that kind of class can't be referred to by name, hence can't be</span>
        <span class="c1">// found from the generated bytecode.</span>
        <span class="k">if</span> <span class="o">(++</span><span class="n">numInvocations</span> <span class="o">&gt;</span> <span class="nc">ReflectionFactory</span><span class="o">.</span><span class="na">inflationThreshold</span><span class="o">()</span>
                <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nc">ReflectUtil</span><span class="o">.</span><span class="na">isVMAnonymousClass</span><span class="o">(</span><span class="n">method</span><span class="o">.</span><span class="na">getDeclaringClass</span><span class="o">()))</span> <span class="o">{</span>
            <span class="nc">MethodAccessorImpl</span> <span class="n">acc</span> <span class="o">=</span> <span class="o">(</span><span class="nc">MethodAccessorImpl</span><span class="o">)</span>
                <span class="k">new</span> <span class="nf">MethodAccessorGenerator</span><span class="o">().</span>
                    <span class="n">generateMethod</span><span class="o">(</span><span class="n">method</span><span class="o">.</span><span class="na">getDeclaringClass</span><span class="o">(),</span>
                                   <span class="n">method</span><span class="o">.</span><span class="na">getName</span><span class="o">(),</span>
                                   <span class="n">method</span><span class="o">.</span><span class="na">getParameterTypes</span><span class="o">(),</span>
                                   <span class="n">method</span><span class="o">.</span><span class="na">getReturnType</span><span class="o">(),</span>
                                   <span class="n">method</span><span class="o">.</span><span class="na">getExceptionTypes</span><span class="o">(),</span>
                                   <span class="n">method</span><span class="o">.</span><span class="na">getModifiers</span><span class="o">());</span>
            <span class="n">parent</span><span class="o">.</span><span class="na">setDelegate</span><span class="o">(</span><span class="n">acc</span><span class="o">);</span>
        <span class="o">}</span>

        <span class="k">return</span> <span class="nf">invoke0</span><span class="o">(</span><span class="n">method</span><span class="o">,</span> <span class="n">obj</span><span class="o">,</span> <span class="n">args</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kt">void</span> <span class="nf">setParent</span><span class="o">(</span><span class="nc">DelegatingMethodAccessorImpl</span> <span class="n">parent</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">parent</span> <span class="o">=</span> <span class="n">parent</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">native</span> <span class="nc">Object</span> <span class="nf">invoke0</span><span class="o">(</span><span class="nc">Method</span> <span class="n">m</span><span class="o">,</span> <span class="nc">Object</span> <span class="n">obj</span><span class="o">,</span> <span class="nc">Object</span><span class="o">[]</span> <span class="n">args</span><span class="o">);</span>
<span class="o">}</span>
<span class="kd">class</span> <span class="nc">DelegatingMethodAccessorImpl</span> <span class="kd">extends</span> <span class="nc">MethodAccessorImpl</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="nc">MethodAccessorImpl</span> <span class="n">delegate</span><span class="o">;</span>

    <span class="nc">DelegatingMethodAccessorImpl</span><span class="o">(</span><span class="nc">MethodAccessorImpl</span> <span class="n">delegate</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">setDelegate</span><span class="o">(</span><span class="n">delegate</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="nc">Object</span> <span class="nf">invoke</span><span class="o">(</span><span class="nc">Object</span> <span class="n">obj</span><span class="o">,</span> <span class="nc">Object</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span>
        <span class="kd">throws</span> <span class="nc">IllegalArgumentException</span><span class="o">,</span> <span class="nc">InvocationTargetException</span>
    <span class="o">{</span>
        <span class="k">return</span> <span class="n">delegate</span><span class="o">.</span><span class="na">invoke</span><span class="o">(</span><span class="n">obj</span><span class="o">,</span> <span class="n">args</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kt">void</span> <span class="nf">setDelegate</span><span class="o">(</span><span class="nc">MethodAccessorImpl</span> <span class="n">delegate</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">delegate</span> <span class="o">=</span> <span class="n">delegate</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></table></code></div></div><p>进行 ma.invoke(obj, args); 调用时，调用 DelegatingMethodAccessorImpl.invoke();</p><p>最后被委托到 NativeMethodAccessorImpl.invoke(), 即：</p><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
</pre><td class="rouge-code"><pre>  <span class="kd">public</span> <span class="nc">Object</span> <span class="nf">invoke</span><span class="o">(</span><span class="nc">Object</span> <span class="n">obj</span><span class="o">,</span> <span class="nc">Object</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span>
      <span class="kd">throws</span> <span class="nc">IllegalArgumentException</span><span class="o">,</span> <span class="nc">InvocationTargetException</span>
  <span class="o">{</span>
      <span class="c1">// We can't inflate methods belonging to vm-anonymous classes because</span>
      <span class="c1">// that kind of class can't be referred to by name, hence can't be</span>
      <span class="c1">// found from the generated bytecode.</span>
      <span class="k">if</span> <span class="o">(++</span><span class="n">numInvocations</span> <span class="o">&gt;</span> <span class="nc">ReflectionFactory</span><span class="o">.</span><span class="na">inflationThreshold</span><span class="o">()</span>
              <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nc">ReflectUtil</span><span class="o">.</span><span class="na">isVMAnonymousClass</span><span class="o">(</span><span class="n">method</span><span class="o">.</span><span class="na">getDeclaringClass</span><span class="o">()))</span> <span class="o">{</span>
          <span class="nc">MethodAccessorImpl</span> <span class="n">acc</span> <span class="o">=</span> <span class="o">(</span><span class="nc">MethodAccessorImpl</span><span class="o">)</span>
              <span class="k">new</span> <span class="nf">MethodAccessorGenerator</span><span class="o">().</span>
                  <span class="n">generateMethod</span><span class="o">(</span><span class="n">method</span><span class="o">.</span><span class="na">getDeclaringClass</span><span class="o">(),</span>
                                  <span class="n">method</span><span class="o">.</span><span class="na">getName</span><span class="o">(),</span>
                                  <span class="n">method</span><span class="o">.</span><span class="na">getParameterTypes</span><span class="o">(),</span>
                                  <span class="n">method</span><span class="o">.</span><span class="na">getReturnType</span><span class="o">(),</span>
                                  <span class="n">method</span><span class="o">.</span><span class="na">getExceptionTypes</span><span class="o">(),</span>
                                  <span class="n">method</span><span class="o">.</span><span class="na">getModifiers</span><span class="o">());</span>
          <span class="n">parent</span><span class="o">.</span><span class="na">setDelegate</span><span class="o">(</span><span class="n">acc</span><span class="o">);</span>
      <span class="o">}</span>

      <span class="c1">// invoke0 是个 native 方法，由jvm进行调用业务方法。从而完成反射调用功能。</span>
      <span class="k">return</span> <span class="nf">invoke0</span><span class="o">(</span><span class="n">method</span><span class="o">,</span> <span class="n">obj</span><span class="o">,</span> <span class="n">args</span><span class="o">);</span>
  <span class="o">}</span>
</pre></table></code></div></div><p>其中， generateMethod() 是生成具体类的方法</p><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
</pre><td class="rouge-code"><pre>  <span class="cm">/** This routine is not thread-safe */</span>
  <span class="kd">public</span> <span class="nc">MethodAccessor</span> <span class="nf">generateMethod</span><span class="o">(</span><span class="nc">Class</span><span class="o">&lt;?&gt;</span> <span class="n">declaringClass</span><span class="o">,</span>
                                        <span class="nc">String</span>   <span class="n">name</span><span class="o">,</span>
                                        <span class="nc">Class</span><span class="o">&lt;?&gt;[]</span> <span class="n">parameterTypes</span><span class="o">,</span>
                                        <span class="nc">Class</span><span class="o">&lt;?&gt;</span>   <span class="n">returnType</span><span class="o">,</span>
                                        <span class="nc">Class</span><span class="o">&lt;?&gt;[]</span> <span class="n">checkedExceptions</span><span class="o">,</span>
                                        <span class="kt">int</span> <span class="n">modifiers</span><span class="o">)</span>
  <span class="o">{</span>
      <span class="k">return</span> <span class="o">(</span><span class="nc">MethodAccessor</span><span class="o">)</span> <span class="n">generate</span><span class="o">(</span><span class="n">declaringClass</span><span class="o">,</span>
                                        <span class="n">name</span><span class="o">,</span>
                                        <span class="n">parameterTypes</span><span class="o">,</span>
                                        <span class="n">returnType</span><span class="o">,</span>
                                        <span class="n">checkedExceptions</span><span class="o">,</span>
                                        <span class="n">modifiers</span><span class="o">,</span>
                                        <span class="kc">false</span><span class="o">,</span>
                                        <span class="kc">false</span><span class="o">,</span>
                                        <span class="kc">null</span><span class="o">);</span>
  <span class="o">}</span>
</pre></table></code></div></div><p>generate() 戳详情</p><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192
193
194
195
196
197
198
199
200
201
202
203
204
205
206
207
208
209
210
211
212
213
214
215
216
217
218
219
220
221
222
223
224
225
226
227
228
229
230
231
232
233
234
235
236
237
238
239
240
241
242
243
244
245
246
247
248
249
250
251
252
253
254
255
256
257
258
259
260
261
262
263
264
265
266
267
268
269
270
271
272
273
274
275
276
277
278
279
280
281
282
283
284
285
286
287
</pre><td class="rouge-code"><pre>  <span class="cm">/** This routine is not thread-safe */</span>
  <span class="kd">private</span> <span class="nc">MagicAccessorImpl</span> <span class="nf">generate</span><span class="o">(</span><span class="kd">final</span> <span class="nc">Class</span><span class="o">&lt;?&gt;</span> <span class="n">declaringClass</span><span class="o">,</span>
                                      <span class="nc">String</span> <span class="n">name</span><span class="o">,</span>
                                      <span class="nc">Class</span><span class="o">&lt;?&gt;[]</span> <span class="n">parameterTypes</span><span class="o">,</span>
                                      <span class="nc">Class</span><span class="o">&lt;?&gt;</span>   <span class="n">returnType</span><span class="o">,</span>
                                      <span class="nc">Class</span><span class="o">&lt;?&gt;[]</span> <span class="n">checkedExceptions</span><span class="o">,</span>
                                      <span class="kt">int</span> <span class="n">modifiers</span><span class="o">,</span>
                                      <span class="kt">boolean</span> <span class="n">isConstructor</span><span class="o">,</span>
                                      <span class="kt">boolean</span> <span class="n">forSerialization</span><span class="o">,</span>
                                      <span class="nc">Class</span><span class="o">&lt;?&gt;</span> <span class="n">serializationTargetClass</span><span class="o">)</span>
  <span class="o">{</span>
      <span class="nc">ByteVector</span> <span class="n">vec</span> <span class="o">=</span> <span class="nc">ByteVectorFactory</span><span class="o">.</span><span class="na">create</span><span class="o">();</span>
      <span class="n">asm</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ClassFileAssembler</span><span class="o">(</span><span class="n">vec</span><span class="o">);</span>
      <span class="k">this</span><span class="o">.</span><span class="na">declaringClass</span> <span class="o">=</span> <span class="n">declaringClass</span><span class="o">;</span>
      <span class="k">this</span><span class="o">.</span><span class="na">parameterTypes</span> <span class="o">=</span> <span class="n">parameterTypes</span><span class="o">;</span>
      <span class="k">this</span><span class="o">.</span><span class="na">returnType</span> <span class="o">=</span> <span class="n">returnType</span><span class="o">;</span>
      <span class="k">this</span><span class="o">.</span><span class="na">modifiers</span> <span class="o">=</span> <span class="n">modifiers</span><span class="o">;</span>
      <span class="k">this</span><span class="o">.</span><span class="na">isConstructor</span> <span class="o">=</span> <span class="n">isConstructor</span><span class="o">;</span>
      <span class="k">this</span><span class="o">.</span><span class="na">forSerialization</span> <span class="o">=</span> <span class="n">forSerialization</span><span class="o">;</span>

      <span class="n">asm</span><span class="o">.</span><span class="na">emitMagicAndVersion</span><span class="o">();</span>

      <span class="c1">// Constant pool entries:</span>
      <span class="c1">// ( * = Boxing information: optional)</span>
      <span class="c1">// (+  = Shared entries provided by AccessorGenerator)</span>
      <span class="c1">// (^  = Only present if generating SerializationConstructorAccessor)</span>
      <span class="c1">//     [UTF-8] [This class's name]</span>
      <span class="c1">//     [CONSTANT_Class_info] for above</span>
      <span class="c1">//     [UTF-8] "sun/reflect/{MethodAccessorImpl,ConstructorAccessorImpl,SerializationConstructorAccessorImpl}"</span>
      <span class="c1">//     [CONSTANT_Class_info] for above</span>
      <span class="c1">//     [UTF-8] [Target class's name]</span>
      <span class="c1">//     [CONSTANT_Class_info] for above</span>
      <span class="c1">// ^   [UTF-8] [Serialization: Class's name in which to invoke constructor]</span>
      <span class="c1">// ^   [CONSTANT_Class_info] for above</span>
      <span class="c1">//     [UTF-8] target method or constructor name</span>
      <span class="c1">//     [UTF-8] target method or constructor signature</span>
      <span class="c1">//     [CONSTANT_NameAndType_info] for above</span>
      <span class="c1">//     [CONSTANT_Methodref_info or CONSTANT_InterfaceMethodref_info] for target method</span>
      <span class="c1">//     [UTF-8] "invoke" or "newInstance"</span>
      <span class="c1">//     [UTF-8] invoke or newInstance descriptor</span>
      <span class="c1">//     [UTF-8] descriptor for type of non-primitive parameter 1</span>
      <span class="c1">//     [CONSTANT_Class_info] for type of non-primitive parameter 1</span>
      <span class="c1">//     ...</span>
      <span class="c1">//     [UTF-8] descriptor for type of non-primitive parameter n</span>
      <span class="c1">//     [CONSTANT_Class_info] for type of non-primitive parameter n</span>
      <span class="c1">// +   [UTF-8] "java/lang/Exception"</span>
      <span class="c1">// +   [CONSTANT_Class_info] for above</span>
      <span class="c1">// +   [UTF-8] "java/lang/ClassCastException"</span>
      <span class="c1">// +   [CONSTANT_Class_info] for above</span>
      <span class="c1">// +   [UTF-8] "java/lang/NullPointerException"</span>
      <span class="c1">// +   [CONSTANT_Class_info] for above</span>
      <span class="c1">// +   [UTF-8] "java/lang/IllegalArgumentException"</span>
      <span class="c1">// +   [CONSTANT_Class_info] for above</span>
      <span class="c1">// +   [UTF-8] "java/lang/InvocationTargetException"</span>
      <span class="c1">// +   [CONSTANT_Class_info] for above</span>
      <span class="c1">// +   [UTF-8] "&lt;init&gt;"</span>
      <span class="c1">// +   [UTF-8] "()V"</span>
      <span class="c1">// +   [CONSTANT_NameAndType_info] for above</span>
      <span class="c1">// +   [CONSTANT_Methodref_info] for NullPointerException's constructor</span>
      <span class="c1">// +   [CONSTANT_Methodref_info] for IllegalArgumentException's constructor</span>
      <span class="c1">// +   [UTF-8] "(Ljava/lang/String;)V"</span>
      <span class="c1">// +   [CONSTANT_NameAndType_info] for "&lt;init&gt;(Ljava/lang/String;)V"</span>
      <span class="c1">// +   [CONSTANT_Methodref_info] for IllegalArgumentException's constructor taking a String</span>
      <span class="c1">// +   [UTF-8] "(Ljava/lang/Throwable;)V"</span>
      <span class="c1">// +   [CONSTANT_NameAndType_info] for "&lt;init&gt;(Ljava/lang/Throwable;)V"</span>
      <span class="c1">// +   [CONSTANT_Methodref_info] for InvocationTargetException's constructor</span>
      <span class="c1">// +   [CONSTANT_Methodref_info] for "super()"</span>
      <span class="c1">// +   [UTF-8] "java/lang/Object"</span>
      <span class="c1">// +   [CONSTANT_Class_info] for above</span>
      <span class="c1">// +   [UTF-8] "toString"</span>
      <span class="c1">// +   [UTF-8] "()Ljava/lang/String;"</span>
      <span class="c1">// +   [CONSTANT_NameAndType_info] for "toString()Ljava/lang/String;"</span>
      <span class="c1">// +   [CONSTANT_Methodref_info] for Object's toString method</span>
      <span class="c1">// +   [UTF-8] "Code"</span>
      <span class="c1">// +   [UTF-8] "Exceptions"</span>
      <span class="c1">//  *  [UTF-8] "java/lang/Boolean"</span>
      <span class="c1">//  *  [CONSTANT_Class_info] for above</span>
      <span class="c1">//  *  [UTF-8] "(Z)V"</span>
      <span class="c1">//  *  [CONSTANT_NameAndType_info] for above</span>
      <span class="c1">//  *  [CONSTANT_Methodref_info] for above</span>
      <span class="c1">//  *  [UTF-8] "booleanValue"</span>
      <span class="c1">//  *  [UTF-8] "()Z"</span>
      <span class="c1">//  *  [CONSTANT_NameAndType_info] for above</span>
      <span class="c1">//  *  [CONSTANT_Methodref_info] for above</span>
      <span class="c1">//  *  [UTF-8] "java/lang/Byte"</span>
      <span class="c1">//  *  [CONSTANT_Class_info] for above</span>
      <span class="c1">//  *  [UTF-8] "(B)V"</span>
      <span class="c1">//  *  [CONSTANT_NameAndType_info] for above</span>
      <span class="c1">//  *  [CONSTANT_Methodref_info] for above</span>
      <span class="c1">//  *  [UTF-8] "byteValue"</span>
      <span class="c1">//  *  [UTF-8] "()B"</span>
      <span class="c1">//  *  [CONSTANT_NameAndType_info] for above</span>
      <span class="c1">//  *  [CONSTANT_Methodref_info] for above</span>
      <span class="c1">//  *  [UTF-8] "java/lang/Character"</span>
      <span class="c1">//  *  [CONSTANT_Class_info] for above</span>
      <span class="c1">//  *  [UTF-8] "(C)V"</span>
      <span class="c1">//  *  [CONSTANT_NameAndType_info] for above</span>
      <span class="c1">//  *  [CONSTANT_Methodref_info] for above</span>
      <span class="c1">//  *  [UTF-8] "charValue"</span>
      <span class="c1">//  *  [UTF-8] "()C"</span>
      <span class="c1">//  *  [CONSTANT_NameAndType_info] for above</span>
      <span class="c1">//  *  [CONSTANT_Methodref_info] for above</span>
      <span class="c1">//  *  [UTF-8] "java/lang/Double"</span>
      <span class="c1">//  *  [CONSTANT_Class_info] for above</span>
      <span class="c1">//  *  [UTF-8] "(D)V"</span>
      <span class="c1">//  *  [CONSTANT_NameAndType_info] for above</span>
      <span class="c1">//  *  [CONSTANT_Methodref_info] for above</span>
      <span class="c1">//  *  [UTF-8] "doubleValue"</span>
      <span class="c1">//  *  [UTF-8] "()D"</span>
      <span class="c1">//  *  [CONSTANT_NameAndType_info] for above</span>
      <span class="c1">//  *  [CONSTANT_Methodref_info] for above</span>
      <span class="c1">//  *  [UTF-8] "java/lang/Float"</span>
      <span class="c1">//  *  [CONSTANT_Class_info] for above</span>
      <span class="c1">//  *  [UTF-8] "(F)V"</span>
      <span class="c1">//  *  [CONSTANT_NameAndType_info] for above</span>
      <span class="c1">//  *  [CONSTANT_Methodref_info] for above</span>
      <span class="c1">//  *  [UTF-8] "floatValue"</span>
      <span class="c1">//  *  [UTF-8] "()F"</span>
      <span class="c1">//  *  [CONSTANT_NameAndType_info] for above</span>
      <span class="c1">//  *  [CONSTANT_Methodref_info] for above</span>
      <span class="c1">//  *  [UTF-8] "java/lang/Integer"</span>
      <span class="c1">//  *  [CONSTANT_Class_info] for above</span>
      <span class="c1">//  *  [UTF-8] "(I)V"</span>
      <span class="c1">//  *  [CONSTANT_NameAndType_info] for above</span>
      <span class="c1">//  *  [CONSTANT_Methodref_info] for above</span>
      <span class="c1">//  *  [UTF-8] "intValue"</span>
      <span class="c1">//  *  [UTF-8] "()I"</span>
      <span class="c1">//  *  [CONSTANT_NameAndType_info] for above</span>
      <span class="c1">//  *  [CONSTANT_Methodref_info] for above</span>
      <span class="c1">//  *  [UTF-8] "java/lang/Long"</span>
      <span class="c1">//  *  [CONSTANT_Class_info] for above</span>
      <span class="c1">//  *  [UTF-8] "(J)V"</span>
      <span class="c1">//  *  [CONSTANT_NameAndType_info] for above</span>
      <span class="c1">//  *  [CONSTANT_Methodref_info] for above</span>
      <span class="c1">//  *  [UTF-8] "longValue"</span>
      <span class="c1">//  *  [UTF-8] "()J"</span>
      <span class="c1">//  *  [CONSTANT_NameAndType_info] for above</span>
      <span class="c1">//  *  [CONSTANT_Methodref_info] for above</span>
      <span class="c1">//  *  [UTF-8] "java/lang/Short"</span>
      <span class="c1">//  *  [CONSTANT_Class_info] for above</span>
      <span class="c1">//  *  [UTF-8] "(S)V"</span>
      <span class="c1">//  *  [CONSTANT_NameAndType_info] for above</span>
      <span class="c1">//  *  [CONSTANT_Methodref_info] for above</span>
      <span class="c1">//  *  [UTF-8] "shortValue"</span>
      <span class="c1">//  *  [UTF-8] "()S"</span>
      <span class="c1">//  *  [CONSTANT_NameAndType_info] for above</span>
      <span class="c1">//  *  [CONSTANT_Methodref_info] for above</span>

      <span class="kt">short</span> <span class="n">numCPEntries</span> <span class="o">=</span> <span class="no">NUM_BASE_CPOOL_ENTRIES</span> <span class="o">+</span> <span class="no">NUM_COMMON_CPOOL_ENTRIES</span><span class="o">;</span>
      <span class="kt">boolean</span> <span class="n">usesPrimitives</span> <span class="o">=</span> <span class="n">usesPrimitiveTypes</span><span class="o">();</span>
      <span class="k">if</span> <span class="o">(</span><span class="n">usesPrimitives</span><span class="o">)</span> <span class="o">{</span>
          <span class="n">numCPEntries</span> <span class="o">+=</span> <span class="no">NUM_BOXING_CPOOL_ENTRIES</span><span class="o">;</span>
      <span class="o">}</span>
      <span class="k">if</span> <span class="o">(</span><span class="n">forSerialization</span><span class="o">)</span> <span class="o">{</span>
          <span class="n">numCPEntries</span> <span class="o">+=</span> <span class="no">NUM_SERIALIZATION_CPOOL_ENTRIES</span><span class="o">;</span>
      <span class="o">}</span>

      <span class="c1">// Add in variable-length number of entries to be able to describe</span>
      <span class="c1">// non-primitive parameter types and checked exceptions.</span>
      <span class="n">numCPEntries</span> <span class="o">+=</span> <span class="o">(</span><span class="kt">short</span><span class="o">)</span> <span class="o">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">numNonPrimitiveParameterTypes</span><span class="o">());</span>

      <span class="n">asm</span><span class="o">.</span><span class="na">emitShort</span><span class="o">(</span><span class="n">add</span><span class="o">(</span><span class="n">numCPEntries</span><span class="o">,</span> <span class="no">S1</span><span class="o">));</span>

      <span class="kd">final</span> <span class="nc">String</span> <span class="n">generatedName</span> <span class="o">=</span> <span class="n">generateName</span><span class="o">(</span><span class="n">isConstructor</span><span class="o">,</span> <span class="n">forSerialization</span><span class="o">);</span>
      <span class="n">asm</span><span class="o">.</span><span class="na">emitConstantPoolUTF8</span><span class="o">(</span><span class="n">generatedName</span><span class="o">);</span>
      <span class="n">asm</span><span class="o">.</span><span class="na">emitConstantPoolClass</span><span class="o">(</span><span class="n">asm</span><span class="o">.</span><span class="na">cpi</span><span class="o">());</span>
      <span class="n">thisClass</span> <span class="o">=</span> <span class="n">asm</span><span class="o">.</span><span class="na">cpi</span><span class="o">();</span>
      <span class="k">if</span> <span class="o">(</span><span class="n">isConstructor</span><span class="o">)</span> <span class="o">{</span>
          <span class="k">if</span> <span class="o">(</span><span class="n">forSerialization</span><span class="o">)</span> <span class="o">{</span>
              <span class="n">asm</span><span class="o">.</span><span class="na">emitConstantPoolUTF8</span>
                  <span class="o">(</span><span class="s">"sun/reflect/SerializationConstructorAccessorImpl"</span><span class="o">);</span>
          <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
              <span class="n">asm</span><span class="o">.</span><span class="na">emitConstantPoolUTF8</span><span class="o">(</span><span class="s">"sun/reflect/ConstructorAccessorImpl"</span><span class="o">);</span>
          <span class="o">}</span>
      <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
          <span class="n">asm</span><span class="o">.</span><span class="na">emitConstantPoolUTF8</span><span class="o">(</span><span class="s">"sun/reflect/MethodAccessorImpl"</span><span class="o">);</span>
      <span class="o">}</span>
      <span class="n">asm</span><span class="o">.</span><span class="na">emitConstantPoolClass</span><span class="o">(</span><span class="n">asm</span><span class="o">.</span><span class="na">cpi</span><span class="o">());</span>
      <span class="n">superClass</span> <span class="o">=</span> <span class="n">asm</span><span class="o">.</span><span class="na">cpi</span><span class="o">();</span>
      <span class="n">asm</span><span class="o">.</span><span class="na">emitConstantPoolUTF8</span><span class="o">(</span><span class="n">getClassName</span><span class="o">(</span><span class="n">declaringClass</span><span class="o">,</span> <span class="kc">false</span><span class="o">));</span>
      <span class="n">asm</span><span class="o">.</span><span class="na">emitConstantPoolClass</span><span class="o">(</span><span class="n">asm</span><span class="o">.</span><span class="na">cpi</span><span class="o">());</span>
      <span class="n">targetClass</span> <span class="o">=</span> <span class="n">asm</span><span class="o">.</span><span class="na">cpi</span><span class="o">();</span>
      <span class="kt">short</span> <span class="n">serializationTargetClassIdx</span> <span class="o">=</span> <span class="o">(</span><span class="kt">short</span><span class="o">)</span> <span class="mi">0</span><span class="o">;</span>
      <span class="k">if</span> <span class="o">(</span><span class="n">forSerialization</span><span class="o">)</span> <span class="o">{</span>
          <span class="n">asm</span><span class="o">.</span><span class="na">emitConstantPoolUTF8</span><span class="o">(</span><span class="n">getClassName</span><span class="o">(</span><span class="n">serializationTargetClass</span><span class="o">,</span> <span class="kc">false</span><span class="o">));</span>
          <span class="n">asm</span><span class="o">.</span><span class="na">emitConstantPoolClass</span><span class="o">(</span><span class="n">asm</span><span class="o">.</span><span class="na">cpi</span><span class="o">());</span>
          <span class="n">serializationTargetClassIdx</span> <span class="o">=</span> <span class="n">asm</span><span class="o">.</span><span class="na">cpi</span><span class="o">();</span>
      <span class="o">}</span>
      <span class="n">asm</span><span class="o">.</span><span class="na">emitConstantPoolUTF8</span><span class="o">(</span><span class="n">name</span><span class="o">);</span>
      <span class="n">asm</span><span class="o">.</span><span class="na">emitConstantPoolUTF8</span><span class="o">(</span><span class="n">buildInternalSignature</span><span class="o">());</span>
      <span class="n">asm</span><span class="o">.</span><span class="na">emitConstantPoolNameAndType</span><span class="o">(</span><span class="n">sub</span><span class="o">(</span><span class="n">asm</span><span class="o">.</span><span class="na">cpi</span><span class="o">(),</span> <span class="no">S1</span><span class="o">),</span> <span class="n">asm</span><span class="o">.</span><span class="na">cpi</span><span class="o">());</span>
      <span class="k">if</span> <span class="o">(</span><span class="n">isInterface</span><span class="o">())</span> <span class="o">{</span>
          <span class="n">asm</span><span class="o">.</span><span class="na">emitConstantPoolInterfaceMethodref</span><span class="o">(</span><span class="n">targetClass</span><span class="o">,</span> <span class="n">asm</span><span class="o">.</span><span class="na">cpi</span><span class="o">());</span>
      <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
          <span class="k">if</span> <span class="o">(</span><span class="n">forSerialization</span><span class="o">)</span> <span class="o">{</span>
              <span class="n">asm</span><span class="o">.</span><span class="na">emitConstantPoolMethodref</span><span class="o">(</span><span class="n">serializationTargetClassIdx</span><span class="o">,</span> <span class="n">asm</span><span class="o">.</span><span class="na">cpi</span><span class="o">());</span>
          <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
              <span class="n">asm</span><span class="o">.</span><span class="na">emitConstantPoolMethodref</span><span class="o">(</span><span class="n">targetClass</span><span class="o">,</span> <span class="n">asm</span><span class="o">.</span><span class="na">cpi</span><span class="o">());</span>
          <span class="o">}</span>
      <span class="o">}</span>
      <span class="n">targetMethodRef</span> <span class="o">=</span> <span class="n">asm</span><span class="o">.</span><span class="na">cpi</span><span class="o">();</span>
      <span class="k">if</span> <span class="o">(</span><span class="n">isConstructor</span><span class="o">)</span> <span class="o">{</span>
          <span class="n">asm</span><span class="o">.</span><span class="na">emitConstantPoolUTF8</span><span class="o">(</span><span class="s">"newInstance"</span><span class="o">);</span>
      <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
          <span class="n">asm</span><span class="o">.</span><span class="na">emitConstantPoolUTF8</span><span class="o">(</span><span class="s">"invoke"</span><span class="o">);</span>
      <span class="o">}</span>
      <span class="n">invokeIdx</span> <span class="o">=</span> <span class="n">asm</span><span class="o">.</span><span class="na">cpi</span><span class="o">();</span>
      <span class="k">if</span> <span class="o">(</span><span class="n">isConstructor</span><span class="o">)</span> <span class="o">{</span>
          <span class="n">asm</span><span class="o">.</span><span class="na">emitConstantPoolUTF8</span><span class="o">(</span><span class="s">"([Ljava/lang/Object;)Ljava/lang/Object;"</span><span class="o">);</span>
      <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
          <span class="n">asm</span><span class="o">.</span><span class="na">emitConstantPoolUTF8</span>
              <span class="o">(</span><span class="s">"(Ljava/lang/Object;[Ljava/lang/Object;)Ljava/lang/Object;"</span><span class="o">);</span>
      <span class="o">}</span>
      <span class="n">invokeDescriptorIdx</span> <span class="o">=</span> <span class="n">asm</span><span class="o">.</span><span class="na">cpi</span><span class="o">();</span>

      <span class="c1">// Output class information for non-primitive parameter types</span>
      <span class="n">nonPrimitiveParametersBaseIdx</span> <span class="o">=</span> <span class="n">add</span><span class="o">(</span><span class="n">asm</span><span class="o">.</span><span class="na">cpi</span><span class="o">(),</span> <span class="no">S2</span><span class="o">);</span>
      <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">parameterTypes</span><span class="o">.</span><span class="na">length</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
          <span class="nc">Class</span><span class="o">&lt;?&gt;</span> <span class="n">c</span> <span class="o">=</span> <span class="n">parameterTypes</span><span class="o">[</span><span class="n">i</span><span class="o">];</span>
          <span class="k">if</span> <span class="o">(!</span><span class="n">isPrimitive</span><span class="o">(</span><span class="n">c</span><span class="o">))</span> <span class="o">{</span>
              <span class="n">asm</span><span class="o">.</span><span class="na">emitConstantPoolUTF8</span><span class="o">(</span><span class="n">getClassName</span><span class="o">(</span><span class="n">c</span><span class="o">,</span> <span class="kc">false</span><span class="o">));</span>
              <span class="n">asm</span><span class="o">.</span><span class="na">emitConstantPoolClass</span><span class="o">(</span><span class="n">asm</span><span class="o">.</span><span class="na">cpi</span><span class="o">());</span>
          <span class="o">}</span>
      <span class="o">}</span>

      <span class="c1">// Entries common to FieldAccessor, MethodAccessor and ConstructorAccessor</span>
      <span class="n">emitCommonConstantPoolEntries</span><span class="o">();</span>

      <span class="c1">// Boxing entries</span>
      <span class="k">if</span> <span class="o">(</span><span class="n">usesPrimitives</span><span class="o">)</span> <span class="o">{</span>
          <span class="n">emitBoxingContantPoolEntries</span><span class="o">();</span>
      <span class="o">}</span>

      <span class="k">if</span> <span class="o">(</span><span class="n">asm</span><span class="o">.</span><span class="na">cpi</span><span class="o">()</span> <span class="o">!=</span> <span class="n">numCPEntries</span><span class="o">)</span> <span class="o">{</span>
          <span class="k">throw</span> <span class="k">new</span> <span class="nf">InternalError</span><span class="o">(</span><span class="s">"Adjust this code (cpi = "</span> <span class="o">+</span> <span class="n">asm</span><span class="o">.</span><span class="na">cpi</span><span class="o">()</span> <span class="o">+</span>
                                  <span class="s">", numCPEntries = "</span> <span class="o">+</span> <span class="n">numCPEntries</span> <span class="o">+</span> <span class="s">")"</span><span class="o">);</span>
      <span class="o">}</span>

      <span class="c1">// Access flags</span>
      <span class="n">asm</span><span class="o">.</span><span class="na">emitShort</span><span class="o">(</span><span class="no">ACC_PUBLIC</span><span class="o">);</span>

      <span class="c1">// This class</span>
      <span class="n">asm</span><span class="o">.</span><span class="na">emitShort</span><span class="o">(</span><span class="n">thisClass</span><span class="o">);</span>

      <span class="c1">// Superclass</span>
      <span class="n">asm</span><span class="o">.</span><span class="na">emitShort</span><span class="o">(</span><span class="n">superClass</span><span class="o">);</span>

      <span class="c1">// Interfaces count and interfaces</span>
      <span class="n">asm</span><span class="o">.</span><span class="na">emitShort</span><span class="o">(</span><span class="no">S0</span><span class="o">);</span>

      <span class="c1">// Fields count and fields</span>
      <span class="n">asm</span><span class="o">.</span><span class="na">emitShort</span><span class="o">(</span><span class="no">S0</span><span class="o">);</span>

      <span class="c1">// Methods count and methods</span>
      <span class="n">asm</span><span class="o">.</span><span class="na">emitShort</span><span class="o">(</span><span class="no">NUM_METHODS</span><span class="o">);</span>

      <span class="n">emitConstructor</span><span class="o">();</span>
      <span class="n">emitInvoke</span><span class="o">();</span>

      <span class="c1">// Additional attributes (none)</span>
      <span class="n">asm</span><span class="o">.</span><span class="na">emitShort</span><span class="o">(</span><span class="no">S0</span><span class="o">);</span>

      <span class="c1">// Load class</span>
      <span class="n">vec</span><span class="o">.</span><span class="na">trim</span><span class="o">();</span>
      <span class="kd">final</span> <span class="kt">byte</span><span class="o">[]</span> <span class="n">bytes</span> <span class="o">=</span> <span class="n">vec</span><span class="o">.</span><span class="na">getData</span><span class="o">();</span>
      <span class="c1">// Note: the class loader is the only thing that really matters</span>
      <span class="c1">// here -- it's important to get the generated code into the</span>
      <span class="c1">// same namespace as the target class. Since the generated code</span>
      <span class="c1">// is privileged anyway, the protection domain probably doesn't</span>
      <span class="c1">// matter.</span>
      <span class="k">return</span> <span class="nc">AccessController</span><span class="o">.</span><span class="na">doPrivileged</span><span class="o">(</span>
          <span class="k">new</span> <span class="nc">PrivilegedAction</span><span class="o">&lt;</span><span class="nc">MagicAccessorImpl</span><span class="o">&gt;()</span> <span class="o">{</span>
              <span class="kd">public</span> <span class="nc">MagicAccessorImpl</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
                      <span class="k">try</span> <span class="o">{</span>
                      <span class="k">return</span> <span class="o">(</span><span class="nc">MagicAccessorImpl</span><span class="o">)</span>
                      <span class="nc">ClassDefiner</span><span class="o">.</span><span class="na">defineClass</span>
                              <span class="o">(</span><span class="n">generatedName</span><span class="o">,</span>
                                <span class="n">bytes</span><span class="o">,</span>
                                <span class="mi">0</span><span class="o">,</span>
                                <span class="n">bytes</span><span class="o">.</span><span class="na">length</span><span class="o">,</span>
                                <span class="n">declaringClass</span><span class="o">.</span><span class="na">getClassLoader</span><span class="o">()).</span><span class="na">newInstance</span><span class="o">();</span>
                      <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">InstantiationException</span> <span class="o">|</span> <span class="nc">IllegalAccessException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                          <span class="k">throw</span> <span class="k">new</span> <span class="nf">InternalError</span><span class="o">(</span><span class="n">e</span><span class="o">);</span>
                      <span class="o">}</span>
                  <span class="o">}</span>
              <span class="o">});</span>
  <span class="o">}</span>
</pre></table></code></div></div><p>主要看这一句：ClassDefiner.defineClass(xx, declaringClass.getClassLoader()).newInstance();</p><p>在ClassDefiner.defineClass方法实现中，每被调用一次都会生成一个DelegatingClassLoader类加载器对象 ，这里每次都生成新的类加载器，是为了性能考虑，在某些情况下可以卸载这些生成的类，因为类的卸载是只有在类加载器可以被回收的情况下才会被回收的，如果用了原来的类加载器，那可能导致这些新创建的类一直无法被卸载。</p><p>而反射生成的类，有时候可能用了就可以卸载了，所以使用其独立的类加载器，从而使得更容易控制反射类的生命周期</p><h2 id="反射调用流程小结"><span class="mr-2">反射调用流程小结</span><a href="#反射调用流程小结" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><p>最后，用几句话总结反射的实现原理：</p><ol><li>反射类及反射方法的获取，都是通过从列表中搜寻查找匹配的方法，所以查找性能会随类的大小方法多少而变化；<li>每个类都会有一个与之对应的Class实例，从而每个类都可以获取method反射方法，并作用到其他实例身上；<li>反射也是考虑了线程安全的，放心使用；<li>反射使用软引用relectionData缓存class信息，避免每次重新从jvm获取带来的开销；<li>反射调用多次生成新代理Accessor, 而通过字节码生存的则考虑了卸载功能，所以会使用独立的类加载器；<li>当找到需要的方法，都会copy一份出来，而不是使用原来的实例，从而保证数据隔离；<li>调度反射方法，最终是由jvm执行invoke0()执行</ol></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/software-development/'>Software Development</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/java/" class="post-tag no-text-decoration" >Java</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> 本文由作者按照 <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> 进行授权</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">分享</span> <span class="share-icons"> <a href="https://t.me/share/url?url=https://optimus-xs.github.io/posts/java-reflection-usage/&amp;text=Java 反射使用方法 - Optimus-Xs&#39; Blog" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <a href="https://www.linkedin.com/sharing/share-offsite/?url=https://optimus-xs.github.io/posts/java-reflection-usage/" data-toggle="tooltip" data-placement="top" title="Linkedin" target="_blank" rel="noopener" aria-label="Linkedin"> <i class="fa-fw fab fa-linkedin"></i> </a> <i id="copy-link" class="fa-fw fas fa-link small" data-toggle="tooltip" data-placement="top" title="分享链接" data-title-succeed="链接已复制！"> </i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted"><div class="access"><div id="access-lastmod" class="post"><div class="panel-heading">最近更新</div><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/how-to-write-a-dockerfile-elegantly/">如何优雅的编写Dockerfile</a><li><a href="/posts/java-file-io-usage/">Java 文件 IO 使用方法</a><li><a href="/posts/jvm-gc-mechanism/">JVM 的垃圾回收机制</a><li><a href="/posts/docker-engine-installation-on-ubuntu/">在 Ubuntu 上安装 Dockers Engine 流程</a></ul></div><div id="access-tags"><div class="panel-heading">热门标签</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/java/">Java</a> <a class="post-tag" href="/tags/spring/">Spring</a> <a class="post-tag" href="/tags/devdairy/">DevDairy</a> <a class="post-tag" href="/tags/data-structure/">Data Structure</a> <a class="post-tag" href="/tags/%E5%AE%89%E8%A3%85%E6%B5%81%E7%A8%8B/">安装流程</a> <a class="post-tag" href="/tags/geekdairy/">GeekDairy</a> <a class="post-tag" href="/tags/linux/">Linux</a> <a class="post-tag" href="/tags/network/">Network</a> <a class="post-tag" href="/tags/redis/">Redis</a> <a class="post-tag" href="/tags/docker/">Docker</a></div></div></div><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5"><div class="panel-heading pl-3 pt-2 mb-2">文章内容</div><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="tail-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>相关文章</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/java-collection-overview/"><div class="card-body"> <em class="timeago small" data-ts="1601710080" > 2020-10-03 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Java 集合类概览</h3><div class="text-muted small"><p> Java集合框架 集合是java中存放对象的容器，存放于java.util包中。下图是java集合类的继承与实现关系： 框架图说明 所有集合类都位于java.util包下。Java的集合类主要由两个接口派生而出：Collection和Map，Collection和Map是Java集合框架的根接口，这两个接口又包含了一些子接口或实现类。 集合接口：6个接口（短虚线表示），表示...</p></div></div></a></div><div class="card"> <a href="/posts/why-autowired-not-recommended/"><div class="card-body"> <em class="timeago small" data-ts="1602220140" > 2020-10-09 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>为什么使用 @Autowired 提示不推荐</h3><div class="text-muted small"><p> @Autowired注解相信每个Spring开发者都不陌生了！ 但是当我们使用IDEA写代码的时候，经常会发现@Autowired注解下面是有小黄线的，我们把小鼠标悬停在上面，可以看到这个如下图所示的警告信息： 那么为什么IDEA会给出Field injection is not recommended这样的警告呢？ 下面带着这样的问题，一起来全面的了解下Spring中的三种注入方...</p></div></div></a></div><div class="card"> <a href="/posts/java-generics-usage/"><div class="card-body"> <em class="timeago small" data-ts="1602660480" > 2020-10-14 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Java 泛型使用方法</h3><div class="text-muted small"><p> 概述 泛型在java中有很重要的地位，在面向对象编程及各种设计模式中有非常广泛的应用。 什么是泛型？为什么要使用泛型？ 泛型，即“参数化类型”。一提到参数，最熟悉的就是定义方法时有形参，然后调用此方法时传递实参。那么参数化类型怎么理解呢？顾名思义，就是将类型由原来的具体的类型参数化，类似于方法中的变量参数，此时类型也定义成参数形式（可以称之为类型形参），然后在使用/调用时传入具体的类型（...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/java-generics-usage/" class="btn btn-outline-primary" prompt="上一篇"><p>Java 泛型使用方法</p></a> <a href="/posts/java-annotation-usage/" class="btn btn-outline-primary" prompt="下一篇"><p>Java 注解使用</p></a></div></div></div></div><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center text-muted"><div class="footer-left"><p class="mb-0"> © 2023 <a href="https://github.com/Optimus-Xs">Optimus-Xs</a>. <span data-toggle="tooltip" data-placement="top" title="除非另有说明，本网站上的博客文章均由作者按照知识共享署名 4.0 国际 (CC BY 4.0) 许可协议进行授权。">保留部分权利。</span></p></div><div class="footer-right"><p class="mb-0"> 本站由 <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> 生成，采用 <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> 主题。</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><div id="access-tags"><div class="panel-heading">热门标签</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/java/">Java</a> <a class="post-tag" href="/tags/spring/">Spring</a> <a class="post-tag" href="/tags/devdairy/">DevDairy</a> <a class="post-tag" href="/tags/data-structure/">Data Structure</a> <a class="post-tag" href="/tags/%E5%AE%89%E8%A3%85%E6%B5%81%E7%A8%8B/">安装流程</a> <a class="post-tag" href="/tags/geekdairy/">GeekDairy</a> <a class="post-tag" href="/tags/linux/">Linux</a> <a class="post-tag" href="/tags/network/">Network</a> <a class="post-tag" href="/tags/redis/">Redis</a> <a class="post-tag" href="/tags/docker/">Docker</a></div></div></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">搜索结果为空</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script> <script src="https://cdn.jsdelivr.net/combine/npm/magnific-popup@1/dist/jquery.magnific-popup.min.js,npm/lozad/dist/lozad.min.js,npm/clipboard@2/dist/clipboard.min.js"></script> <script src="https://cdn.jsdelivr.net/combine/npm/dayjs@1/dayjs.min.js,npm/dayjs@1/locale/zh-cn.min.js,npm/dayjs@1/plugin/relativeTime.min.js,npm/dayjs@1/plugin/localizedFormat.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/js/bootstrap.bundle.min.js"></script> <script defer src="/app.js"></script>
